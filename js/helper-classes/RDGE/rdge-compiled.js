/* <copyright>
This file contains proprietary software owned by Motorola Mobility, Inc.<br/>
No rights, expressed or implied, whatsoever to this software are provided by Motorola Mobility, Inc. hereunder.<br/>
(c) Copyright 2011 Motorola Mobility, Inc.  All Rights Reserved.
</copyright> */
vec2 = { string: function (a) { return "{ " + a[0] + ", " + a[1] + " }" }, verify: function (a) { return a == void 0 || a.length == void 0 || a.length < 2 ? !1 : typeof a[0] != "number" || typeof a[1] != "number" ? !1 : !0 }, copy: function (a) { return a.length == void 0 ? [a, a] : [a[0], a[1]] }, inplace_copy: function (a, b) { a[0] = b[0]; a[1] = b[1] }, zero: function () { return [0, 0] }, up: function () { return [0, 1] }, right: function () { return [1, 0] }, add: function (a, b) { return [a[0] + b[0], a[1] + b[1]] }, sub: function (a, b) { return [a[0] - b[0], a[1] - b[1]] }, mul: function (a, b) {
    return [a[0] * b[0],
a[1]*b[1]]},addMul:function(a,b,f){return f.length!=void 0&&f.length>=2?[a[0]+b[0]*f[0],a[1]+b[1]*f[1]]:[a[0]+b[0]*f,a[1]+b[1]*f]},scale:function(a,b){return b.length!=void 0&&b.length>=2?[a[0]*b[0],a[1]*b[1]]:[a[0]*b,a[1]*b]},negate:function(a){return[-a[0],-a[1]]},normalize:function(a){var b=Math.sqrt(a[0]*a[0],a[1]*a[1]);return Math.abs(1-b)>1.0E-4?(b=1/b,[a[0]*b,a[1]*b]):a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},perp:function(a){return[a[1],-a[0]]},lengthSq:function(a){return a[0]*a[0]+
a[1]*a[1]},length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])},min:function(a,b){return[Math.min(a[0],b[0]),Math.min(a[1],b[1])]},max:function(a,b){return[Math.max(a[0],b[0]),Math.max(a[1],b[1])]}};vec2.clamp=function(a,b,f){return vec2.min(f,vec2.max(a,b))};vec3={string:function(a){return"{ "+a[0]+", "+a[1]+", "+a[2]+" }"},verify:function(a){return a==void 0||a.length==void 0||a.length<3?!1:typeof a[0]!="number"||typeof a[1]!="number"||typeof a[2]!="number"?!1:!0},inplace_copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2]},copy:function(a){return a.length==void 0?[a,a,a]:[a[0],a[1],a[2]]},translation:function(a){return[a[12],a[13],a[14]]},basisX:function(a){return[a[0],a[1],a[2]]},basisY:function(a){return[a[4],a[5],a[6]]},basisZ:function(a){return[a[8],
a[9],a[10]]},zero:function(){return[0,0,0]},up:function(){return[0,1,0]},forward:function(){return[0,0,1]},right:function(){return[1,0,0]},random:function(a,b){return[a[0]+(b[0]-a[0])*Math.random(),a[1]+(b[1]-a[1])*Math.random(),a[2]+(b[2]-a[2])*Math.random()]},xy:function(a){return[a[0],a[1]]},xz:function(a){return[a[0],a[2]]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},plusEqual:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2]},sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},
mul:function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]},addMul:function(a,b,f){return f.length!=void 0&&f.length>=3?[a[0]+b[0]*f[0],a[1]+b[1]*f[1],a[2]+b[2]*f[2]]:[a[0]+b[0]*f,a[1]+b[1]*f,a[2]+b[2]*f]},plusEqualMul:function(a,b,f){f.length!==void 0&&f.length>=3?(a[0]+=b[0]*f[0],a[1]+=b[1]*f[1],a[2]+=b[2]*f[2]):(a[0]+=b[0]*f,a[1]+=b[1]*f,a[2]+=b[2]*f)},scale:function(a,b){return b.length!==void 0&&b.length>=3?[a[0]*b[0],a[1]*b[1],a[2]*b[2]]:[a[0]*b,a[1]*b,a[2]*b]},inplace_scale:function(a,b){b.length!==
void 0&&b.length>=3?(a[0]*=b[0],a[1]*=b[1],a[2]*=b[2]):(a[0]*=b,a[1]*=b,a[2]*=b)},negate:function(a){return[-a[0],-a[1],-a[2]]},inplace_negate:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2]},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return Math.abs(1-b)>1.0E-4?(b=1/b,[a[0]*b,a[1]*b,a[2]*b]):a},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},lengthSq:function(a){return a[0]*a[0]+
a[1]*a[1]+a[2]*a[2]},length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},distanceSq:function(a,b){var f=[a[0]-b[0],a[1]-b[1],a[2]-b[2]];return f[0]*f[0]+f[1]*f[1]+f[2]*f[2]},distance:function(a,b){var f=[a[0]-b[0],a[1]-b[1],a[2]-b[2]];return Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2])}};vec3.angle=function(a,b){return Math.acos(vec3.dot(a,b))/(vec3.length(a)*vec3.length(b))};vec3.direction=function(a,b){return vec3.normalize(vec3.sub(b,a))};
vec3.abs=function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])]};vec3.min=function(a,b){return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2])]};vec3.max=function(a,b){return[Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2])]};vec3.clamp=function(a,b,f){return vec3.min(f,vec3.max(a,b))};vec3.equal=function(a,b,f){f||(f=0.0010);return vec3.distanceSq(a,b)<f*f};vec3.lerp=function(a,b,f){return[a[0]+(b[0]-a[0])*f,a[1]+(b[1]-a[1])*f,a[2]+(b[2]-a[2])*f]};vec4={string:function(a){return"{ "+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+" }"},verify:function(a){return a==void 0||a.length==void 0||a.length<4?!1:typeof a[0]!="number"||typeof a[1]!="number"||typeof a[2]!="number"||typeof a[3]!="number"?!1:!0},inplace_copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3]},copy:function(a){return a.length==void 0?[a,a,a,a]:a.length==3?[a[0],a[1],a[2],1]:[a[0],a[1],a[2],a[3]]},zero:function(){return[0,0,0,0]},identity:function(){return[0,0,0,1]},up:function(){return[0,
1,0,0]},forward:function(){return[0,0,1,0]},right:function(){return[1,0,0,0]},random:function(a,b){return[a[0]+(b[0]-a[0])*Math.random(),a[1]+(b[1]-a[1])*Math.random(),a[2]+(b[2]-a[2])*Math.random(),a[3]+(b[3]-a[3])*Math.random()]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},mul:function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2],a[3]*b[3]]},addMul:function(a,b,f){return f.length!=void 0&&f.length>=4?[a[0]+b[0]*
f[0],a[1]+b[1]*f[1],a[2]+b[2]*f[2],a[3]+b[3]*f[3]]:[a[0]+b[0]*f,a[1]+b[1]*f,a[2]+b[2]*f,a[3]+b[3]*f]},scale:function(a,b){return b.length!=void 0&&b.length>=4?[a[0]*b[0],a[1]*b[1],a[2]*b[2],a[3]*b[3]]:[a[0]*b,a[1]*b,a[2]*b,a[3]*b]},negate:function(a){return[-a[0],-a[1],-a[2],-a[3]]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]);return Math.abs(1-b)>1.0E-4?(b=1/b,[a[0]*b,a[1]*b,a[2]*b,a[3]*b]):a},lengthSq:function(a){return a[0]*
a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},abs:function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2]),Math.abs(a[3])]},min:function(a,b){return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2]),Math.min(a[3],b[3])]},max:function(a,b){return[Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2]),Math.min(a[3],b[3])]}};vec4.clamp=function(a,b,f){return vec4.min(f,vec4.max(a,b))};
vec4.equal=function(a,b,f){f||(f=0.0010);return vec4.distanceSq(a,b)<f*f};vec4.lerp=function(a,b,f){return[a[0]+(b[0]-a[0])*f,a[1]+(b[1]-a[1])*f,a[2]+(b[2]-a[2])*f,a[3]+(b[3]-a[3])*f]};float3=function(){data=[3]};float4=function(){data=[4]};
mat4={string:function(a){var b="{ ";b+=a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", ";b+=a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", ";b+=a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", ";b+=a[12]+", "+a[13]+", "+a[14]+", "+a[15]+" }";return b},toCSSString:function(a,b){var f=10;b&&(f=b);var g="matrix3d(";g+=a[0].toFixed(10)+", "+a[1].toFixed(10)+", "+a[2].toFixed(10)+", "+a[3].toFixed(10)+", ";g+=a[4].toFixed(10)+", "+a[5].toFixed(10)+", "+a[6].toFixed(10)+", "+a[7].toFixed(10)+", ";g+=a[8].toFixed(10)+", "+a[9].toFixed(10)+
", "+a[10].toFixed(10)+", "+a[11].toFixed(10)+", ";g+=a[12].toFixed(10)*f+", "+(600-a[13].toFixed(10)*f)+", "+a[14].toFixed(10)*f+", "+a[15].toFixed(10)+")";return g},verify:function(a){if(a==void 0||a.length==void 0||a.length<16)return!1;for(var b=16;b--;)if(typeof a[b]!="number")return!1;return!0},copy:function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]},inplace_copy:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=
b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15]},identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},zero:function(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},basis:function(a,b,f,g){return g==null||g==void 0?[a[0],a[1],a[2],0,b[0],b[1],b[2],0,f[0],f[1],f[2],0,0,0,0,1]:[a[0],a[1],a[2],a.length==4?a[3]:0,b[0],b[1],b[2],b.length==4?b[3]:0,f[0],f[1],f[2],f.length==4?f[3]:0,g[0],g[1],g[2],g.length==4?g[3]:1]},angleAxis:function(a,b){a*=
Math.PI/180;a/=2;var f=Math.sin(a),g=Math.cos(a),h=f*f;vec3.normalize(b);vec3.lengthSq(b)<=0&&(b=[0,0,0,1]);var l=mat4.identity();if(b[0]==1&&b[1]==0&&b[2]==0)l[5]=1-2*h,l[6]=2*f*g,l[9]=-2*f*g,l[10]=1-2*h;else if(b[0]==0&&b[1]==1&&b[2]==0)l[0]=1-2*h,l[2]=-2*f*g,l[8]=2*f*g,l[10]=1-2*h;else if(b[0]==0&&b[1]==0&&b[2]==1)l[0]=1-2*h,l[1]=2*f*g,l[4]=-2*f*g,l[5]=1-2*h;else{var n=b[0],o=b[1],p=b[2],q=n*n,r=o*o,s=p*p;l[0]=1-2*(r+s)*h;l[1]=2*(n*o*h+p*f*g);l[2]=2*(n*p*h-o*f*g);l[4]=2*(o*n*h-p*f*g);l[5]=1-2*
(s+q)*h;l[6]=2*(o*p*h+n*f*g);l[8]=2*(p*n*h+o*f*g);l[9]=2*(p*o*h-n*f*g);l[10]=1-2*(q+r)*h}return l}};mat4.lookAt=function(a,b,f){b=vec3.normalize(vec3.sub(a,b));vec3.length(b)<1.0E-4&&(b=[0,0,1]);var f=vec3.normalize(vec3.cross(f,b)),g=vec3.normalize(vec3.cross(b,f)),h=mat4.identity();mat4.setRow(h,0,f);mat4.setRow(h,1,g);mat4.setRow(h,2,b);mat4.setRow(h,3,a);return h};
mat4.frustum=function(a,b,f,g,h,l){var n=b-a,o=g-f,p=l-h,q=2*h,r=mat4.zero();r[0]=q/n;r[5]=q/o;r[8]=(b+a)/n;r[9]=(g+f)/o;r[10]=-(l+h)/p;r[11]=-1;r[14]=-(q*l)/p;return r};mat4.perspective=function(a,b,f,g){var a=Math.tan(a*Math.PI/360)*f,h=-a;return mat4.frustum(b*h,b*a,h,a,f,g)};mat4.orthographic=function(a,b,f,g,h,l){var n=(a+b)/(a-b),o=(f+g)/(f-g),p=(l+h)/(l-h),q=mat4.zero();q[0]=2/(a-b);q[5]=2/(f-g);q[10]=-2/(l-h);q[12]=n;q[13]=o;q[14]=p;q[15]=1;return q};
mat4.mul=function(a,b){var f=a[0],g=a[1],h=a[2],l=a[3],n=a[4],o=a[5],p=a[6],q=a[7],r=a[8],s=a[9],u=a[10],v=a[11],x=a[12],w=a[13],y=a[14],z=a[15],A=b[0],C=b[1],D=b[2],B=b[3],E=b[4],F=b[5],G=b[6],H=b[7],I=b[8],J=b[9],K=b[10],L=b[11],M=b[12],N=b[13],O=b[14],P=b[15];return[f*A+g*E+h*I+l*M,f*C+g*F+h*J+l*N,f*D+g*G+h*K+l*O,f*B+g*H+h*L+l*P,n*A+o*E+p*I+q*M,n*C+o*F+p*J+q*N,n*D+o*G+p*K+q*O,n*B+o*H+p*L+q*P,r*A+s*E+u*I+v*M,r*C+s*F+u*J+v*N,r*D+s*G+u*K+v*O,r*B+s*H+u*L+v*P,x*A+w*E+y*I+z*M,x*C+w*F+y*J+z*N,x*D+w*G+
y*K+z*O,x*B+w*H+y*L+z*P]};mat4.mul4x3=function(a,b){var f=a[0],g=a[1],h=a[2],l=a[4],n=a[5],o=a[6],p=a[8],q=a[9],r=a[10],s=a[12],u=a[13],v=a[14],x=b[0],w=b[1],y=b[2],z=b[4],A=b[5],C=b[6],D=b[8],B=b[9],E=b[10];return[f*x+g*z+h*D,f*w+g*A+h*B,f*y+g*C+h*E,0,l*x+n*z+o*D,l*w+n*A+o*B,l*y+n*C+o*E,0,p*x+q*z+r*D,p*w+q*A+r*B,p*y+q*C+r*E,0,s*x+u*z+v*D+b[12],s*w+u*A+v*B+b[13],s*y+u*C+v*E+b[14],1]};mat4._det2x2=function(a,b,f,g){return a*g-b*f};
mat4._det3x3=function(a,b,f,g,h,l,n,o,p){return a*mat4._det2x2(h,l,o,p)-g*mat4._det2x2(b,f,o,p)+n*mat4._det2x2(b,f,h,l)};mat4._det4x4=function(a){var b=a[1],f=a[2],g=a[3],h=a[4],l=a[5],n=a[6],o=a[7],p=a[8],q=a[9],r=a[10],s=a[11],u=a[12],v=a[13],x=a[14],w=a[15];return a[0]*mat4._det3x3(l,q,v,n,r,x,o,s,w)-b*mat4._det3x3(h,p,u,n,r,x,o,s,w)+f*mat4._det3x3(h,p,u,l,q,v,o,s,w)-g*mat4._det3x3(h,p,u,l,q,v,n,r,x)};
mat4._adjoint=function(a){var b=a[0],f=a[1],g=a[2],h=a[3],l=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],u=a[11],v=a[12],x=a[13],w=a[14],a=a[15];return[mat4._det3x3(n,r,x,o,s,w,p,u,a),-mat4._det3x3(f,r,x,g,s,w,h,u,a),mat4._det3x3(f,n,x,g,o,w,h,p,a),-mat4._det3x3(f,n,r,g,o,s,h,p,u),-mat4._det3x3(l,q,v,o,s,w,p,u,a),mat4._det3x3(b,q,v,g,s,w,h,u,a),-mat4._det3x3(b,l,v,g,o,w,h,p,a),mat4._det3x3(b,l,q,g,o,s,h,p,u),mat4._det3x3(l,q,v,n,r,x,p,u,a),-mat4._det3x3(b,q,v,f,r,x,h,u,a),mat4._det3x3(b,l,v,f,
n,x,h,p,a),-mat4._det3x3(b,l,q,f,n,r,h,p,u),-mat4._det3x3(l,q,v,n,r,x,o,s,w),mat4._det3x3(b,q,v,f,r,x,g,s,w),-mat4._det3x3(b,l,v,f,n,x,g,o,w),mat4._det3x3(b,l,q,f,n,r,g,o,s)]};mat4.inverse=function(a){var b=mat4._det4x4(a);if(Math.abs(b)<1.0E-8)return null;a=mat4._adjoint(a);b=1/b;return[a[0]*b,a[1]*b,a[2]*b,a[3]*b,a[4]*b,a[5]*b,a[6]*b,a[7]*b,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12]*b,a[13]*b,a[14]*b,a[15]*b]};
mat4.rigidInverse=function(a){out=mat4.transpose3x3(a);out[12]=-vec3.dot([out[0],out[4],out[8]],[a[12],a[13],a[14]]);out[13]=-vec3.dot([out[1],out[5],out[9]],[a[12],a[13],a[14]]);out[14]=-vec3.dot([out[2],out[6],out[10]],[a[12],a[13],a[14]]);return out};mat4.transpose=function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]};mat4.transpose3x3=function(a){return[a[0],a[4],a[8],a[3],a[1],a[5],a[9],a[7],a[2],a[6],a[10],a[11],a[12],a[13],a[14],a[15]]};
mat4.transformPoint=function(a,b){var f=b[0],g=b[1],h=b[2],l=b.length>=4?b[3]:1;return[a[0]*f+a[4]*g+a[8]*h+a[12]*l,a[1]*f+a[5]*g+a[9]*h+a[13]*l,a[2]*f+a[6]*g+a[10]*h+a[14]*l,a[3]*f+a[7]*g+a[11]*h+a[15]*l]};mat4.transformVector=function(a,b){var a=mat4.inverse(a),f=b[0],g=b[1],h=b[2],l=b.length>=4?b[3]:0;return[a[0]*f+a[1]*g+a[2]*h+a[3]*l,a[4]*f+a[5]*g+a[6]*h+a[7]*l,a[8]*f+a[9]*g+a[10]*h+a[11]*l,a[12]*f+a[13]*g+a[14]*h+a[15]*l]};
mat4.transformPoint4x3=function(a,b){var f=b[0],g=b[1],h=b[2];return[a[0]*f+a[4]*g+a[8]*h+a[12],a[1]*f+a[5]*g+a[9]*h+a[13],a[2]*f+a[6]*g+a[10]*h+a[14],1]};mat4.transformVector4x3=function(a,b){var a=mat4.inverse(a),f=b[0],g=b[1],h=b[2];return[a[0]*f+a[1]*g+a[2]*h,a[4]*f+a[5]*g+a[6]*h,a[8]*f+a[9]*g+a[10]*h,0]};mat4.getRow=function(a,b){b*=4;return[a[b],a[b+1],a[b+2],a[b+3]]};mat4.getCol=function(a,b){return[a[b],a[b+4],a[b+8],a[b+12]]};
mat4.setRow=function(a,b,f){b*=4;a[b+0]=f[0];a[b+1]=f[1];a[b+2]=f[2];f.length>=4&&(a[b+3]=f[3]);return a};mat4.setCol=function(a,b,f){a[b+0]=f[0];a[b+4]=f[1];a[b+8]=f[2];f.length>=4&&(a[b+12]=f[3]);return a};mat4.rotate=function(a,b,f){return mat4.mul(a,mat4.angleAxis(b,f))};mat4.rotateX=function(a,b){return mat4.mul(a,mat4.angleAxis(b,vec3.basisX(a)))};mat4.rotateY=function(a,b){return mat4.mul(a,mat4.angleAxis(b,vec3.basisY(a)))};mat4.rotateZ=function(a,b){return mat4.mul(a,mat4.angleAxis(b,vec3.basisZ(a)))};
mat4.scale=function(a,b){var f=mat4.identity();b.length==void 0&&(b=[b,b,b]);f[0]=b[0];f[5]=b[1];f[10]=b[2];return mat4.mul(a,f)};mat4.scaleX=function(a,b){return mat4.scale(a,[b,1,1])};mat4.scaleY=function(a,b){return mat4.scale(a,[1,b,1])};mat4.scaleZ=function(a,b){return mat4.scale(a,[1,1,b])};mat4.translate=function(a,b){matT=mat4.identity();matT[12]=b[0];matT[13]=b[1];matT[14]=b[2];return mat4.mul(a,matT)};mat4.translateX=function(a,b){return mat4.translate(a,[b,0,0])};
mat4.translateY=function(a,b){return mat4.translate(a,[0,b,0])};mat4.translateZ=function(a,b){return mat4.translate(a,[0,0,b])};quat={string:function(a){return"{ "+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+" }"},verify:function(a){return a==void 0||a.length==void 0||a.length<4?!1:typeof a[0]!="number"||typeof a[1]!="number"||typeof a[2]!="number"||typeof a[3]!="number"?!1:!0},identity:function(){return[0,0,0,1]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},mul:function(a,b){return[a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],a[3]*b[0]+a[0]*b[3]+a[1]*
b[2]-a[2]*b[1],a[3]*b[1]-a[0]*b[2]+a[1]*b[3]+a[2]*b[0],a[3]*b[2]+a[0]*b[1]-a[1]*b[0]+a[2]*b[3]]},addMul:function(a,b,f){return f.length!=void 0&&f.length>=4?[a[0]+b[0]*f[0],a[1]+b[1]*f[1],a[2]+b[2]*f[2],a[3]+b[3]*f[3]]:[a[0]+b[0]*f,a[1]+b[1]*f,a[2]+b[2]*f,a[3]+b[3]*f]},scale:function(a,b){return b.length!=void 0&&b.length>=4?[a[0]*b[0],a[1]*a[1],a[2]*b[2],a[3]*b[3]]:[a[0]*b,a[1]*b,a[2]*b,a[3]*b]},lengthSq:function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},length:function(a){return Math.sqrt(a[0]*
a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]);return Math.abs(1-b)>1.0E-4?(b=1/b,[a[0]*b,a[1]*b,a[2]*b,a[3]*b]):a},inverse:function(a){var b=vec4.lengthSq(a);return b>1.0E-5?(b=1/b,[a[0]*-b,a[1]*-b,a[2]*-b,a[3]]):a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]}};quat.applyRotation=function(a,b){return mat4.transformPoint(quat.toMatrix(a),b)};
quat.lerp=function(a,b,f){return quat.normalize([a[0]+(b[0]-a[0])*f,a[1]+(b[1]-a[1])*f,a[2]+(b[2]-a[2])*f,a[3]+(b[3]-a[3])*f])};quat.slerp=function(a,b,f){var g=quat.dot(a,b);if(g>=0.9)return quat.lerp(a,b,f);var h=Math.sqrt(Math.abs(1-g*g));if(h<0.0010)return a;var g=g<0?-1:1,l=Math.asin(h),n=1/h,h=Math.sin((1-f)*l)*n,f=Math.sin(f*l)*n*g;quat.scale(a,h);quat.scale(b,f);return quat.normalize(quat.add(a,b))};
quat.toMatrix=function(a){var b=2*a[0],f=2*a[1],g=2*a[2],h=b*a[3],l=f*a[3],n=g*a[3];b*=a[0];var o=f*a[0],p=g*a[0];f*=a[1];var q=g*a[1],a=g*a[2];return[1-(f+a),o+n,p-l,0,o-n,1-(b+a),q+h,0,p+l,q-h,1-(b+f),0,0,0,0,1]};var stat=function(){pages={};dlgId="";self=function(a,b,f,g,h){h==void 0&&(h=!0);category=!a?"default":a;pages[category]||(pages[category]=[]);pages[category].push(this);this.name=b;this.value=this.defValue=f;this.func=g;this.reset=h;this.reportInterval=500;stat.dirty=!0;stat.find=function(a,b){var f=pages[a];for(i=0;i<f.length;++i)if(f[i].name==b)return f[i];return null};stat.closePage=function(a){pages[a]=null;stat.dirty=!0};stat.reportAll=function(b){if(stat.dirty==!0){var f=document.getElementById(b);
if(!f)return;var g='<div id="stat_tabs">';g+="<ul>";for(a in pages)pages[a]&&(g+='<li><a href="#'+a+'">'+a+"</a></li>");g+="</ul>";for(a in pages)pages[a]&&(g+='<div id="'+a+'">',g+="</div>");g+="</div>";f.innerHTML=g;$("#stat_tabs").tabs();stat.dirty=!1}for(a in pages)f=document.getElementById(a),stat.report(f,a,b)};stat.report=function(a,b){b||(b="default");var f=pages[b];if(f){outputHTML='<table width="100%" cellspacing = 1 border = 0><tr>';var g=0;for(i=0;i<f.length;++i)if(outputHTML+='<td width=200 align=center bgcolor="#3F3F3F">',
outputHTML+=f[i].func?f[i].name+" : "+f[i].func(f[i].value):f[i].name+" : "+f[i].value,outputHTML+="</td>",g++>=3&&(outputHTML+="</tr><tr>",g=0),f[i].reset)f[i].value=f[i].defValue;outputHTML+="</tr></table>";a.innerHTML=outputHTML}}};setInterval(function(){self.reportAll("RDGE_STATS")},500);return self}();
dbCanvas=function(a,b){this.front=document.createElement("canvas");this.front.setAttribute("width",a);this.front.setAttribute("height",b);this.front.setAttribute("style","position:absolute; margin: 0.0em; padding: 0.0em;");this.front.ctx=this.front.getContext("2d");this.back=document.createElement("canvas");this.back.setAttribute("width",a);this.back.setAttribute("height",b);this.front.setAttribute("style","position:absolute; margin: 0.0em; padding: 0.0em;");this.back.ctx=this.back.getContext("2d");
this.swap=function(){var a=this.front;this.front=this.back;this.back=a;this.front.style.visibility="visible";this.back.style.visibility="hidden"}};function getCanvasDimensions(a){var b={x:0,y:0};b.width=a.width;b.height=a.height;if(a.offsetParent){do b.x+=a.offsetLeft,b.y+=a.offsetTop;while(a=a.offsetParent)}return b}
graph2D=function(a,b,f,g,h,l,n){this.style=n||{bgcolor:"#000"};this.sampleRes=512;this.scale=1;this.rangeMin=h;this.rangeMax=l;this.offsetY=0;this.canvas=document.createElement("canvas");this.canvas.setAttribute("width",f);this.canvas.setAttribute("height",g-32);this.canvas.setAttribute("style","position:absolute; margin: 0.0em; padding: 0.0em;");o=this;this.onclick=function(a){for(var b=getCanvasDimensions(o.canvas),f=a.clientX-b.x,a=a.clientY-b.y,b=0;b<o.tracked.length;++b){var g=o.tracked[b].checkbox;
if(!(f<g.x)&&!(f>g.x+g.w)&&!(a>g.y+g.h)&&!(a<g.y)){o.tracked[b].hide=!o.tracked[b].hide;break}}};this.canvas.onclick=this.onclick;this.ctx=this.canvas.getContext("2d");this.tracked=[];this.addStat=function(a,b,f,g){this.tracked.push({label:a,stat:b,color:f,samples:[],hide:g,checkbox:{x:0,y:0,w:12,h:12}})};this.markers=[];this.addMarker=function(a,b,f){if(b.slice&&typeof b.slice==="function")for(i=0;i<b.length;++i)this.markers.push({label:a+i,value:b[i],color:f});else if(typeof b==="object"){var g=
(b.max-b.min)/b.interval,h=b.interval;for(i=0;i<=g;++i)this.markers.push({label:a+i,value:i*h-b.min,color:f})}else this.markers.push({label:a,value:b,color:f})};this.update=function(){for(var a=0;a<this.tracked.length;++a){var b=this.tracked[a];b.samples.length>this.sampleRes&&b.samples.shift();b.samples.push(b.stat.value)}};this.draw=function(){var a=this.canvas,b=this.ctx,f=a.width,g=a.height,h=this.rangeMin*this.scale,l=1/(this.rangeMax*this.scale-h),n=16+Math.floor(this.tracked.length/4+0.5)*
16;b.fillStyle=this.style.bgcolor;b.strokeStyle=this.style.bgcolor;b.fillRect(0,0,f,g-n);for(a=0;a<this.markers.length;++a){var o=this.markers[a];b.fillStyle=o.color;b.strokeStyle=o.color;var y=g-(n+(o.value-h)*l*g),z=b.measureText(o.value);b.lineWidth=1;b.beginPath();b.moveTo(0,Math.round(y));b.lineTo(f,Math.round(y));b.stroke();b.closePath()}b.lineWidth=1;for(a=0;a<this.tracked.length;++a)if(o=this.tracked[a],!o.hide){z=f/this.sampleRes;b.fillStyle=o.color;b.beginPath();y=(o.samples[0]-h)*l*g;b.moveTo(0,
g-(n+y));for(var A=1;A<o.samples.length;A++)y=(o.samples[A]-h)*l*g,b.lineTo(A*z,g-(n+y));b.strokeStyle=o.color;b.stroke();b.closePath()}b.globalAlpha=0.25;A=f*0.125/this.scale;b.fillStyle="#044";b.fillRect(f-A,0,A,g);for(a=0;a<this.markers.length;++a)o=this.markers[a],b.fillStyle=o.color,b.strokeStyle=o.color,y=g-(n+(o.value-h)*l*g),b.font=Math.round(10/this.scale)+"pt courier",z=b.measureText(o.value),b.globalAlpha=1,b.fillText(o.value,f-z.width-5,y-2,A),b.globalAlpha=0.25;b.globalAlpha=1;b.lineWidth=
1;b.fillStyle="#0A0A0A";b.strokeStyle="#8F8F8F";b.fillRect(0,g-n,f,n);b.translate([0.5,0.5]);f/=4;g=g-n+16;for(a=0;a<this.tracked.length;++a)o=this.tracked[a],b.font="6pt Arial",b.fillStyle=o.color,b.strokeStyle=o.color,n=Math.floor(16+f*((a+4)%4)),h=Math.floor(g+Math.floor(a/4)*16),o.checkbox.x=Math.floor(n-o.checkbox.w/2),o.checkbox.y=Math.floor(h-o.checkbox.h/2),o.hide?b.strokeRect(o.checkbox.x,o.checkbox.y,o.checkbox.w,o.checkbox.h):b.fillRect(o.checkbox.x,o.checkbox.y,o.checkbox.w,o.checkbox.h),
b.fillText(o.label,n+10,h+4);b.translate([-0.5,-0.5])};var o=this;setInterval(function(){o.update();o.draw()},16)};fpsTracker=function(a){this.id=a;this.fpsRaw=new stat(a+"_fps","raw",0,null,!1);this.fpsAvg=new stat(a+"_fps","avg",0,null,!1);this.fpsMin=new stat(a+"_fps","min",0,null,!1);this.fpsMax=new stat(a+"_fps","max",0,null,!1);this.samples=[];this.maxSamples=10;this.timeStampMS=0;this.reportInterval=500;this.close=function(){stat.pages[a+"_fps"]=null};this.sample=function(){var a=(new Date).getTime();this.samples.push(a-this.timeStampMS);this.samples.length>this.maxSamples&&this.samples.shift();this.timeStampMS=
a;for(var f=0,g=-1E10,a=1E10,h=this.samples.length-1;h>=0;)f+=this.samples[h],g=Math.max(g,this.samples[h]),a=Math.min(a,this.samples[h]),h--;f=this.samples.length>0?f/this.samples.length:0;f=f>0?1E3/f:0;g=g>0?1E3/g:0;a=a>0?1E3/a:0;h=this.samples[this.samples.length-1];this.fpsRaw.value=(h>0?1E3/h:0).toFixed(2);this.fpsAvg.value=f.toFixed(2);this.fpsMin.value=g.toFixed(2);this.fpsMax.value=a.toFixed(2)}};objectManager=function(){this.guidCounter=0;this.objects=[];this.numObjects=0;this.freelist=[];this.reset=function(){this.objects=[];this.freelist=[];this.guidCounter=0};this.validHandle=function(a){return this.handleToIndex(a)!=-1};this.handleToIndex=function(a){var b=a>>16&65535;return this.objects[b]!=null&&a==this.objects[b].handle?b:-1};this.handleToObject=function(a){a=this.handleToIndex(a);return a!=-1?this.objects[a]:null};this.addObject=function(a){var b=this.objects.length;this.freelist.length>
0&&(b=this.freelist.pop());if(++this.guidCounter>=65535)this.guidCounter=1;a.handle=b<<16|++this.guidCounter;this.objects[b]=a;return a.handle};this.removeObject=function(a){a=this.handleToIndex(a);if(a!=-1){if(this.objects[a].onremove!=void 0)this.objects[a].onremove();this.objects[a]=null;this.freelist.push(a)}}};rdgeGlobalParameters={u_projMatrix:{type:"mat4",data:mat4.identity()},u_mvMatrix:{type:"mat4",data:mat4.identity()},u_invMvMatrix:{type:"mat4",data:mat4.identity()},u_normalMatrix:{type:"mat4",data:mat4.identity()},u_worldMatrix:{type:"mat4",data:mat4.identity()},u_viewMatrix:{type:"mat4",data:mat4.identity()},u_invViewMatrix:{type:"mat4",data:mat4.identity()},u_invWorldMatrix:{type:"mat4",data:mat4.identity()},u_inv_viewport_width:{type:"float",data:[1]},u_inv_viewport_height:{type:"float",data:[1]},
u_lightPos:{type:"vec3",data:[-20,50,20]},u_lightDiff:{type:"vec4",data:[0.8,0.8,0.8,1]},u_lightAmb:{type:"vec4",data:[1,1,1,1]},rdge_lights:{u_light0Pos:{type:"vec3",data:[-20,50,20]},u_light0Diff:{type:"vec4",data:[0.8,0.8,0.8,1]},u_light0Amb:{type:"vec4",data:[8.0E-4,8.0E-4,8.0E-4,1]},u_light0Spec:{type:"vec4",data:[1,1,1,1]},u_light1Pos:{type:"vec3",data:[0,0,0]},u_light1Diff:{type:"vec4",data:[0,0,0,0]},u_light1Amb:{type:"vec4",data:[0.5,0.5,0.5,1]},u_light1Spec:{type:"vec4",data:[1,1,1,1]},
u_light2Pos:{type:"vec3",data:[0,0,0]},u_light2Diff:{type:"vec4",data:[0,0,0,1]},u_light2Amb:{type:"vec4",data:[0.5,0.5,0.5,1]},u_light2Spec:{type:"vec4",data:[1,1,1,1]},u_light3Pos:{type:"vec3",data:[0,0,0]},u_light3Diff:{type:"vec4",data:[0.8,0.8,0.8,1]},u_light3Amb:{type:"vec4",data:[0.5,0.5,0.5,1]},u_light3Spec:{type:"vec4",data:[1,1,1,1]}},colMap:{type:"tex2d",data:"assets/images/white.png"},envMap:{type:"tex2d",data:null},normalMap:{type:"tex2d",data:null},glowMap:{type:"tex2d",data:"assets/images/black.png"},
u_shadowDepthMap:{type:"tex2d",data:null},u_depthMap:{type:"tex2d",data:null},u_matAmbient:{type:"vec4",data:[1,1,1,1]},u_matDiffuse:{type:"vec4",data:[1,1,1,1]},u_matSpecular:{type:"vec4",data:[1,1,1,1]},u_matShininess:{type:"float",data:[128]},u_matEmission:{type:"float",data:[0,0,0,1]},u_frustumFarZ:{type:"float",data:[1E3]},u_shadowLightWorld:{type:"mat4",data:mat4.identity()},u_shadowBiasMatrix:{type:"mat4",data:mat4.identity()},u_vShadowLight:{type:"mat4",data:mat4.identity()},u_shadowBPV:{type:"mat4",
data:mat4.identity()},u_farZ:{type:"float",data:[1E3]},u_shadowLightFarZ:{type:"float",data:[1E3]},u_cameraFTR:{type:"vec3",data:[0,0,0]}};g_renderStats={};g_renderStats.numDrawCalls=new stat("rendering","numDrawCalls",0,null,!1);g_renderStats.numTriangles=new stat("rendering","numTriangles",0,null,!1);g_renderStats.numVerts=new stat("rendering","numVerts",0,null,!1);g_renderStats.numPasses=new stat("rendering","numPasses",0,null,!1);g_renderStats.reset=function(){g_renderStats.numTriangles.value=0;g_renderStats.numDrawCalls.value=0;g_renderStats.numVerts.value=0;g_renderStats.numPasses.value=0};
rdgeConstants={colorBuffer:16384,depthBuffer:256,stencilBuffer:1024,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,VS_ELEMENT_FLOAT4:4,VS_ELEMENT_POS:3,VS_ELEMENT_NORM:3,VS_ELEMENT_FLOAT3:3,VS_ELEMENT_FLOAT2:2,VS_ELEMENT_UV:2,VS_ELEMENT_FLOAT:1,MAX_ELEM_TYPES:7,BUFFER_STATIC:35040,BUFFER_DYNAMIC:35044,BUFFER_STREAM:35048,
MAX_MATERIAL_LIGHTS:4,categoryEnumeration:{BACKGROUND:0,OPAQUE:1,TRANSPARENT:2,ADDITIVE:3,TRANSLUCENT:4,FOREGROUND:5,MAX_CAT:6},nodeType:{TRNODE:0,MESHNODE:1,MATNODE:2,LIGHTNODE:3}};rdgeId=0;function getBufferID(){return rdgeId++}
_renderer=function(a){try{this.ctx=a.getContext("experimental-webgl",{preserveDrawingBuffer:!0});if(!this.ctx)this.ctx=a.getContext("webgl",{preserveDrawingBuffer:!0});if(!this.ctx)this.ctx=a.getContext("webkit-3d",{preserveDrawingBuffer:!0});if(!this.ctx)this.ctx=a.getContext("moz-webgl",{preserveDrawingBuffer:!0})}catch(b){}if(!this.ctx)return window.console.log("Could not create GL context"),null;this.ctx.viewport(0,0,a.width,a.height);this.console="console"in window?window.console:{log:function(){}};
this.ctx.clearColor(1,0,0,1);this.clearColor=[1,0,0,1];this.clearFlags=this.ctx.COLOR_BUFFER_BIT|this.ctx.DEPTH_BUFFER_BIT;this.colorBuffer=this.ctx.COLOR_BUFFER_BIT;this.depthBuffer=this.ctx.DEPTH_BUFFER_BIT;this.stencilBuffer=this.ctx.STENCIL_BUFFER_BIT;this.BUFFER_STATIC=0;this.BUFFER_DYNAMIC=1;this.BUFFER_STREAM=2;this.POINTS=0;this.LINES=1;this.LINE_LOOP=2;this.LINE_STRIP=3;this.TRIANGLES=4;this.TRIANGLE_STRIP=5;this.TRIANGLE_FAN=6;this.BYTE=5120;this.UNSIGNED_BYTE=5121;this.SHORT=5122;this.UNSIGNED_SHORT=
5123;this.INT=5124;this.UNSIGNED_INT=5125;this.FLOAT=5126;this.VS_ELEMENT_FLOAT4=4;this.VS_ELEMENT_FLOAT3=this.VS_ELEMENT_NORM=this.VS_ELEMENT_POS=3;this.VS_ELEMENT_UV=this.VS_ELEMENT_FLOAT2=2;this.VS_ELEMENT_FLOAT=1;this.MAX_ELEM_TYPES=7;this.BUFFER_STATIC=35040;this.BUFFER_DYNAMIC=35044;this.BUFFER_STREAM=35048;this.MAX_MATERIAL_LIGHTS=4;this.usedTextureUnits=5;this.vpY=this.vpX=0;this.vpWidth=a.width;this.vpHeight=a.height;this.cameraMan=new cameraManager;this.buffers=[];this.cullBackFace=function(){this.ctx.cullFace(this.ctx.Back)};
this.cullFrontFace=function(){this.ctx.cullFace(this.ctx.FRONT)};this.disableCulling=function(){this.ctx.disable(this.ctx.CULL_FACE)};this.enableCulling=function(){this.ctx.enable(this.ctx.CULL_FACE)};this.enablePolyOffsetFill=function(){this.ctx.enable(this.ctx.POLYGON_OFFSET_FILL)};this.disablePolyOffsetFill=function(){this.ctx.enable(this.ctx.POLYGON_OFFSET_FILL)};this.enablePointSprites=function(){};this.disablePointSprites=function(){};this.setClearColor=function(a){this.clearColor=a.slice();
this.ctx.clearColor(a[0],a[1],a[2],a[3])};this.setClearFlags=function(a){this.clearFlags=a};this._clear=function(){this.ctx.clear(this.clearFlags)};this.clear=function(a){this.ctx.clear(a)};this.flush=function(){this.ctx.flush()};this.setViewPort=function(a,b,h,l){this.vpX=a;this.vpY=b;this.vpWidth=h;this.vpHeight=l;this.ctx.viewport(this.vpX,this.vpY,this.vpWidth,this.vpHeight)};this.cameraManager=function(){return this.cameraMan};this.textureMap=[];this.rttMap=[];this.getTextureByName=function(a,
b,h){var l=a.split(".")[1],n=this.textureMap[a];if(n===void 0)n=this.createTexture(a+(l?"":".png"),b,h),this.textureMap[a]=n,n.lookUpName=a;return n};_texparams=function(a,b){this.wrap=a;this.mips=b};this.createTexture=function(a,b,h){var l=this.ctx.createTexture();b===void 0&&(b="CLAMP");h===void 0&&(h=!0);if(l)l.image=new Image,l.image.src=a,l.image.context=g_Engine.getContext(),l.texparams=new _texparams(b,h),l.image.onload=function(){this.context.ctxStateManager.RDGEInitState.loadTexture(l)};
return l};this.commitTexture=function(a){this.ctx.bindTexture(this.ctx.TEXTURE_2D,a);this.ctx.texImage2D(this.ctx.TEXTURE_2D,0,this.ctx.RGBA,this.ctx.RGBA,this.ctx.UNSIGNED_BYTE,a.image);a.texparams.mips&&this.ctx.generateMipmap(this.ctx.TEXTURE_2D);this.ctx.texParameteri(this.ctx.TEXTURE_2D,this.ctx.TEXTURE_MAG_FILTER,this.ctx.LINEAR);this.ctx.texParameteri(this.ctx.TEXTURE_2D,this.ctx.TEXTURE_MIN_FILTER,a.texparams.mips?this.ctx.LINEAR_MIPMAP_LINEAR:this.ctx.LINEAR);this.ctx.texParameteri(this.ctx.TEXTURE_2D,
this.ctx.TEXTURE_WRAP_S,a.texparams.wrap==="REPEAT"?this.ctx.REPEAT:this.ctx.CLAMP_TO_EDGE);this.ctx.texParameteri(this.ctx.TEXTURE_2D,this.ctx.TEXTURE_WRAP_T,a.texparams.wrap==="REPEAT"?this.ctx.REPEAT:this.ctx.CLAMP_TO_EDGE);this.ctx.bindTexture(this.ctx.TEXTURE_2D,null)};this.verify=function(a){var b=this.ctx.getError();b!=0&&window.console.log("GLError ( "+a+") : "+b)};this.createRenderTargetTexture=function(a,b,h,l){var n=this.ctx,o=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,o);o.width=
b;o.height=h;b=n.createTexture();n.bindTexture(n.TEXTURE_2D,b);try{n.texImage2D(n.TEXTURE_2D,0,n.RGBA,o.width,o.height,0,n.RGBA,n.UNSIGNED_BYTE,null)}catch(p){h=new WebctxUnsignedByteArray(o.width*o.height*4),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,o.width,o.height,0,n.RGBA,n.UNSIGNED_BYTE,h)}n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,l?n.LINEAR_MIPMAP_NEAREST:n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,
n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);l&&n.generateMipmap(n.TEXTURE_2D);l=n.createRenderbuffer();n.bindRenderbuffer(n.RENDERBUFFER,l);n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,o.width,o.height);n.getError(n.bindFramebuffer(n.FRAMEBUFFER,o));n.getError(n.bindRenderbuffer(n.RENDERBUFFER,l));n.getError(n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,o.width,o.height));n.bindRenderbuffer(n.RENDERBUFFER,null);n.getError(n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,
b,0));n.getError(n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,l));n.bindFramebuffer(n.FRAMEBUFFER,null);n.bindTexture(n.TEXTURE_2D,null);n.bindRenderbuffer(n.RENDERBUFFER,null);n.bindFramebuffer(n.FRAMEBUFFER,null);b.id="RT_"+nodeIdGen.getId();b.frameBuffer=o;this.textureMap[a]&&window.console.log("Notification: render target: "+a+" has overwritten an existing render target");return this.textureMap[a]=b};this.defaultShaderDefintion={shaders:{defaultVShader:"assets/shaders/test_vshader.glsl",
defaultFShader:"assets/shaders/test_fshader.glsl"},techniques:{defaultTechnique:[{vshader:"defaultVShader",fshader:"defaultFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"},texcoord:{type:"vec2"}},params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}}};
rdgeDefaultShaderDefintion={shaders:{defaultVShader:"assets/shaders/test_vshader.glsl",defaultFShader:"assets/shaders/test_fshader.glsl"},techniques:{defaultTechnique:[{vshader:"defaultVShader",fshader:"defaultFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"},texcoord:{type:"vec2"}},params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}};
rdgeDepthMapShaderDef={shaders:{depthMapVShader:"assets/shaders/depthMap_vshader.glsl",depthMapFShader:"assets/shaders/depthMap_fshader.glsl"},techniques:{shadowDepthMap:[{vshader:"depthMapVShader",fshader:"depthMapFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"},texcoord:{type:"vec2"}},params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}],depthMap:[{vshader:"depthMapVShader",fshader:"depthMapFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"},texcoord:{type:"vec2"}},
params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}};rdgeViewSpaceNormalsShader={shaders:{normalsVShader:"assets/shaders/norm_depth_vshader.glsl",normalsFShader:"assets/shaders/norm_depth_fshader.glsl"},techniques:{depthMapWNormal:[{vshader:"normalsVShader",fshader:"normalsFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"}},params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}};
rdgeScreenQuadShaderDef={shaders:{screenQuadVShader:"\t\t\t\tattribute vec3 a_pos;\t\t\t\tattribute vec2 a_uv;\t\t\t\tuniform float u_inv_viewport_width;\t\t\t\tuniform float u_inv_viewport_height;\t\t\t\tvarying vec2 vTexcoord;\t\t\t\tvoid main()\t\t\t\t{\t\t\t\t\tgl_Position = vec4(a_pos.xy, 0.0, 1.0);\t\t\t\t\t\t\t\tvTexcoord.x = 0.5 * (1.0 + a_pos.x + u_inv_viewport_width);\t\t\t\tvTexcoord.y = 0.5 * (1.0 - a_pos.y + u_inv_viewport_height);\t\t\t\t}",screenQuadFShader:"\t\t\t\tprecision highp float;\t\t\t\tuniform sampler2D u_mainRT;\t\t\t\tuniform sampler2D u_glowFinal;\t\t\t\tuniform sampler2D u_ssaoRT;\t\t\t\tuniform sampler2D u_shadowMap;\t\t\t\tvarying vec2 vTexcoord;\t\t\t\tvoid main()\t\t\t\t{\t\t\t\t vec2 tex = vec2(vTexcoord.x, 1.0 - vTexcoord.y);\t\t\t\t vec4 glowTexel = texture2D(u_glowFinal, tex);\t\t\t\t vec4 ssaoTexel = texture2D(u_ssaoRT, tex);\t\t\t\t vec4 smapCoef = texture2D(u_shadowMap, tex);\t\t\t\t ssaoTexel.a = 0.0;\t\t\t\t vec4 texel\t\t= texture2D(u_mainRT, tex);\t\t\t\t gl_FragColor = vec4(texel.r*((1.0 - glowTexel.r)*smapCoef.r), texel.g*((1.0 - glowTexel.g)*smapCoef.g), texel.b*((1.0 - glowTexel.b)*smapCoef.b), texel.a) + glowTexel - ssaoTexel;\t\t\t\t}"},
techniques:{screenQuad:[{vshader:"screenQuadVShader",fshader:"screenQuadFShader",attributes:{a_pos:{type:"vec3"},a_uv:{type:"vec2"}},params:{u_mainRT:{type:"tex2d"},u_glowFinal:{type:"tex2d",data:"assets/images/black"},u_ssaoRT:{type:"tex2d",data:"assets/images/black"},u_shadowMap:{type:"tex2d",data:"assets/images/white"}},states:{blendEnabled:!0,srcBlend:"SRC_ALPHA",dstcBlend:"ONE_MINUS_SRC_ALPHA"}}]}};
rdgeGlowMapShader={shaders:{createGlowVShader:"assets/shaders/glowMap_vshader.glsl",createGlowFShader:"assets/shaders/glowMap_fshader.glsl"},techniques:{createGlowMap:[{vshader:"createGlowVShader",fshader:"createGlowFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"},texcoord:{type:"vec2"}},params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}};
rdgeGaussianBlurShader={shaders:{blurVShader:"assets/shaders/separableBlur_vshader.glsl",blurFShader:"assets/shaders/separableBlur_fshader.glsl"},techniques:{gaussianBlur:[{vshader:"blurVShader",fshader:"blurFShader",attributes:{vert:{type:"vec3"},texcoord:{type:"vec2"}},params:{vCoeffs:{type:"vec3",data:[0.3125,0.375,0.3125]},vOffset:{type:"vec2",data:[0.00617,0.00617]},u_weight:{type:"float",data:[1]},sTexture:{type:"tex2d"}},states:{culling:!1}}]}};
rdgeSSAOShader={shaders:{blurVShader:"assets/shaders/ssao_vshader.glsl",blurFShader:"assets/shaders/ssaohr_fshader.glsl"},techniques:{ssao:[{vshader:"blurVShader",fshader:"blurFShader",attributes:{vert:{type:"vec3"},texcoord:{type:"vec2"}},params:{u_normalsRT:{type:"tex2d"},u_depthMap:{type:"tex2d"},sRandMap:{type:"tex2d",data:"assets/images/random_normal.png",wrap:"REPEAT",mips:!1},u_cameraFTR:{type:"vec3"},u_artVals:{type:"vec4",data:[0.36,0.75,0.6,0.05]},u_randMapSize:{type:"float",data:[64]},
u_screenSize:{type:"vec2",data:[1024,1024]}},states:{culling:!1}}]}};rdgeShadowMapShader={shaders:{shadowMapVShader:"assets/shaders/shadowMap_vshader.glsl",shadowMapFShader:"assets/shaders/shadowMap_fshader.glsl"},techniques:{shadowMap:[{vshader:"shadowMapVShader",fshader:"shadowMapFShader",attributes:{a_pos:{type:"vec3"},a_uv:{type:"vec2"}},params:{u_lightSize:{type:"float",data:[7.93]},u_shadowColor:{type:"vec4",data:[0.922,0.7373,0.4824,0.5]}},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}};
rdgeNoiseBlurShader={shaders:{blurVShader:"assets/shaders/noiseBlur_vshader.glsl",blurFShader:"assets/shaders/noiseBlur_fshader.glsl"},techniques:{blur:[{vshader:"blurVShader",fshader:"blurFShader",attributes:{a_pos:{type:"vec3"},a_uv:{type:"vec2"}},params:{u_blurSourceMap:{type:"tex2d"}},states:{culling:!1}}]}};
function rdgePrimitiveDefinition(){this.type=rdgeConstants.TRIANGLE_STRIP;this.vertexDefinition={};this.bufferStreams=[];this.streamUsage=[];this.indexUsage=rdgeConstants.BUFFER_STREAM;this.indexBuffer=[];this.setCount=0;this.indexOffsets=[];this.indexCount=this.triCount=this.posCount=0;this.indexElementSize=rdgeConstants.UNSIGNED_SHORT;this.bufferHandles=[];this.buffersID=-1;this.indexHandle=null;this.useDoubleBuffer=!1;this.frontBufferIndex=this.doubleBufferOffset=0;this.update=function(a){if(!this.bufferStreams[a])return null;
this.bufferStreams[a].dirty=!0;return this.bufferStreams[a]};this.flip=function(a){if(this.useDoubleBuffer===!0)for(var b=0,f=this.bufferStreams.length;b<f;++b)if(this.bufferStreams[b].dirty)this.bufferStreams[b].dirty=!1,a.updateBuffer(a.buffers[this.buffersID][this.frontBufferIndex*this.doubleBufferOffset+b],this.bufferStreams[b],this.streamUsage[b]),this.frontBufferIndex=1-this.frontBufferIndex}}
_renderer.prototype.createIndexBufferUINT16=function(a,b){var f=this.ctx.createBuffer();f.type=a.type;this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,f);this.ctx.bufferData(this.ctx.ELEMENT_ARRAY_BUFFER,typeof k=="number"?a:new Uint16Array(a),b);return f};
_renderer.prototype.createIndexBufferUINT8=function(a,b){var f=this.ctx.createBuffer();f.type=a.type;this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,f);this.ctx.bufferData(this.ctx.ELEMENT_ARRAY_BUFFER,typeof k=="number"?a:new Uint8Array(a),b);return f};_renderer.prototype.createBufferFLOAT32=function(a,b){var f=this.ctx.createBuffer();f.type=a.type;this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,f);this.ctx.bufferData(this.ctx.ARRAY_BUFFER,typeof k=="number"?a:new Float32Array(a),b);return f};
_renderer.prototype.createBufferINT32=function(a,b){var f=this.ctx.createBuffer();f.type=a.type;this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,f);this.ctx.bufferData(this.ctx.ARRAY_BUFFER,typeof k=="number"?a:new Int32Array(a),b);return f};_renderer.prototype.createBufferINT16=function(a,b){var f=this.ctx.createBuffer();f.type=a.type;this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,f);this.ctx.bufferData(this.ctx.ARRAY_BUFFER,typeof k=="number"?a:new Int16Array(a),b);return f};
_renderer.prototype.updateBuffer=function(a,b,f,g){this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,a);f===rdgeConstants.BUFFER_DYNAMIC?this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,g||0,new Float32Array(b)):this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array(b),f)};_renderer.prototype.createPrimitive=function(a){if(a.built){if(this.buffers[a.buffersID])return}else a.buffersID=getBufferID(),a.built=!0;this.buffers[a.buffersID]=[];this.buffers[a.buffersID].ctxId=this.id;this.updatePrimitive(a)};
_renderer.prototype.updatePrimitive=function(a){if(a.built){var b=[],f;for(f in a.vertexDefinition){var g=a.vertexDefinition[f];if(!(b.indexOf(g.bufferIndex)>-1)){b.push(g.bufferIndex);g.debugName=f+" buffer";if(g.type==this.VS_ELEMENT_POS)a.posCount=a.bufferStreams[g.bufferIndex].length,a.positions=a.bufferStreams[g.bufferIndex];this.buffers[a.buffersID][g.bufferIndex]==void 0?(a.bufferStreams[g.bufferIndex].type=f+" PrimaryBuffer",a.forceVertexCount?(this.buffers[a.buffersID][g.bufferIndex]=this.createBufferFLOAT32(4*
a.forceVertexCount,g.bufferUsage),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[g.bufferIndex]),g.bufferUsage)):this.buffers[a.buffersID][g.bufferIndex]=this.createBufferFLOAT32(a.bufferStreams[g.bufferIndex],g.bufferUsage)):(this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[a.buffersID][g.bufferIndex]),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[g.bufferIndex]),g.bufferUsage));if(a.useDoubleBuffer===!0)a.doubleBufferOffset=
a.bufferStreams.length,a.bufferStreams[g.bufferIndex].type=f+" SecondaryBuffer",this.buffers[a.buffersID][a.doubleBufferOffset+g.bufferIndex]==void 0?a.forceVertexCount?(this.buffers[a.buffersID][a.doubleBufferOffset+g.bufferIndex]=this.createBufferFLOAT32(4*a.prim.forceVertexCount,g.bufferUsage),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[g.bufferIndex]),g.bufferUsage)):this.buffers[a.buffersID][a.doubleBufferOffset+g.bufferIndex]=this.createBufferFLOAT32(a.bufferStreams[g.bufferIndex],
g.bufferUsage):(this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[a.buffersID][a.doubleBufferOffset+g.bufferIndex]),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[g.bufferIndex]),g.bufferUsage))}}a.indexBuffer.length>0?(b=a.indexBuffer.length,a.indexBuffer.debugName="index Buffer",this.buffers[a.buffersID].indexHandle==void 0?a.forceIndexCount?(this.buffers[a.buffersID].indexHandle=this.createIndexBufferUINT16(2*a.forceIndexCount,a.indexUsage),this.ctx.bufferSubData(this.ctx.ELEMENT_ARRAY_BUFFER,
0,new Float32Array(a.indexBuffer),a.indexUsage)):this.buffers[a.buffersID].indexHandle=this.createIndexBufferUINT16(a.indexBuffer,a.indexUsage):(this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,this.buffers[a.buffersID].indexHandle),this.ctx.bufferSubData(this.ctx.ELEMENT_ARRAY_BUFFER,0,new Float32Array(a.indexBuffer),a.indexUsage)),a.indexCount=b,a.triCount=b/3):a.triCount=a.posCount/3}else this.createPrimitive(a)};
_renderer.prototype.deletePrimitive=function(a){var b=this.buffers[a.buffersID];if(b){var f=this;b.forEach(function(a){f.ctx.deleteBuffer(a)});delete this.buffers[a.buffersID]}};_renderer.prototype.getPrimitiveBuffer=function(a,b){return this.buffers[a.buffersID][b]};
_renderer.prototype.drawPrimitive=function(a,b,f){g_renderStats.numDrawCalls.value++;g_renderStats.numTriangles.value+=Math.floor(a.triCount);g_renderStats.numVerts.value+=Math.floor(a.coordCount/3);a.indexCount?this.drawIndexedPrimitive(a,b,f):this.drawNonIndexedPrimitive(a,b,f);a.useDoubleBuffer===!0&&a.flip(this)};
_renderer.prototype.drawIndexedPrimitive=function(a,b,f){var g=b=0,h=a.buffersID,l="",n=f.length,o=0,p=a.frontBufferIndex*a.doubleBufferOffset;for(g_Engine.getContext();o<n;++o)if(g=f[o].loc,l=f[o].name,a.vertexDefinition[l])b=a.vertexDefinition[l].bufferIndex,this.ctx.enableVertexAttribArray(g),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[h][p+b]),this.ctx.vertexAttribPointer(g,a.vertexDefinition[l].type,this.FLOAT,!1,0,0);this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,this.buffers[h].indexHandle);
this.ctx.drawElements(a.type,a.indexCount,a.indexElementSize,0);for(o=0;o<n;++o)this.ctx.disableVertexAttribArray(f[o].loc)};
_renderer.prototype.drawIndexedPrimitiveWireFrame=function(a,b,f){for(var g=b=0,h=a.buffersID,l="",n=f.length,o=0,p=a.frontBufferIndex*a.doubleBufferOffset;o<n;++o)if(g=f[o].loc,l=f[o].name,a.vertexDefinition[l])b=a.vertexDefinition[l].bufferIndex,this.ctx.enableVertexAttribArray(g),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[h][p+b]),this.ctx.vertexAttribPointer(g,a.vertexDefinition[l].type,this.FLOAT,!1,0,0);this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,this.buffers[h].indexHandle);
this.ctx.drawElements(this.LINE_LOOP,a.indexCount,a.indexElementSize,0);for(o=0;o<n;++o)this.ctx.disableVertexAttribArray(f[o].loc)};
_renderer.prototype.drawNonIndexedPrimitive=function(a,b,f){for(var g=b=0,h=a.buffersID,l="",n=f.length,o=0,p=a.frontBufferIndex*a.doubleBufferOffset;o<n;++o)g=f[o].loc,l=f[o].name,b=a.vertexDefinition[l].bufferIndex,a.vertexDefinition[l]&&(this.ctx.enableVertexAttribArray(g),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[h][p+b]),this.ctx.vertexAttribPointer(g,a.vertexDefinition[l].type,this.FLOAT,!1,0,0));this.ctx.drawArrays(a.type,0,a.triCount);for(o=0;o<n;++o)this.ctx.disableVertexAttribArray(f[o].loc)};
_renderer.prototype.drawIndexedPrimitiveSet=function(a){window.alert("drawIndexedPrimitiveSet is not implemented");for(var b=0;b<a.setCount;++b)this.ctx.drawElements(a.type[b],mesh.numIndices[b],a.indexElementSize[b],a.indexOffsets[b])};
renderDebug=function(a){this.renderer=g_Engine.getContext().renderer;this.ctx=g_Engine.getContext().renderer.ctx;this.hidden=!1;this.maxLines=a;this.lineBuffer=[];this.posBufferData=new Float32Array(3*this.maxLines);this.colorBufferData=new Float32Array(4*this.maxLines);this.posBufferObject=renderer.createBufferFLOAT32(this.posBufferData,this.renderer.BUFFER_DYNAMIC);this.colorBufferObject=renderer.createBufferFLOAT32(this.colorBufferData,this.renderer.BUFFER_DYNAMIC);this.shader=new jshader;this.shader.def=
{shaders:{defaultVShader:"\t\t\t\tuniform mat4 u_mvMatrix;\t\t\t\tuniform mat4 u_projMatrix;\t\t\t\tattribute vec3\ta_pos;\t\t\t\tattribute vec4  a_color;\t\t\t\tvarying vec4 v_color;\t\t\t\tvoid main() {\t\t\t\t\tgl_Position = u_projMatrix * u_mvMatrix * vec4(a_pos,1.0);\t\t\t\t\tv_color = a_color;\t\t\t\t}",defaultFShader:"\t\t\t\tprecision mediump float;\t\t\t\tvarying vec4 v_color;\t\t\t\tvoid main() {\t\t\t\t\tgl_FragColor = v_color;\t\t\t\t\tgl_FragColor.a = 1.0;\t\t\t\t}"},techniques:{defaultTechnique:[{vshader:"defaultVShader",
fshader:"defaultFShader",attributes:{a_pos:{type:"vec3"},a_color:{type:"vec4"}},params:{u_projMat:{type:"mat4"},u_viewMat:{type:"mat4"}}}]}};this.shader.init()};renderDebug.prototype.hide=function(){this.hidden=!0};renderDebug.prototype.show=function(){this.hidden=!1};renderDebug.prototype.line=function(a,b,f,g){this.hidden||(f==void 0&&(f=[1,1,1,1]),g==void 0&&(g=f),this.lineBuffer.push([a,b,f,g]))};
renderDebug.prototype.box=function(a,b,f){this.line([a[0],a[1],a[2]],[b[0],a[1],a[2]],f,f);this.line([b[0],a[1],a[2]],[b[0],b[1],a[2]],f,f);this.line([b[0],b[1],a[2]],[a[0],b[1],a[2]],f,f);this.line([a[0],b[1],a[2]],[a[0],a[1],a[2]],f,f);this.line([a[0],a[1],b[2]],[b[0],a[1],b[2]],f,f);this.line([b[0],a[1],b[2]],[b[0],b[1],b[2]],f,f);this.line([b[0],b[1],b[2]],[a[0],b[1],b[2]],f,f);this.line([a[0],b[1],b[2]],[a[0],a[1],b[2]],f,f);this.line([b[0],a[1],a[2]],[b[0],a[1],b[2]],f,f);this.line([b[0],b[1],
a[2]],[b[0],b[1],b[2]],f,f);this.line([a[0],b[1],a[2]],[a[0],b[1],b[2]],f,f);this.line([a[0],a[1],a[2]],[a[0],a[1],b[2]],f,f)};renderDebug.prototype.frustum=function(a,b){this.line(a[0],a[1],b,b);this.line(a[1],a[2],b,b);this.line(a[2],a[3],b,b);this.line(a[3],a[4],b,b);this.line(a[4],a[5],b,b);this.line(a[5],a[6],b,b);this.line(a[6],a[7],b,b)};
renderDebug.prototype.sphere=function(a,b,f){for(var g=0,h=Math.PI/8,l=0,n=2*Math.PI/8;g<Math.PI;){for(var o=Math.sin(g),p=Math.cos(g);l<2*Math.PI;){var q=Math.sin(l),r=Math.cos(l),s=a[0]+r*o*b,u=a[1]+p*b,v=a[2]+q*o*b;l+=n;var q=Math.sin(l),r=Math.cos(l),r=a[0]+r*o*b,x=a[1]+p*b,q=a[2]+q*o*b;l+=n;this.line([s,u,v],[r,x,q],f)}g+=h}};
renderDebug.prototype.flush=function(){var a=0,b=this.renderer.cameraManager().getActiveCamera();mat4.inplace_copy(this.ctx.projectionMatrix,b.proj);for(mat4.inplace_copy(this.ctx.mvMatrix,b.view);this.lineBuffer.length>0;)for(var b=Math.min(this.lineBuffer.length,this.maxLines),f=0;b>0;){var g=this.lineBuffer.shift(),h=f*6,l=f*8;this.posBufferData[h+0]=g[0][0];this.posBufferData[h+1]=g[0][1];this.posBufferData[h+2]=g[0][2];this.posBufferData[h+3]=g[1][0];this.posBufferData[h+4]=g[1][1];this.posBufferData[h+
5]=g[1][2];this.colorBufferData[l+0]=g[2][0];this.colorBufferData[l+1]=g[2][1];this.colorBufferData[l+2]=g[2][2];this.colorBufferData[l+3]=g[2][3];this.colorBufferData[l+4]=g[3][0];this.colorBufferData[l+5]=g[3][1];this.colorBufferData[l+6]=g[3][2];this.colorBufferData[l+7]=g[3][3];b--;f++;if(b<=0){this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.posBufferObject);this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,null);this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,this.posBufferData);this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,
this.colorBufferObject);this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,null);this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,this.colorBufferData);this.ctx.disable(this.ctx.DEPTH_TEST);this.shader.begin();this.shader.beginPass(0);this.ctx.enableVertexAttribArray(0);this.ctx.enableVertexAttribArray(1);this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.posBufferObject);this.ctx.vertexAttribPointer(0,3,this.ctx.FLOAT,!1,0,0);this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.colorBufferObject);this.ctx.vertexAttribPointer(1,
4,this.ctx.FLOAT,!1,0,0);this.ctx.drawArrays(this.ctx.LINES,0,f*2);this.shader.endPass();this.shader.end();this.ctx.enable(this.ctx.DEPTH_TEST);a++;this.ctx.finish();this.ctx.flush();break}}};renderUtils={createBox:function(){var a=g_Engine.getContext().renderer,b=new rdgePrimitiveDefinition;b.vertexDefinition={vert:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},a_pos:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},normal:{type:rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},a_nrm:{type:rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},
texcoord:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:rdgeConstants.BUFFER_STATIC},a_uv:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:rdgeConstants.BUFFER_STATIC}};b.bufferStreams=[[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,
0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]];b.streamUsage=[rdgeConstants.BUFFER_STATIC,rdgeConstants.BUFFER_STATIC,rdgeConstants.BUFFER_STATIC];b.indexUsage=rdgeConstants.BUFFER_STREAM;b.indexBuffer=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];b.type=rdgeConstants.TRIANGLES;a.createPrimitive(b);return b}};
function makeSphere(a,b,f,g){for(var h=[],l=[],n=[],o=[],p=0;p<=f;++p)for(var q=0;q<=g;++q){var r=p*Math.PI/f,s=q*2*Math.PI/g,u=Math.sin(r),v=Math.sin(s),r=Math.cos(r),s=Math.cos(s)*u;u*=v;var v=1-q/g,x=p/f;l.push(s);l.push(r);l.push(u);n.push(v);n.push(x);h.push(b*s);h.push(b*r);h.push(b*u)}for(p=0;p<f;++p)for(q=0;q<g;++q)b=p*(g+1)+q,s=b+g+1,o.push(b),o.push(s),o.push(b+1),o.push(s),o.push(s+1),o.push(b+1);f={};f.normalObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f.normalObject);a.bufferData(a.ARRAY_BUFFER,
new Float32Array(l),a.STATIC_DRAW);f.texCoordObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f.texCoordObject);a.bufferData(a.ARRAY_BUFFER,new Float32Array(n),a.STATIC_DRAW);f.vertexObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,f.vertexObject);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);f.numIndices=o.length;f.indexObject=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f.indexObject);a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),a.STREAM_DRAW);return f}
function createPlane(a,b,f,g,h,l,n){for(var o=g_Engine.getContext().renderer,p=Array(a*b*3),q=Array(a*b*3),r=Array(a*b*2),s=Array(a*b),u=0,v=0,x=0;x<b;++x)for(var w=0;w<a;++w)p[u]=w*f-(a-1)*f*0.5,p[u+1]=0,p[u+2]=x*g-(b-1)*g*0.5,q[u]=n[0],q[u+1]=n[1],q[u+2]=n[2],r[v]=w/a*h,r[v+1]=x/b*l,u+=3,v+=2;for(x=f=0;x<b;++x)for(w=0;w<a;++w)s[f+2]=x*a+w,s[f+1]=x*a+(w+1),s[f]=(x+1)*a+w,s[f+5]=(x+1)*a+w,s[f+4]=x*a+(w+1),s[f+3]=(x+1)*a+(w+1),f+=6;a=new rdgePrimitiveDefinition;a.vertexDefinition={vert:{type:rdgeConstants.VS_ELEMENT_POS,
bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},a_pos:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},normal:{type:rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},a_nrm:{type:rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},texcoord:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:rdgeConstants.BUFFER_STATIC},a_uv:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,
bufferUsage:rdgeConstants.BUFFER_STATIC}};a.bufferStreams=[p,q,r];a.streamUsage=[rdgeConstants.BUFFER_STATIC,rdgeConstants.BUFFER_STATIC,rdgeConstants.BUFFER_STATIC];a.indexUsage=rdgeConstants.BUFFER_STREAM;a.indexBuffer=s;a.type=rdgeConstants.TRIANGLES;o.createPrimitive(a);return a}
function createCubeVolume(a,b,f,g,h,l,n){for(var o=g_Engine.getContext().renderer,p=Array(a*f*b*3),q=Array(a*f*b),r=0,s=0,u=0;u<b;++u)for(var v=0;v<f;++v)for(var x=0;x<a;++x)p[r]=x*g-(a-1)*g*0.5,p[r+1]=u*h-(b-1)*h*0.5,p[r+2]=v*l-(f-1)*l*0.5,r+=3,q.push(s++);n&&p.slice();a=new rdgePrimitiveDefinition;a.vertexDefinition={a_pos:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC}};a.bufferStreams=[p];a.streamUsage=[rdgeConstants.BUFFER_DYNAMIC];a.indexUsage=rdgeConstants.BUFFER_STREAM;
a.indexBuffer=q;a.type=rdgeConstants.POINTS;a.useDoubleBuffer=!0;o.createPrimitive(a);return a}
function createScreenAlignedQuad(){var a=g_Engine.getContext().renderer,b=new rdgePrimitiveDefinition;b.vertexDefinition={vert:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},a_pos:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},texcoord:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},a_uv:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC}};
b.bufferStreams=[[-1,1,0,1,1,0,-1,-1,0,-1,-1,0,1,1,0,1,-1,0],[0,0,0,1,1,1,1,1,1,0,0,0]];b.streamUsage=[rdgeConstants.BUFFER_STATIC,rdgeConstants.BUFFER_STATIC];b.type=rdgeConstants.TRIANGLES;a.createPrimitive(b);return b};bindMap={"int":function(a,b,f){a.uniform1iv(b,f)},"float":function(a,b,f){a.uniform1fv(b,f)},vec2:function(a,b,f){a.uniform2fv(b,f)},vec3:function(a,b,f){a.uniform3fv(b,f)},vec4:function(a,b,f){a.uniform4fv(b,f)},mat3:function(a,b,f){a.uniformMatrix3fv(b,!1,f)},mat4:function(a,b,f){a.uniformMatrix4fv(b,!1,f);g_Engine.getContext().debug.mat4CallCount++},tex2d:function(a,b,f){a.activeTexture(a.TEXTURE0+f[0]);a.bindTexture(a.TEXTURE_2D,f[1]);a.uniform1iv(b,[f[0]])},texCube:function(a,b,f){a.activeTexture(a.TEXTURE0+
f[0]);a.bindTexture(a.TEXTURE_CUBE_MAP,f[1]);a.uniform1iv(b,[f[0]])}};lightDataMap=[function(a,b,f){a.uniform3fv(b,f.position)},function(a,b,f){a.uniform4fv(b,f.lightDiffuse)},function(a,b,f){a.uniform4fv(b,f.lightAmbient)},function(a,b,f){a.uniform4fv(b,f.lightSpecular)}];paramTypeNameMapping=null;
jshader=function(a){this.name=a;this.def=null;this.technique={};this.params={};this.compiledShaders={};this.resetRS=!1;this.currentPass=0;this.type_jshader={};this.global={};this.renderer=g_Engine.getContext().renderer;this.ctx=this.renderer.ctx;if(a!=void 0&&a!=null)request=new XMLHttpRequest,request.open("GET",a,!1),request.send(null),this.def=JSON.parse(request.responseText);if(!paramTypeNameMapping)a=this.ctx,paramTypeNameMapping={},paramTypeNameMapping[a.BOOL]="bool",paramTypeNameMapping[a.INT]=
"int",paramTypeNameMapping[a.FLOAT]="float",paramTypeNameMapping[a.FLOAT_VEC2]="vec2",paramTypeNameMapping[a.FLOAT_VEC3]="vec3",paramTypeNameMapping[a.FLOAT_VEC4]="vec4",paramTypeNameMapping[a.INT_VEC2]="vec2",paramTypeNameMapping[a.INT_VEC3]="vec3",paramTypeNameMapping[a.INT_VEC4]="vec4",paramTypeNameMapping[a.BOOL_VEC2]="vec2",paramTypeNameMapping[a.BOOL_VEC3]="vec3",paramTypeNameMapping[a.BOOL_VEC4]="vec4",paramTypeNameMapping[a.FLOAT_MAT2]="mat2",paramTypeNameMapping[a.FLOAT_MAT3]="mat3",paramTypeNameMapping[a.FLOAT_MAT4]=
"mat4",paramTypeNameMapping[a.SAMPLER_2D]="tex2d",paramTypeNameMapping[a.SAMPLER_CUBE]="texCube";this.bindParameters=function(a){for(var f=a.defParamsList,g=a.lightParams,h=a.lightContext,l=f.length,n=0,o=Array(2),p=0,n=0;n<l;++n)if(f[n].type=="tex2d"||f[n].type=="texCube")o[0]=p++,o[1]=f[n].data[0],bindMap[f[n].type](this.ctx,f[n].loc,o);else bindMap[f[n].type](this.ctx,f[n].loc,rdgeGlobalParameters[f[n].name].data);f=rdgeConstants.MAX_MATERIAL_LIGHTS;for(l=0;l<f;++l)if(h[l]!=null&&g[l]){n=g[l].length;
for(p=0;p<n;++p)lightDataMap[g[l][p].dataIndex](this.ctx,g[l][p].loc,h[l])}p=this.renderer.usedTextureUnits;f=a.paramsList;l=f.length;for(n=0;n<l;++n)if(f[n].type=="tex2d"||f[n].type=="texCube")o[0]=p++,o[1]=f[n].data[0],bindMap[f[n].type](this.ctx,f[n].loc,o);else bindMap[f[n].type](this.ctx,f[n].loc,f[n].data)};createJShaderTexture=function(a,f){var g=null,g=typeof f.data=="string"?a.canvas.renderer.getTextureByName(f.data,f.wrap,f.repeat,f.mips):a.canvas.renderer.getTextureByName(f.data.lookUpName,
f.wrap,f.repeat,f.mips);return[g]};paramType=function(a,f,g,h,l){this.loc=a.getUniformLocation(h,f);this.loc==null&&window.console.log("ctx:"+a.canvas.id+", technique: "+l+", uniform: "+f+" was not found, jshader param will have no affect");f=g[f];this.type=f.type;if(f.data==void 0)switch(f.type){case "vec4":this.data=vec4.zero();break;case "vec3":this.data=vec3.zero();break;case "vec2":this.data=vec2.zero();break;case "mat4":this.data=mat4.zero();break;case "mat3":this.data=Array(9);break;case "mat2":this.data=
[0,0,0,0];break;case "float":this.data=[0];break;case "int":this.data=[0];break;case "tex2d":this.data=[a.canvas.renderer.getTextureByName("assets/images/white.png")];break;case "texCube":this.data=[a.canvas.renderer.getTextureByName("assets/images/white.png")]}else this.data=f.type=="tex2d"||f.type=="texCube"?createJShaderTexture(a,f):f.data.slice();this.get=function(){return this.data.slice()};this.set=function(f){if(this.type=="tex2d"||this.type=="texCube")typeof f=="string"&&(f=a.canvas.renderer.getTextureByName(f)),
this.data[0]=f;else for(var g=this.data.length,h=0;h<g;++h)this.data[h]=f[h]}};globalParam=function(a,f,g,h){this.type=g.type;this.data=g.data;this.loc=a.getUniformLocation(h,f);if(this.data)this.data=g.type=="tex2d"||g.type=="texCube"?createJShaderTexture(a,g):g.data.slice();else switch(g.type){case "vec4":this.data=vec4.zero();break;case "vec3":this.data=vec3.zero();break;case "vec2":this.data=vec2.zero();break;case "mat4":this.data=mat4.zero();break;case "mat3":this.data=Array(9);break;case "mat2":this.data=
[0,0,0,0];break;case "float":this.data=[0];break;case "int":this.data=[0];break;case "tex2d":this.data=[a.canvas.renderer.getTextureByName("assets/images/white.png")];break;case "texCube":this.data=[a.canvas.renderer.getTextureByName("assets/images/white.png")]}this.get=function(){return this.data.slice()};this.set=function(f){if(this.type=="tex2d"||this.type=="texCube")typeof f=="string"&&(f=a.canvas.renderer.getTextureByName(f)),this.data[0]=f;else for(var g=this.data.length,h=0;h<g;++h)this.data[h]=
f[h]}};this.init=function(){var a=this.def.techniques,f=null;for(t in a){var f=t,g=a[t];this[t]={passes:[]};for(var h=g.length,l=0;l<h;){var n=this.buildProgram(g[l]);this.ctx.useProgram(n);var o=this.ctx.getProgramParameter(n,this.ctx.ACTIVE_ATTRIBUTES);for(j=0;j<o;++j){var p=this.ctx.getActiveAttrib(n,j);g[l].attributes[p.name]={type:paramTypeNameMapping[p.type]}}o=this.ctx.getProgramParameter(n,this.ctx.ACTIVE_UNIFORMS);for(j=0;j<o;++j)p=this.ctx.getActiveUniform(n,j),rdgeGlobalParameters[p.name]||
(g[l].params[p.name]={type:paramTypeNameMapping[p.type]});n.ctxId=this.ctx.canvas.id;if(n)this[t].passes.push({program:n,params:{},defParams:{},states:g[l].states,attributes:g[l].attribPairs});else{this.renderer.console.log("Build errors found in technique: "+t);this.def[t]=null;break}for(var q in rdgeGlobalParameters)if(o=new globalParam(this.ctx,q,rdgeGlobalParameters[q],n),o.loc!=null)o.loc.ctxID=this.ctx.canvas.id,this[t].passes[l].defParams[q]=o,this.global[q]=o;this[t].passes[l].lightParams=
[null,null,null,null];this[t].passes[l].lightContext=[null,null,null,null];if(!this[t].passes[l].paramsList)this[t].passes[l].paramsList=[];o=rdgeConstants.MAX_MATERIAL_LIGHTS;for(p=0;p<o;++p){this[t].passes[l].lightParams[p]=null;var r=0,s;for(s in g_Engine.lightManager.lightUniforms[p])loc=this.ctx.getUniformLocation(n,s),loc!=null&&(this[t].passes[l].lightParams[p]||(this[t].passes[l].lightParams[p]=[]),this[t].passes[l].lightParams[p].push({loc:loc,name:s,dataIndex:r})),r++}for(q in g[l].params)typeof g[l].params[q]!=
"string"&&(o=new paramType(this.ctx,q,g[l].params,n,t),this[t].passes[l].params[q]=o,this[t][q]=o);for(q in g[l].params)typeof g[l].params[q]=="string"&&(this[t][q]=this[t].passes[l].params[q]);l++}}for(t in a){h=this[t].passes.length;for(l=0;l<h;++l){this[t].passes[l].defParamsList=[];for(q in this[t].passes[l].params)g=this[t].passes[l].params[q],g.name=q,this[t].passes[l].paramsList.push(g);for(q in this[t].passes[l].defParams)g=this[t].passes[l].defParams[q],g.name=q,this[t].passes[l].defParamsList.push(g)}}this.setTechnique(f)};
this.initLocalParameter=function(a,f){var g=this.def.techniques;for(t in g)for(var h=g[t],l=h.length,n=0;n<l;){var o=new paramType(this.ctx,a,f,h[n].program,t);if(o){h[n][a]=o;if(!h[n].paramsList)h[n].paramsList=[];h[n].paramsList.push(o)}n++}};this.buildShader=function(a,f){var g="#define PC\n";g+=f;f=g;g=this.ctx.createShader(a);if(g==null)return this.renderer.console.log("*** Error: unable to create shader '"+a+"'"),null;this.ctx.shaderSource(g,f);this.ctx.compileShader(g);if(!this.ctx.getShaderParameter(g,
this.ctx.COMPILE_STATUS)){var h=this.ctx.getShaderInfoLog(g);window.console.error("*** Error compiling shader '"+a+"':"+h);this.ctx.deleteShader(g);return null}return g};this.buildProgram=function(a){window.console.log("building shader pair: <"+a.vshader+", "+a.fshader+">");var f=this.def.shaders[a.vshader],g=this.def.shaders[a.fshader];this.ctx.useProgram(null);var h=null,l=null;f.indexOf("{")!=-1?l=f:(l=new XMLHttpRequest,l.open("GET",f,!1),l.send(null),l=l.responseText);h=this.buildShader(this.ctx.VERTEX_SHADER,
l);l=null;f.indexOf("{")!=-1?l=g:(l=new XMLHttpRequest,l.open("GET",g,!1),l.send(null),l=l.responseText);l=this.buildShader(this.ctx.FRAGMENT_SHADER,l);if(!h||!l)return null;this.compiledShaders[a.vshader]=h;this.compiledShaders[a.fshader]=l;f=this.ctx.createProgram();if(!f)return null;this.ctx.attachShader(f,h);this.ctx.attachShader(f,l);g=0;a.attribPairs=[];for(var n in a.attributes)a.attribPairs.push({loc:g,name:n}),this.ctx.bindAttribLocation(f,g++,n);this.ctx.linkProgram(f);return!this.ctx.getProgramParameter(f,
this.ctx.LINK_STATUS)?(a=this.ctx.getProgramInfoLog(f),window.console.log("Error in program linking:"+a),this.ctx.deleteProgram(f),this.ctx.deleteProgram(l),this.ctx.deleteProgram(h),null):f};this.setLightContext=function(a){for(t in this.technique)for(var f=this.technique.passes.length,g=0;g<f;++g)this.technique.passes[g].lightContext=a.slice()};this.setTextureContext=function(a){for(var f=this.technique.passes.length,g=null,h=0,l=a.length;h<l;++h)for(var n=0;n<f;++n)g=a[h],this.technique.passes[n].defParams[g.name]&&
this.technique.passes[n].defParams[g.name].set(g.handle),this.technique.passes[n].params[g.name]&&this.technique.passes[n].params[g.name].set(g.data[0])};this.setTechnique=function(a){if(this[a]!=void 0)return this.technique=this[a],!0;this.ctx.console.log("Failed to set technique:"+a);return!1};this.beginRenderState=function(a){var f=this.technique.passes[a].states;if(f!=void 0){(f.depthEnable!=void 0?f.depthEnable:1)?(f.depthFunc&&this.ctx.depthFunc(this.ctx[f.depthFunc]),f.offset&&(this.ctx.enable(this.ctx.POLYGON_OFFSET_FILL),
this.ctx.polygonOffset(f.offset[0],f.offset[1])),f.depthWrite&&this.ctx.depthMask(f.depthWrite),f.depthRangeMin&&this.ctx.depthRange(f.depthRangeMin),f.depthRangeMax&&this.ctx.depthRange(f.depthRangeMax)):(this.ctx.disable(this.ctx.DEPTH_TEST),this.ctx.depthFunc(this.ctx[f.depthFunc]),this.ctx.depthMask(!0));if(f.blendEnable!=void 0&&f.blendEnable){var g=f.srcBlend!=void 0?f.srcBlend:"ONE",h=f.dstBlend!=void 0?f.dstBlend:"ZERO";this.ctx.enable(this.ctx.BLEND);this.ctx.blendFunc(this.ctx[g],this.ctx[h])}f.culling&&
(f.culling?this.ctx.enable(this.ctx.CULL_FACE):this.ctx.disable(this.ctx.CULL_FACE));f.cullFace&&this.ctx.cullFace(this.ctx[f.cullFace]);f.pointsprite&&(f.pointsprite===!0?this.renderer.enablePointSprites():this.renderer.disablePointSprites());this.resetRS=this.technique.passes[a].states.reset==void 0||this.technique.passes[a].states.reset==!0}};this.endRenderState=function(){var a=this.ctx;this.resetRS&&(a.enable(this.ctx.DEPTH_TEST),a.disable(this.ctx.BLEND),a.depthFunc(this.ctx.LESS),a.disable(this.ctx.POLYGON_OFFSET_FILL),
a.disable(this.ctx.CULL_FACE))};this.begin=function(){this.currentPass=null;return this.def==null||this.technique==null?0:this.technique.passes.length};this.beginPass=function(a){this.currentPass=this.technique.passes[a];this.ctx.useProgram(this.currentPass.program);this.bindParameters(this.currentPass);this.beginRenderState(a);return this.currentPass};this.endPass=function(){this.endRenderState();this.ctx.useProgram(null)};this.end=function(){};this.exportShader=function(){for(t in this.def.techniques)for(var a=
this[t].passes.length,f=0;f<a;++f){this[t].passes[f].paramsList=[];this[t].passes[f].defParamsList=[];for(var g in this[t].passes[f].params){var h=this.def.techniques[t][f];if(h&&this[t].passes[f].params[g].type!="tex2d"&&this[t].passes[f].params[g]!="texCube")h.params[g].data=this[t].passes[f].params[g].data}}return JSON.stringify(this.def)}};jpassGeoSet={BACKGROUND:1,OPAQUE:2,TRANSPARENT:4,ADDITIVE:8,TRANSLUCENT:16,FOREGROUND:32,ALL:127,SCREEN_QUAD:128,SHADOW:256,MAXSETS:9};
_jpassBaseClass=function(){this.context=g_Engine.getContext();this.renderer=g_Engine.getContext().renderer;this.sortCats=rdgeConstants.categoryEnumeration;this.bucketCount=rdgeConstants.categoryEnumeration.MAX_CAT;this.renderOrder=[];this.renderOrder[this.sortCats.BACKGROUND]=0;this.renderOrder[this.sortCats.OPAQUE]=1;this.renderOrder[this.sortCats.TRANSPARENT]=2;this.renderOrder[this.sortCats.ADDITIVE]=3;this.renderOrder[this.sortCats.TRANSLUCENT]=4;this.renderOrder[this.sortCats.FOREGROUND]=5;this.name=
"renderPass_"+nodeIdGen.getId();this.visibility=1;this.onHide=function(){};this.hidePass=function(){this.onHide();for(var a=0,b=this.children.length;a<b;++a)this.children[a].hidePass()};this.defaultTargetOut={};this.outputs=[];this.dirty=!1;this.outputIndex=0;this.inputs=[];this.textures=[];this.frustum_culling="enable";this.clearColor=this.clear=null;this.renderList=[];this.children=[];this.technique=this.shader=null;this.geometrySet="SCREEN_QUAD";this.camera=null;this.init=function(){};this.insertChildPass=
function(a){this.children[a.name]=a};this.process=function(){var a,b,f,g,h,l,n,o=0,p=0,q=l=0,r=g_Engine.getContext().renderer;this.bindOutput();this.preRender();var s=r.cameraManager().getActiveCamera();this.technique&&this.shader.setTechnique(this.technique);r.projectionMatrix=s.proj;rdgeGlobalParameters.u_inv_viewport_width.set([1/r.vpWidth]);rdgeGlobalParameters.u_inv_viewport_height.set([1/r.vpHeight]);rdgeGlobalParameters.u_farZ.set([s.zFar()]);rdgeGlobalParameters.u_projMatrix.set(r.projectionMatrix);
for(var u=0,v=this.renderList.length;u<v;++u){f=this.renderList[u].length;for(o=0;o<f;++o)if(h=this.renderList[u][o].node,h.world){a=this.renderList[u][o].context;b=this.shader?this.shader:a.shaderProg;r.mvMatrix=mat4.mul4x3(h.world,s.view);r.invMvMatrix=mat4.inverse(r.mvMatrix);r.normalMatrix=mat4.transpose(r.invMvMatrix);rdgeGlobalParameters.u_mvMatrix.set(r.mvMatrix);rdgeGlobalParameters.u_normalMatrix.set(r.normalMatrix);rdgeGlobalParameters.u_worldMatrix.set(h.world);rdgeGlobalParameters.u_viewMatrix.set(s.view);
rdgeGlobalParameters.u_invViewMatrix.set(mat4.inverse(s.view));rdgeGlobalParameters.u_invMvMatrix.set(r.invMvMatrix);g=a.uniforms.length;for(l=0;l<g;++l)rdgeGlobalParameters[a.uniforms[l].name].set(a.uniforms[l].value);this.updateTextureContext(a.textureList);b.setLightContext(a.lights);b.setTextureContext(a.textureList);a=b.begin();for(q=0;q<a;++q){g=b.beginPass(q);n=h.meshes.length;for(p=0;p<n;++p)(l=g_meshMan.getModelByName(h.meshes[p].mesh.name))&&r.drawPrimitive(l.primitive,g.program,g.attributes);
b.endPass();this.onPassEnd()}b.end()}}this.postRender();this.unbindOutput()};this.preRender=function(){};this.postRender=function(){};this.onPassEnd=function(){this.outputIndex+1<this.outputs.length&&++this.outputIndex};this.setRenderList=function(a){this.renderList=a};this.setInputs=function(a){this.inputs=a.slice()};this.updateTextureContext=function(a){for(var b=this.inputs.slice(),f=0;f<this.inputs.length;++f)a.push(b[f]);for(f=0;f<this.textures.length;++f)this.textures[f].enabled&&a.push(this.textures[f])};
this.bindOutput=function(){this.outputIndex=0;if(this.outputs[this.outputIndex]){this.dirty=!0;var a=null,b=this.outputs[this.outputIndex].data[0].frameBuffer;this.renderer.ctx.bindFramebuffer(this.renderer.ctx.FRAMEBUFFER,b);this.renderer.ctx.viewport(0,0,b.width,b.height);if(this.clearColor)a=this.renderer.clearColor,this.renderer.setClearColor(this.clearColor);this.clear?this.renderer.clear(this.clear):this.renderer._clear();this.clearColor&&this.renderer.setClearColor(a)}};this.unbindOutput=function(){if(this.dirty)this.dirty=
!1,this.renderer.ctx.bindFramebuffer(this.renderer.ctx.FRAMEBUFFER,null),this.renderer.setViewPort(0,0,this.renderer.vpWidth,this.renderer.vpHeight)}};
jpass=function(a){this.inheritedFrom=_jpassBaseClass;this.inheritedFrom();for(var b in a)if(this[b]=a[b],b=="children")for(var f=this[b].length,g=0;g<f;++g)this[b][g]=new jpass(this[b][g]);else if(b=="inputs"||b=="outputs"){this[b].slice()||(this[b]=[this[b]]);f=this[b].length;for(g=0;g<f;++g){if(!this[b][g].data)this[b][g].data=this[b][g].type=="target"?[this.renderer.createRenderTargetTexture(this[b][g].name,this[b][g].width,this[b][g].height,this[b][g].mips)]:[null];if(!this[b][g].handle)this[b][g].handle=
this[b][g].data[0]}}else if("renderList"==b){f=Array(rdgeConstants.categoryEnumeration.MAX_CAT);f[rdgeConstants.categoryEnumeration.BACKGROUND]=[];f[rdgeConstants.categoryEnumeration.OPAQUE]=[];f[rdgeConstants.categoryEnumeration.TRANSPARENT]=[];f[rdgeConstants.categoryEnumeration.ADDITIVE]=[];f[rdgeConstants.categoryEnumeration.TRANSLUCENT]=[];f[rdgeConstants.categoryEnumeration.FOREGROUND]=[];for(var h in this[b])for(var l=rdgeConstants.categoryEnumeration[h],n=this[b][h].length,g=0;g<n;++g)f[l].push(this[b][h][g]);
this[b]=f}else if("shader"==b)typeof this[b]=="string"?this.shader=new jshader(this[b]):(g=new jshader,g.def=this[b],g.init(),this[b]=g);else if("geometrySet"==b){if(typeof this[b]=="string"){f=this[b].split("|");for(g=l=0;g<f.length;++g)if(l|=jpassGeoSet[f[g]],f[g]==="SCREEN_QUAD"){this[b]=jpassGeoSet[f[g]];this.renderList[0]=[new renderObject(createScreenQuadNode())];break}this[b]=l}}else if("textures"==b){g=0;for(n=this[b].length;g<n;++g)typeof this[b][g].data=="string"?(this[b][g].name=this[b][g].data,
this[b][g].data=[this[b][g].data],this[b][g].enabled=!0):this[b][g].name=this.renderer.getTextureByName(this[b][g].data[0].lookUpName)}this.init()};
jpassGraph=function(a){this.root=null;if(!(a&&typeof a=="string"))this.root=a?new jpass(a):new jpass({});this.insert=this.find=null;this.OPAQUE=rdgeConstants.categoryEnumeration.OPAQUE;this.setPassRoot=function(a){this.root=a};this._initHelper=function(a){if(a){this[a.name]=a;for(var b in a.children)this._initHelper(a.children[b])}};this._initHelper(this.root);this.insertAsChild=function(a,b){this.find=a;this.insert=b;this[b.name]=b;this._insertHelper(this.root);this.insert=this.find=null};this._insertHelper=
function(a){if(!a)return!1;if(a.name==this.find)return a.insertChildPass(this.insert),!0;for(var b in a.children)if(this._insertHelper(a.children[b]))break;return!0};this.geoSetMap=[];var a=0,b;for(b in jpassGeoSet)this.geoSetMap[a++]=jpassGeoSet[b];this.render=function(a){g_renderStats.numPasses.value=0;var b=a.renderList,h=g_Engine.getContext().renderer;this.root.setRenderList(b);for(var l=null,n=[{parent:this.root}],o=null,p=this.geoSetMap.length,q=0,r=0;n.length;){o=n.shift().parent;if(a.shadowsEnabled&&
o.geometrySet===jpassGeoSet.SHADOW)o.setRenderList([a.shadowRenderList]);else if(o.geometrySet===jpassGeoSet.SCREEN_QUAD)o.renderList[0][0].context.textureList=[];else{l=[];for(q=r=0;q<p;++q)o.geometrySet&this.geoSetMap[q]&&b[q]&&(l[r++]=b[q]);o.setRenderList(l)}o.camera&&h.cameraManager().pushCamera(o.camera);g_renderStats.numPasses.value++;o.process();o.camera&&h.cameraManager().popCamera();for(q=o.children.length-1;q>=0;--q)if(o.children[q].visibility===1)o.children[q].setInputs(o.outputs),n.unshift({parent:o.children[q]});
else if(o.children[q].visibility===0)o.children[q].hidePass(),o.children[q].visibility=2}}};function __UNIFORMTYPE(){this.INT=1008;this.FLOAT=1E3;this.FLOAT2=1001;this.FLOAT3=1002;this.FLOAT4=1003;this.MATRIX3=1004;this.MATRIX4=1005;this.TEXTURE2D=1006;this.TEXTURECUBE=1007}UNIFORMTYPE=new __UNIFORMTYPE;function RenderObject(a){this.shader=a;this.world=null;this.bindings=new ShaderData;this.postRenderProc=this.renderProc=this.initRenderProc=null}
RenderObject.prototype.addUniform=function(a,b,f){var g=gl.getUniformLocation(this.shader,a);if(g)g.debugName=a,this.bindings.uniforms.push(new UniformPair(g,b,f))};RenderObject.prototype.addUniformArray=function(a,b,f,g){var h=gl.getUniformLocation(this.shader,a);if(h)for(;0<g;)h.debugName=a+0,this.bindings.uniforms.push(new UniformPair(h,b[0],f)),h+=b[0].length,b++};
RenderObject.prototype.addTexture=function(a,b,f){(a=gl.getUniformLocation(this.shader,a))&&this.bindings.textures.push(new TexUniform(a,b,f))};RenderObject.prototype.addBuffers=function(a,b,f,g,h){f==void 0||g==void 0||h==void 0||f==null||g==null||h==null?this.bindings.buffers.push(new BufferAttrib(a,b,null,null,null)):this.bindings.buffers.push(new BufferAttrib(a,b,f,g,h))};
RenderObject.prototype.bindUniforms=function(){for(var a=0;a<this.bindings.uniforms.length;a++){var b=this.bindings.uniforms[a];switch(b.type){case UNIFORMTYPE.INT:gl.uniform1i(b.uniform,b.value);break;case UNIFORMTYPE.FLOAT:gl.uniform1f(b.uniform,b.value);break;case UNIFORMTYPE.FLOAT2:gl.uniform2fv(b.uniform,b.value);break;case UNIFORMTYPE.FLOAT3:gl.uniform3fv(b.uniform,b.value);break;case UNIFORMTYPE.FLOAT4:gl.uniform4fv(b.uniform,b.value);break;case UNIFORMTYPE.MATRIX3:gl.uniformMatrix3fv(b.uniform,
!1,b.value);break;case UNIFORMTYPE.MATRIX4:gl.uniformMatrix4fv(b.uniform,!1,b.value)}}};RenderObject.prototype.bindTextures=function(){for(var a=0;a<this.bindings.textures.length;a++){var b=this.bindings.textures[a];switch(b.type){case UNIFORMTYPE.TEXTURE2D:gl.activeTexture(gl.TEXTURE0+b.unit);gl.uniform1i(b.uniform,b.unit);break;case UNIFORMTYPE.TEXTURECUBE:gl.activeTexture(gl.TEXTURE0+b.unit),gl.uniform1i(b.uniform,b.unit)}}};
RenderObject.prototype.bindBuffers=function(){for(var a=0;a<this.bindings.buffers.length;a++){var b=this.bindings.buffers[a];gl.bindBuffer(b.glBufferType,b.buffer);b.glAttribType!=null&&(gl.enableVertexAttribArray(b.attribIndex),gl.vertexAttribPointer(b.attribIndex,b.attribSize,b.glAttribType,!1,0,0))}};
RenderObject.prototype.unBindBuffers=function(){for(var a=0;a<this.bindings.buffers.length;a++){var b=this.bindings.buffers[a];b.glAttribType!=null&&gl.disableVertexAttribArray(b.attribIndex);gl.bindBuffer(b.glBufferType,null)}};RenderObject.prototype.initialize=function(a){a(this)};RenderObject.prototype.clear=function(){this.world=mat4.identity();this.bindings=new ShaderData};function ShaderData(){this.uniforms=[];this.textures=[];this.buffers=[]}
function UniformPair(a,b,f){this.uniform=a;this.value=b;this.type=f}function TexUniform(a,b,f){this.uniform=a;this.unit=b;this.type=f}function BufferAttrib(a,b,f,g,h){this.buffer=a;this.glBufferType=b;this.attribSize=f;this.glAttribType=h;this.attribIndex=g}renderProcDefault=__renderProcDefault;postRenderProcDefault=__postRenderProcDefault;renderProcLines=__renderProcLines;renderProcScreenQuad=__renderProcScreenQuad;renderProcDepthMap=__renderProcDepthMap;renderProcShadowReceiver=__renderProcShadowReceiver;
renderProcShadowProjection=__renderProcShadowProjection;function __setActiveTexture(a,b){gl.activeTexture(a);gl.bindTexture(gl.TEXTURE_2D,b)}
function __renderProcDefault(a){var b=g_cameraManager.getActiveCamera();gl.mvMatrix=b.view;gl.mvMatrix=mat4.mul(gl.mvMatrix,a.parentMesh.world);gl.invMvMatrix=mat4.inverse(gl.mvMatrix);gl.normalMatrix=mat4.transpose(gl.invMvMatrix);gl.useProgram(arrayPeek(a.material.shader).shaderHandle);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set1).diff);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set2).diff);gl.activeTexture(gl.TEXTURE2);
gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set1).spec);gl.activeTexture(gl.TEXTURE3);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set2).spec);gl.activeTexture(gl.TEXTURE4);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.env));gl.activeTexture(gl.TEXTURE5);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.envDiff));__setActiveTexture(gl.TEXTURE7,g_cam.stickerTexture[0]);__setActiveTexture(gl.TEXTURE8,g_cam.stickerTexture[1]);__setActiveTexture(gl.TEXTURE9,g_cam.stickerTexture[2]);
__setActiveTexture(gl.TEXTURE10,g_cam.stickerTexture[3]);__setActiveTexture(gl.TEXTURE11,g_cam.stickerTexture[4]);__setActiveTexture(gl.TEXTURE12,g_cam.stickerTexture[5]);__setActiveTexture(gl.TEXTURE13,g_cam.stickerTexture[6]);__setActiveTexture(gl.TEXTURE14,g_cam.stickerTexture[7]);for(b=0;b<8;b++)a.parentMesh.stickers[b].load(g_cam.stickers[b]),a.parentMesh.stickersPos[b].setvec(g_cam.stickersPos[b]);__setActiveTexture(gl.TEXTURE15,arrayPeek(a.material.tex.set1).norm);__setActiveTexture(gl.TEXTURE6,
arrayPeek(a.material.tex.set2).norm);arrayPeek(a.material.renderObj).bindBuffers();arrayPeek(a.material.renderObj).bindTextures();arrayPeek(a.material.renderObj).bindUniforms();gl.drawElements(gl.TRIANGLES,a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2)}function __renderProcLines(a,b,f,g,h){gl.useProgram(a.shader);a.lineColor[0]=b;a.lineColor[1]=f;a.lineColor[2]=g;a.lineColor[3]=h;a.bindBuffers();a.bindUniforms();gl.drawArrays(gl.LINES,0,a.numPoints/3);gl.useProgram(null)}
function __renderProcScreenQuad(a){gl.disable(gl.DEPTH_TEST);gl.useProgram(a.shader);a.renderObj.bindBuffers();a.renderObj.bindTextures();a.renderObj.bindUniforms();gl.bindTexture(gl.TEXTURE_2D,a.texture);gl.drawArrays(gl.TRIANGLES,0,6);gl.useProgram(null);gl.enable(gl.DEPTH_TEST)}function __postRenderProcDefault(a){gl.useProgram(arrayPeek(a.material.renderObj).shader);gl.useProgram(null)}
function __renderProcDepthMap(a){gl.useProgram(g_depthMap.shader);arrayPeek(a.material.renderObj).bindBuffers();g_depthMap.bindUniforms();gl.enable(gl.DEPTH_TEST);gl.enable(gl.CULL_FACE);gl.enable(gl.POLYGON_OFFSET_FILL);gl.cullFace(gl.FRONT);gl.drawElements(gl.TRIANGLES,a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2);gl.cullFace(gl.BACK);gl.disable(gl.POLYGON_OFFSET_FILL);gl.disable(gl.CULL_FACE);gl.useProgram(null)}
function __renderProcShadowReceiver(a){gl.bindFramebuffer(gl.FRAMEBUFFER,a.shadowTarget.frameBuffer);gl.viewport(0,0,a.shadowTarget.frameBuffer.width,a.shadowTarget.frameBuffer.height);gl.clearDepth(g_farZ);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(arrayPeek(a.material.shader).shaderHandle);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,g_depthMap.depthRT);arrayPeek(a.material.renderObj).bindTextures();gl.mvMatrix=mat4.mul(g_defaultView,a.parentMesh.world);arrayPeek(a.material.renderObj).bindUniforms();
error=gl.getError();arrayPeek(a.material.renderObj).bindBuffers();gl.drawElements(gl.TRIANGLES,a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2);gl.useProgram(null);gl.bindTexture(gl.TEXTURE_2D,a.shadowTarget);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,theSceneRTT.frameBuffer);gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height);gl.bindFramebuffer(gl.FRAMEBUFFER,a.shadowTargetFinal.frameBuffer);gl.viewport(0,0,a.shadowTargetFinal.frameBuffer.width,
a.shadowTargetFinal.frameBuffer.height);gl.clearDepth(g_farZ);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);a.screenQuad.setTexture(a.shadowTarget);a.screenQuad.render(renderProcScreenQuad);gl.bindTexture(gl.TEXTURE_2D,a.shadowTargetFinal);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,theSceneRTT.frameBuffer);gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height);gl.bindFramebuffer(gl.FRAMEBUFFER,a.shadowTarget.frameBuffer);
gl.viewport(0,0,a.shadowTarget.frameBuffer.width,a.shadowTarget.frameBuffer.height);gl.clearDepth(g_farZ);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);a.screenQuad.setTexture(a.shadowTargetFinal);a.screenQuad.render(renderProcScreenQuad);gl.bindTexture(gl.TEXTURE_2D,a.shadowTarget);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,theSceneRTT.frameBuffer);gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height)}
function __renderProcShadowProjection(a){gl.useProgram(arrayPeek(a.material.shader).shaderHandle);gl.getError();gl.activeTexture(gl.TEXTURE0);gl.getError(gl.bindTexture(gl.TEXTURE_2D,g_depthMap.shadowTarget));gl.bindTexture(gl.TEXTURE_2D,g_meshMan.getModelByName("backdropReceiver").mesh.shadowToProject);arrayPeek(a.material.renderObj).bindTextures();gl.mvMatrix=mat4.mul(g_defaultView,a.parentMesh.world);arrayPeek(a.material.renderObj).bindUniforms();arrayPeek(a.material.renderObj).bindBuffers();gl.drawElements(gl.TRIANGLES,
a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2);gl.useProgram(null)};renderInitProcDefault=__renderInitProcDefault;renderInitScreenQuad=__renderInitScreenQuad;renderInitProcDepthMap=__renderInitProcDepthMap;renderInitShadowReceiver=__renderInitShadowReceiver;renderInitShadowProjection=__renderInitShadowProjection;
function __renderInitProcDefault(a,b){var f=a.material;f.tex.env.push(arrayPeek(f.shader).envMap);f.tex.envDiff.push(arrayPeek(f.shader).envDiff);gl.useProgram(arrayPeek(f.shader).shaderHandle);arrayPeek(f.renderObj).addTexture("layerMap1",0,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("layerMap2",1,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("colorMeMap1",2,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("colorMeMap2",3,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("envMap",
4,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("envDiff",5,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("normalMap1",15,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("normalMap2",6,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap0",7,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap1",8,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap2",9,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap3",
10,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap4",11,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap5",12,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap6",13,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addTexture("stickerMap7",14,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addUniform("u_normalMatrix",gl.normalMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_invMvMatrix",
gl.invMvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix0",a.parentMesh.stickers[0],UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix1",a.parentMesh.stickers[1],UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix2",a.parentMesh.stickers[2],UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix3",a.parentMesh.stickers[3],UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix4",a.parentMesh.stickers[4],
UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix5",a.parentMesh.stickers[5],UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix6",a.parentMesh.stickers[6],UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerMatrix7",a.parentMesh.stickers[7],UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_stickerPos0",a.parentMesh.stickersPos[0],UNIFORMTYPE.FLOAT3);arrayPeek(f.renderObj).addUniform("u_stickerPos1",a.parentMesh.stickersPos[1],UNIFORMTYPE.FLOAT3);
arrayPeek(f.renderObj).addUniform("u_stickerPos2",a.parentMesh.stickersPos[2],UNIFORMTYPE.FLOAT3);arrayPeek(f.renderObj).addUniform("u_stickerPos3",a.parentMesh.stickersPos[3],UNIFORMTYPE.FLOAT3);arrayPeek(f.renderObj).addUniform("u_stickerPos4",a.parentMesh.stickersPos[4],UNIFORMTYPE.FLOAT3);arrayPeek(f.renderObj).addUniform("u_stickerPos5",a.parentMesh.stickersPos[5],UNIFORMTYPE.FLOAT3);arrayPeek(f.renderObj).addUniform("u_stickerPos6",a.parentMesh.stickersPos[6],UNIFORMTYPE.FLOAT3);arrayPeek(f.renderObj).addUniform("u_stickerPos7",
a.parentMesh.stickersPos[7],UNIFORMTYPE.FLOAT3);arrayPeek(f.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_fillColor1",f.fillColor[0],UNIFORMTYPE.FLOAT4);arrayPeek(f.renderObj).addUniform("u_fillColor2",f.fillColor[1],UNIFORMTYPE.FLOAT4);arrayPeek(f.renderObj).addUniform("u_skinColor",f.fillColor[2],UNIFORMTYPE.FLOAT4);b.vertexObject.name="vertexObject";b.normalObject.name="normalObject";b.texCoordObject.name="texCoordObject";b.indexObject.name=
"indexObject";arrayPeek(f.renderObj).addBuffers(b.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)}
function __renderInitScreenQuad(a,b){a.shader=b==void 0?createShader(gl,"screenQuad_vShader","screenQuad_fShader",["vert","texcoord"]):b;a.renderObj=new RenderObject(a.shader);quadBuf=getScreenAlignedQuad();a.vertBuffer=quadBuf.vertexObject;a.uvBuffer=quadBuf.texCoordObject;a.renderObj.addTexture("basemap",0,UNIFORMTYPE.TEXTURE2D);var f=g_height==0?0:1/g_height;a.renderObj.addUniform("u_inv_viewport_width",g_width==0?0:1/g_width,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_inv_viewport_height",f,
UNIFORMTYPE.FLOAT);a.renderObj.addBuffers(a.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)}function __renderInitProcDepthMap(a){a.shader=g_depthShader.shaderHandle;gl.useProgram(a.shader);a.addUniform("u_mvpLightMatrix",g_mainLight.mvpMatrix,UNIFORMTYPE.MATRIX4);a.bindUniforms();gl.useProgram(null)}
function __renderInitShadowReceiver(a,b){a.shadowTarget=g_texMan.loadRenderTarget("shadowTarget",256,256);a.shadowTargetFinal=g_texMan.loadRenderTarget("shadowTargetFinal",256,256);a.screenQuad=new ScreenQuad(a.shadowTargetFinal);a.screenQuad.initialize(__renderInitRadialBlur);a.parentMesh.shadowToProject=a.shadowTarget;var f=a.material;f.tex.env.push(arrayPeek(f.shader).envMap);f.tex.envDiff.push(arrayPeek(f.shader).envDiff);gl.useProgram(arrayPeek(f.shader).shaderHandle);arrayPeek(f.renderObj).addTexture("shadowMap",
0,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_shadowBiasMatrix",g_mainLight.shadowMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_vShadowLight",g_mainLight.view,UNIFORMTYPE.MATRIX4);b.vertexObject.name="vertexObject";b.normalObject.name="normalObject";b.texCoordObject.name="texCoordObject";b.indexObject.name=
"indexObject";arrayPeek(f.renderObj).addBuffers(b.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)}
function __renderInitShadowProjection(a,b){var f=a.material;gl.useProgram(arrayPeek(f.shader).shaderHandle);arrayPeek(f.renderObj).addTexture("shadowMap",0,UNIFORMTYPE.TEXTURE2D);arrayPeek(f.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_shadowBiasMatrix",g_mainLight.shadowMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(f.renderObj).addUniform("u_vShadowLight",
g_mainLight.view,UNIFORMTYPE.MATRIX4);b.vertexObject.name="vertexObject";b.normalObject.name="normalObject";b.texCoordObject.name="texCoordObject";b.indexObject.name="indexObject";arrayPeek(f.renderObj).addBuffers(b.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(f.renderObj).addBuffers(b.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)}
function __renderInitRadialBlur(a,b){a.shader=b==void 0?createShader(gl,"radialBlur_vshader","radialBlur_fshader",["vert","texcoord"]):b;a.renderObj=new RenderObject(a.shader);quadBuf=getScreenAlignedQuad();a.vertBuffer=quadBuf.vertexObject;a.uvBuffer=quadBuf.texCoordObject;a.renderObj.addTexture("basemap",0,UNIFORMTYPE.TEXTURE2D);a.renderObj.addUniform("u_inv_viewport_width",1/g_width,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_inv_viewport_height",1/g_height,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_sampRadius",
5,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_numSamples",16,UNIFORMTYPE.INT);a.renderObj.addUniform("u_mapSize",256,UNIFORMTYPE.FLOAT);a.renderObj.addBuffers(a.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)};function Model(a,b){this.name=a;this.mesh=b;this.camera=null}function MeshManager(){this.contentUrl="assets_web/mesh/";this.modelMap={};this.readyList=[];this.meshesLoading=!0;this.postMeshLoadCallbackList=[];this.tempSphere=null;this.requestCounter=0}
MeshManager.prototype.loadMesh=function(a,b){if(this.modelMap[a.name]!==void 0)return this.modelMap[a.name];a.ready=!1;a.addr=this.contentUrl+a.name+"_mesh.json";a.ctxID=g_Engine.getContext().renderer.id;if(!b){if(this.tempSphere==null)this.tempSphere=makeSphere(g_Engine.getContext().renderer.ctx,25,5,5);b=this.tempSphere}this.modelMap[a.name]=b;this.requestCounter++;requestMesh(a);return null};
MeshManager.prototype.deleteMesh=function(a){var b=this.modelMap[a];b&&(g_Engine.ctxMan.forEach(function(a){a.renderer.deletePrimitive(b.primitive)}),delete this.modelMap[a])};MeshManager.prototype.getModelByName=function(a){return this.modelMap[a]};MeshManager.prototype.getModelNames=function(){var a=[],b;for(b in this.modelMap)a.push(this.modelList[b].name);return a};
MeshManager.prototype.processMeshData=function(){var a=g_Engine.getContext().renderer,b;for(b in this.readyList)if(this.readyList[b]&&this.readyList[b].ready&&a.id===this.readyList[b].ctxID){var f=this.readyList[b];this.readyList.splice(b,1);var g=new rdgePrimitiveDefinition;g.vertexDefinition={vert:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},a_pos:{type:rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:rdgeConstants.BUFFER_STATIC},normal:{type:rdgeConstants.VS_ELEMENT_FLOAT3,
bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},a_norm:{type:rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},a_normal:{type:rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:rdgeConstants.BUFFER_STATIC},texcoord:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:rdgeConstants.BUFFER_STATIC},a_texcoord:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:rdgeConstants.BUFFER_STATIC},a_texcoords:{type:rdgeConstants.VS_ELEMENT_FLOAT2,
bufferIndex:2,bufferUsage:rdgeConstants.BUFFER_STATIC},a_uv:{type:rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:rdgeConstants.BUFFER_STATIC}};g.bufferStreams=[f.root.data.coords,f.root.data.normals,f.root.data.uvs];g.streamUsage=[rdgeConstants.BUFFER_STATIC,rdgeConstants.BUFFER_STATIC,rdgeConstants.BUFFER_STATIC];g.indexUsage=rdgeConstants.BUFFER_STREAM;g.indexBuffer=f.root.data.indices;a.createPrimitive(g);f.root.primitive=g;f.root.bbox=new box;for(var g=f.root.data.coords.length,h=0;h<
g-2;)f.root.bbox.addVec3([f.root.data.coords[h+0],f.root.data.coords[h+1],f.root.data.coords[h+2]]),h+=3;this.modelMap[f.root.attribs.name]=f.root;this.requestCounter--;this.onLoaded(f.root.attribs.name)}};MeshManager.prototype.isReady=function(){return this.readyList.length==0};MeshManager.prototype.addOnLoadedCallback=function(a){this.postMeshLoadCallbackList.push(a)};MeshManager.prototype.onLoaded=function(a){var b=0;for(b in this.postMeshLoadCallbackList)this.postMeshLoadCallbackList[b].onMeshLoaded(a)};
MeshManager.prototype.exportJSON=function(){for(var a in this.modelMap)this.modelMap[a].primitive.built=!1;return JSON.stringify(this.modelMap)};MeshManager.prototype.importJSON=function(a){try{var b=JSON.parse(a),f;for(f in b)this.modelMap[f]||(this.modelMap[f]=b[f]);window.console.log("meshes imported")}catch(g){window.console.error("error importing meshes: "+g.description)}};
function requestMesh(a){var b=new XMLHttpRequest;b.mesh=a;b.onreadystatechange=function(){if(b.readyState==4)if(b.status==200||window.location.href.indexOf("http")==-1){var a=eval("("+b.responseText+")");a.ready=!0;a.ctxID=b.mesh.ctxID;g_meshMan.readyList.push(a)}else alert("An error has occured making the request")};b.open("GET",a.addr,!0);b.send(null)};function Shader(a,b,f,g,h){this.name=a;this.shaderHandle=b;this.initRenderProc=g;this.renderProc=f;this.postRenderProc=postRenderProcDefault;this.envDiff=this.envMap=h}function ShaderManager(){this.shaderMap=[]}
ShaderManager.prototype.addShader=function(a,b,f,g,h,l,n,o){var p=this.shaderMap[a];return p==void 0?(b=createShader(g_Engine.getContext().renderer.ctx,b,f,g),n!=void 0||o!=void 0?(n=g_texMan.loadMaterial(n),o=g_texMan.loadMaterial(o),this.shaderMap[a]=new Shader(a,b,h,l,n),this.shaderMap[a].envDiff=o):(this.shaderMap[a]=new Shader(a,b,h,l,null),this.shaderMap[a].envDiff=null),this.shaderMap[a].name=a,this.shaderMap[a]):p};
ShaderManager.prototype.getShaderNames=function(){var a=[],b;for(b in this.shaderMap)a.push(this.shaderMap[b].name);return a};ShaderManager.prototype.getShaderByName=function(a){a=this.shaderMap[a];return a!=void 0&&a!=null?a:null};
ShaderManager.prototype.init=function(){this.addShader("default",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_DullPlastic.png","material_DullPlastic.png");this.addShader("barlights",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_barlights.png","material_barlightsDull.png");this.addShader("gloss",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,
"material_gloss.png","material_glossDull.png");this.addShader("inGlass",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_inGlass.png","material_inGlassDull.png");this.addShader("normals",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_normal.png","material_normalDull.png");this.addShader("paint",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,
"material_paint.png","material_paintDull.png");this.addShader("plastic",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_plastic.png","material_plasticDull.png");this.addShader("shadows",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_shadows.png","material_shadowsDull.png");this.addShader("skin",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,
"material_skin.png","material_skinDull.png");this.addShader("wax",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_wax.png","material_waxDull.png");this.addShader("shadowReceiver",shadow_vshader,shadow_fshader,["vert","normal","texcoord"],renderProcShadowReceiver,renderInitShadowReceiver);this.addShader("shadowProj",shadowProj_vshader,shadowProj_fshader,["vert","normal","texcoord"],renderProcShadowProjection,renderInitShadowProjection)};function fxBlur(a,b){var f=["#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec2 vTexcoord;\nuniform vec4 vWeights;",b?"uniform sampler2D sTextureAux;":"","uniform sampler2D sTexture1;",a[0]?"uniform sampler2D sTexture2;":"",a[1]?"uniform sampler2D sTexture3;":"",a[2]?"uniform sampler2D sTexture4;":"","void main()\n{\nvec4 blurCol = vWeights.x * texture2D(sTexture1, vTexcoord, -32.0);",a[0]?"blurCol += vWeights.y * texture2D(sTexture2, vTexcoord, -32.0);":"",a[1]?"blurCol += vWeights.z * texture2D(sTexture3, vTexcoord, -32.0);":
"",a[2]?"blurCol += vWeights.w * texture2D(sTexture4, vTexcoord, -32.0);":"",b?"gl_FragColor = texture2D(sTextureAux, vTexcoord, -32.0) + blurCol;":"gl_FragColor = blurCol;","}"].join("\n"),g=getScreenAlignedQuad(),a=a||[128,64,32];this.fboSet1=[];this.fboSet2=[];for(var h in a)this.fboSet1.push(createRenderTargetTexture(a[h],a[h])),this.fboSet2.push(createRenderTargetTexture(a[h],a[h]));this.blitQuad=new ScreenQuad(null);this.blitQuad.initialize(renderInitScreenQuad);this.blurQuad=new ScreenQuad(null);
this.blurQuad.initialize(function(a){a.shader=createShader(gl,"separableBlur_vshader","separableBlur_fshader",["vert","texcoord"]);a.renderObj=new RenderObject(a.shader);a.vertBuffer=g.vertexObject;a.uvBuffer=g.texCoordObject;a.renderObj.addTexture("sTexture",0,UNIFORMTYPE.TEXTURE2D);a.renderObj.addBuffers(a.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)});this.v3Kernel=[0.3125,0.375,0.3125];this.blurQuad.renderObj.addUniform("vCoeffs",this.v3Kernel,
UNIFORMTYPE.FLOAT3);this.v2Offset=vec2.zero();this.blurQuad.renderObj.addUniform("vOffset",this.v2Offset,UNIFORMTYPE.FLOAT2);this.combineQuad=new ScreenQuad(null);this.combineQuad.initialize(function(a){a.shader=createShader(gl,"separableBlur_vshader",f,["vert","texcoord"]);a.renderObj=new RenderObject(a.shader);a.vertBuffer=g.vertexObject;a.uvBuffer=g.texCoordObject;a.renderObj.addTexture("sTexture1",0,UNIFORMTYPE.TEXTURE2D);a.renderObj.addTexture("sTexture2",1,UNIFORMTYPE.TEXTURE2D);a.renderObj.addTexture("sTexture3",
2,UNIFORMTYPE.TEXTURE2D);a.renderObj.addTexture("sTexture4",3,UNIFORMTYPE.TEXTURE2D);a.renderObj.addTexture("sTextureAux",4,UNIFORMTYPE.TEXTURE2D);a.renderObj.addBuffers(a.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)});this.v4Weights=[0.25,0.25,0.25,0.25];this.combineQuad.renderObj.addUniform("vWeights",this.v4Weights,UNIFORMTYPE.FLOAT4)}
fxBlur.prototype.doBlur=function(a,b,f,g){this.v4Weights[0]=f==void 0?0.25:f[0];this.v4Weights[1]=f==void 0?0.25:f[1];this.v4Weights[2]=f==void 0?0.25:f[2];this.v4Weights[3]=f==void 0?0.25:f[3];for(var f=0,h,l;(h=a)&&(l=this.fboSet2[f]);f++)gl.bindFramebuffer(gl.FRAMEBUFFER,l.frameBuffer),gl.viewport(0,0,l.frameBuffer.width,l.frameBuffer.height),gl.clear(gl.COLOR_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),this.v2Offset[0]=0,this.v2Offset[1]=1.2/l.frameBuffer.width,this.blurQuad.texture=h,renderProcScreenQuad(this.blurQuad);
for(f=0;(h=this.fboSet2[f])&&(l=this.fboSet1[f]);f++)gl.bindFramebuffer(gl.FRAMEBUFFER,l.frameBuffer),gl.viewport(0,0,l.frameBuffer.width,l.frameBuffer.height),gl.clear(gl.COLOR_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),this.v2Offset[0]=1.2/l.frameBuffer.width,this.v2Offset[1]=0,this.blurQuad.texture=h,renderProcScreenQuad(this.blurQuad);gl.bindFramebuffer(gl.FRAMEBUFFER,b?b.frameBuffer:null);gl.viewport(0,0,g_width,g_height);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(gl.DEPTH_TEST);gl.useProgram(this.combineQuad.shader);
this.combineQuad.renderObj.bindBuffers();this.combineQuad.renderObj.bindTextures();this.combineQuad.renderObj.bindUniforms();gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,a);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,this.fboSet1[0]);gl.activeTexture(gl.TEXTURE2);gl.bindTexture(gl.TEXTURE_2D,this.fboSet1[1]);gl.activeTexture(gl.TEXTURE3);gl.bindTexture(gl.TEXTURE_2D,this.fboSet1[2]);gl.activeTexture(gl.TEXTURE4);gl.bindTexture(gl.TEXTURE_2D,g);gl.activeTexture(gl.TEXTURE0);
gl.drawArrays(gl.TRIANGLES,0,6);gl.enable(gl.DEPTH_TEST);gl.useProgram(null);return b};function fxSSAO(a){this.randTexture=createTexture(gl,"assets/images/random_normal.png");gl.bindTexture(gl.TEXTURE_2D,this.randTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);this.enHRDepth=a;this.ssaoQuad=new ScreenQuad(null);this.ssaoQuad.initialize(function(b){b.shader=createShader(gl,"ssao_vshader",a?"ssaohr_fshader":"ssao_fshader",["vert","texcoord"]);
b.renderObj=new RenderObject(b.shader);var f=getScreenAlignedQuad();b.vertBuffer=f.vertexObject;b.uvBuffer=f.texCoordObject;b.renderObj.addTexture("sColMap",0,UNIFORMTYPE.TEXTURE2D);b.renderObj.addTexture("sNormDepthMap",1,UNIFORMTYPE.TEXTURE2D);b.renderObj.addTexture("sRandMap",2,UNIFORMTYPE.TEXTURE2D);a&&b.renderObj.addTexture("sHRDepthMap",3,UNIFORMTYPE.TEXTURE2D);b.renderObj.addBuffers(b.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);b.renderObj.addBuffers(b.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)});
this.v3FrustumFLT=g_cameraManager.getActiveCamera().getFTR();this.ssaoQuad.renderObj.addUniform("u_frustumFLT",this.v3FrustumFLT,UNIFORMTYPE.FLOAT3);this.v4ArtVals=[1,1,1,1];this.ssaoQuad.renderObj.addUniform("u_artVals",this.v4ArtVals,UNIFORMTYPE.FLOAT4);this.fRandMapSize=64;this.ssaoQuad.renderObj.addUniform("u_randMapSize",this.fRandMapSize,UNIFORMTYPE.FLOAT);this.v2ScreenSize=[1024,1024];this.ssaoQuad.renderObj.addUniform("u_screenSize",this.v2ScreenSize,UNIFORMTYPE.FLOAT2)}
fxSSAO.prototype.doSSAO=function(a,b,f,g,h,l,n,o){this.v4ArtVals[0]=h;this.v4ArtVals[1]=l;this.v4ArtVals[2]=n;this.v4ArtVals[3]=o;this.v2ScreenSize[0]=g?g.frameBuffer.width:g_width;this.v2ScreenSize[1]=g?g.frameBuffer.height:g_height;gl.bindFramebuffer(gl.FRAMEBUFFER,g?g.frameBuffer:null);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(gl.DEPTH_TEST);gl.useProgram(this.ssaoQuad.shader);this.ssaoQuad.renderObj.bindBuffers();this.ssaoQuad.renderObj.bindTextures();this.ssaoQuad.renderObj.bindUniforms();gl.activeTexture(gl.TEXTURE0);
gl.bindTexture(gl.TEXTURE_2D,a);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,b);gl.activeTexture(gl.TEXTURE2);gl.bindTexture(gl.TEXTURE_2D,this.randTexture);this.enHRDepth&&(gl.activeTexture(gl.TEXTURE3),gl.bindTexture(gl.TEXTURE_2D,f));gl.activeTexture(gl.TEXTURE0);gl.drawArrays(gl.TRIANGLES,0,6);gl.enable(gl.DEPTH_TEST);gl.useProgram(null);return g};function ScreenQuad(a){this.uvBuffer=this.vertBuffer=null;this.texture=a;this.renderObj=this.shader=null}ScreenQuad.prototype.initialize=function(a,b){a(this,b)};ScreenQuad.prototype.setTexture=function(a){this.texture=a};ScreenQuad.prototype.render=function(a){a(this)};MAX_VAL=1.0E38;function box(){this.min=[MAX_VAL,MAX_VAL,MAX_VAL];this.max=[-MAX_VAL,-MAX_VAL,-MAX_VAL]}box.prototype.addBox=function(a){this.min=vec3.min(this.min,a.min);this.max=vec3.max(this.max,a.max)};box.prototype.addVec3=function(a){this.min=vec3.min(this.min,a);this.max=vec3.max(this.max,a)};box.prototype.set=function(a,b){this.min[0]=a[0];this.min[1]=a[1];this.min[2]=a[2];this.max[0]=b[0];this.max[1]=b[1];this.max[2]=b[2]};
box.prototype.reset=function(){this.min[0]=MAX_VAL;this.min[1]=MAX_VAL;this.min[2]=MAX_VAL;this.max[0]=-MAX_VAL;this.max[1]=-MAX_VAL;this.max[2]=-MAX_VAL};box.prototype.getCenter=function(){return[0.5*(this.min[0]+this.max[0]),0.5*(this.min[1]+this.max[1]),0.5*(this.min[2]+this.max[2])]};box.prototype.isVisible=function(a){for(var b=this.getCenter(),f=vec3.distance(this.max,b),g=0;g<a.length;){var h=a[g];if(vec3.dot(h,b)+h[3]<-f)return!1;g++}return!0};
box.prototype.isValid=function(){return!(this.min[0]>this.max[0]||this.min[1]>this.max[1]||this.min[2]>this.max[2])};
box.prototype.transform=function(a){var b=new box,f=[];f.push([this.min[0],this.min[1],this.min[2]]);f.push([this.min[0],this.max[1],this.min[2]]);f.push([this.max[0],this.max[1],this.min[2]]);f.push([this.max[0],this.min[1],this.min[2]]);f.push([this.min[0],this.min[1],this.max[2]]);f.push([this.min[0],this.max[1],this.max[2]]);f.push([this.max[0],this.max[1],this.max[2]]);f.push([this.max[0],this.min[1],this.max[2]]);var g=f.length-1;do b.addVec3(mat4.transformPoint(a,f[g]));while(g--);return b};camera=function(){this.proj=mat4.identity();this.view=mat4.identity();this.world=mat4.identity();this.viewProj=mat4.identity();this.invViewProj=mat4.identity();this.frustum=[];this.frustumPts=[];this.controller=null;this.setPerspective=function(a,b,f,g){this.ortho=null;this.persp={};this.persp.fov=a;this.persp.aratio=b;this.persp.near=f;this.persp.far=g;this.proj=mat4.perspective(a,b,f,g);this.recalc()};this.reset=function(){this.world=mat4.identity();this.recalc()};this.copy=function(a){mat4.inplace_copy(this.view,
a.view);mat4.inplace_copy(this.world,a.world);mat4.inplace_copy(this.proj,a.proj);mat4.inplace_copy(this.viewProj,a.viewProj);mat4.inplace_copy(this.invViewProj,a.invViewProj);this.frustum=a.frustum.slice();this.frustumPts=a.frustumPts.slice()};this.recalc=function(){this.frustum=[];var a=this.viewProj;normalizePlane=function(a){var b=vec3.length(a);Math.abs(1-b)>0.0010&&(a[0]/=b,a[1]/=b,a[2]/=b,a[3]/=b);return a};var b=normalizePlane([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]]),f=normalizePlane([a[3]-
a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]),g=normalizePlane([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]),h=normalizePlane([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]),l=normalizePlane([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]),a=normalizePlane([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);this.frustum.push(b);this.frustum.push(f);this.frustum.push(g);this.frustum.push(h);this.frustum.push(l);this.frustum.push(a);this.frustumPts=[];b=this.viewProj;this.frustumPts.push(mat4.transformPoint(b,[-1,
-1,-1]));this.frustumPts.push(mat4.transformPoint(b,[-1,1,-1]));this.frustumPts.push(mat4.transformPoint(b,[1,1,-1]));this.frustumPts.push(mat4.transformPoint(b,[1,-1,-1]));this.frustumPts.push(mat4.transformPoint(b,[-1,-1,1]));this.frustumPts.push(mat4.transformPoint(b,[-1,1,1]));this.frustumPts.push(mat4.transformPoint(b,[1,1,1]));this.frustumPts.push(mat4.transformPoint(b,[1,-1,1]))};this.setWorld=function(a){this.world=a;this.view=mat4.inverse(a);this.viewProj=mat4.mul(this.view,this.proj);this.invViewProj=
mat4.inverse(this.viewProj);this.recalc()};this.setView=function(a){this.view=a;this.world=mat4.inverse(a);this.viewProj=mat4.mul(this.view,this.proj);this.invViewProj=mat4.inverse(this.viewProj);this.recalc()};this.setLookAt=function(a,b,f){this.setWorld(mat4.lookAt(a,b,f))};this.setPerspective=function(a,b,f,g){this.ortho=null;this.persp={};this.persp.fov=a;this.persp.aratio=b;this.persp.near=f;this.persp.far=g;this.proj=mat4.perspective(a,b,f,g);this.recalc()};this.setOrthographic=function(a,b,
f,g,h,l){this.persp=null;this.ortho={};this.ortho.left=a;this.ortho.right=b;this.ortho.top=f;this.ortho.bottom=g;this.ortho.near=h;this.ortho.far=l;this.proj=mat4.orthographic(a,b,f,g,h,l);this.recalc()};this.onResize=function(a,b,f,g){this.persp&&this.setPerspective(this.persp.fov,f/g,this.persp.near,this.persp.far);this.ortho&&this.setOrthographic(a,a+f,b,b+g,this.ortho.near,this.ortho.far)};this.zNear=function(){return this.persp?this.persp.near:this.ortho?this.ortho.near:0};this.zFar=function(){return this.persp?
this.persp.far:this.ortho?this.ortho.far:0};this.getFTR=function(){var a=this.persp.fov*0.5*Math.PI/180;return[Math.tan(a)*this.persp.far,Math.tan(a/this.persp.aratio)*this.persp.far,this.persp.far]};this.attachCameraToNode=function(a){this.controller=a}};
cameraManager=function(){this.stack=[];this.setActiveCamera=function(a){this.stack.length>0&&this.stack.pop();this.stack.push(a)};this.getActiveCamera=function(){return this.stack.length>0?this.stack[this.stack.length-1]:null};this.pushCamera=function(a){this.stack.push(a)};this.popCamera=function(){return this.stack.pop()};this.onResize=function(a,b,f,g){for(var h=this.stack.length-1;h>=0;)this.stack[h].onResize(a,b,f,g),h--}};shadowLight=function(){this.inheritedFrom=camera;this.inheritedFrom();this.invViewMatrix=mat4.identity();this.mvpMatrix=mat4.identity();this.shadowMatrix=mat4.identity();this.shadowMatrix=mat4.scale(this.shadowMatrix,[0.5,0.5,0.5]);this.shadowMatrix=mat4.translate(this.shadowMatrix,[0.5,0.5,0.5]);this.cameraManager=this.renderer=null;this.shadowBias=0.0195;this.init=function(){this.renderer=g_Engine.getContext().renderer;this.cameraManager=this.renderer.cameraManager()};this.activate=function(){this.cameraManager.pushCamera(this)};
this.deactivate=function(){this.cameraManager.popCamera()}};function getRandColor(){var a=Math.random(),b=Math.random(),f=Math.random();return[a,b,f,1]}function unProject(a,b,f,g,h,l){var n=[0,0,0,0],g=mat4.mul(g,h),g=mat4.inverse(g);if(!g)return null;n[0]=a;n[1]=b;n[2]=f;n[3]=1;n[0]=(n[0]-l[0])/l[2];n[1]=(n[1]-l[1])/l[3];n[0]=n[0]*2-1;n[1]=n[1]*2-1;n[2]=n[2]*2-1;a=mat4.transformPoint(g,n);if(a[3]<=1.0E-4)return null;a[0]/=a[3];a[1]/=a[3];a[2]/=a[3];return[a[0],a[1],a[2]]}
function AABB2LineSegment(a,b,f){c=vec3.scale(vec3.add(a.min,a.max),0.5);e=vec3.sub(a.max,a.min);d=vec3.sub(f,b);m=vec3.sub(b,f);m=vec3.sub(m,a.min);m=vec3.sub(m,a.max);a=Math.abs(d[0]);if(Math.abs(m[0])>e[0]+a)return!1;b=Math.abs(d[1]);if(Math.abs(m[1])>e[1]+b)return!1;f=Math.abs(d[2]);if(Math.abs(m[2])>e[2]+f)return!1;a+=1.192092896E-7;b+=1.192092896E-7;f+=1.192092896E-7;return Math.abs(m[1]*d[2]-m[2]*d[1])>e[1]*f+e[2]*b?!1:Math.abs(m[2]*d[0]-m[0]*d[2])>e[0]*f+e[2]*a?!1:Math.abs(m[0]*d[1]-m[1]*
d[0])>e[0]*b+e[1]*a?!1:!0}function hitTest(a,b,f){for(var g=null,h=null,l=0;l<a.BVL.length;l++)if(AABB2LineSegment(a.BVL[l],b,f)){var n=vec3.scale(vec3.add(a.BVL[l].min,a.BVL[l].max),0.5),n=vec3.dot(mat4.row(g_cam.world,2),n);if(n<g||g==null)g=n,h=a.BVL[l]}return h}
function loadShader(a,b,f){var g="#define PC\n";g+=f;f=g;g=a.createShader(b);if(g==null)return a.console.log("*** Error: unable to create shader '"+b+"'"),null;a.shaderSource(g,f);a.compileShader(g);return!a.getShaderParameter(g,a.COMPILE_STATUS)?(f=a.getShaderInfoLog(g),a.console.log("*** Error compiling shader '"+b+"':"+f),a.deleteShader(g),null):g}g_shaderCounter=0;
function createShader(a,b,f,g){var h="",l="";b.indexOf("{")!=-1?h=b:(h=new XMLHttpRequest,h.open("GET","assets/shaders/"+b+".glsl",!1),h.send(null),h=h.responseText);f.indexOf("{")!=-1?l=f:(l=new XMLHttpRequest,l.open("GET","assets/shaders/"+f+".glsl",!1),l.send(null),l=l.responseText);a.useProgram(null);f=loadShader(a,a.VERTEX_SHADER,h);h=loadShader(a,a.FRAGMENT_SHADER,l);if(!f||!h)return null;l=a.createProgram();if(!l)return null;a.attachShader(l,f);a.attachShader(l,h);for(var n in g)a.bindAttribLocation(l,
n,g[n]);a.linkProgram(l);if(!a.getProgramParameter(l,a.LINK_STATUS))return b=a.getProgramInfoLog(l),a.console.log("Error in program linking:"+b),a.deleteProgram(l),a.deleteProgram(h),a.deleteProgram(f),null;l.shaderID="Shader"+g_shaderCounter++;l.vname=b;l.RDGEUniform=new RDGEUniformInit;return l}
function getBaseURL(){var a=location.href,a=a.substring(0,a.indexOf("/",14));if(a.indexOf("http://localhost")!=-1){var a=location.href,b=a.indexOf(location.pathname),b=a.indexOf("/",b+1);return a.substr(0,b)+"/"}else return a+"/"};input={eventHandlers:[]};input.onKeyDown=function(a){for(var b=0,f=input.eventHandlers.length;b<f;){if(input.eventHandlers[b].onKeyDown!=void 0&&input.eventHandlers[b].onKeyDown(a))break;b++}};input.onKeyUp=function(a){for(var b=0,f=input.eventHandlers.length;b<f;){if(input.eventHandlers[b].onKeyUp!=void 0&&input.eventHandlers[b].onKeyUp(a))break;b++}};
input.onMouseDown=function(a){for(var b=0,f=input.eventHandlers.length;b<f;){if(input.eventHandlers[b].onMouseDown!=void 0&&input.eventHandlers[b].onMouseDown(a))break;b++}};input.onMouseUp=function(a){for(var b=0,f=input.eventHandlers.length;b<f;){if(input.eventHandlers[b].onMouseUp!=void 0&&input.eventHandlers[b].onMouseUp(a))break;b++}};
input.onMouseMove=function(a){for(var b=0,f=input.eventHandlers.length;b<f;){if(input.eventHandlers[b].onMouseMove!=void 0&&input.eventHandlers[b].onMouseMove(a))break;b++}};input.onMouseWheel=function(a){for(var b=0,f=input.eventHandlers.length;b<f;){if(input.eventHandlers[b].onMouseWheel!=void 0&&input.eventHandlers[b].onMouseWheel(a))break;b++}};stateManager=function(){this.stateStack=[];this.stateTop=void 0;this.RDGERunState=this.RDGEInitState=null;this.currentState=function(){return this.stateTop!=void 0?this.stateStack[this.stateTop]:null};this.PushState=function(a,b){if(a!=null&&typeof a.Init=="function")this.stateTop!=void 0&&this.stateStack[this.stateTop].LeaveState(),(b==void 0||b!="noInit")&&a.Init(),this.stateTop=this.stateStack.push(a)-1};this.PopState=function(){state=this.stateStack.pop();state!=null&&state.Shutdown();this.stateTop=
this.stateTop>0?this.stateTop-1:0;this.stateStack[this.stateTop]&&this.stateStack[this.stateTop].ReInit()};this.PopAll=function(){for(;this.stateStack[this.stateTop]!=null;)this.PopState()};this.tick=function(a){this.stateStack[this.stateTop]!=null&&(this.stateStack[this.stateTop].Update(a),this.stateStack[this.stateTop].Resize(),this.stateStack[this.stateTop].Draw())}};g_enableBenchmarks=!0;
function Engine(){this.sceneMap=[];this.stateTop=void 0;this.lastWindowWidth=window.innerWidth;this.lastWindowHeight=window.innerHeight;this.lightManager=this.defaultContext=null;clearColor=[0,0,0,0];panelObjectManager=new objectManager;this.initializeComplete=!1;this.RDGECanvas=null;this.canvasToRendererMap={};this.canvasNameToStateStack={};this.canvasCtxList=[];invalidObj=/([()]|function)/;isValidObj=function(a){return invalidObj.test(a)?(window.console.error("invalid object name passed to RDGE, "+
a+" - looks like a function"),!1):!0};contextDef=function(){this.startUpState=this.ctxStateManager=this.renderer=this.id=null;this.sceneGraphMap=[];this.currentScene=null;this.getScene=function(){return this.sceneGraphMap[this.currentScene]};this.debug={frameCounter:0,mat4CallCount:0}};this.ctxMan=contextManager=new objectManager;contextManager.currentCtx=null;contextManager._addObject=contextManager.addObject;contextManager.contextMap={};contextManager.addObject=function(a){this.contextMap[a.id]=
a;return this._addObject(a)};contextManager.start=function(){for(var a=this.objects.length,b=0;b<a;++b)contextManager.currentCtx=this.objects[b],this.objects[b].ctxStateManager.PushState(this.objects[b].startUpState)};contextManager.forEach=function(a){for(var b=this.objects.length,f=0;f<b;++f)a(this.objects[f])};this.getContext=function(a){return a?contextManager.contextMap[a]:contextManager.currentCtx};this.setContext=function(a){contextManager.currentCtx=contextManager.contextMap[a]};this.tickContext=
function(a){var b=contextManager.currentCtx;contextManager.currentCtx=contextManager.contextMap[a];this.objects[i].ctxStateManager.tick(dt);contextManager.currentCtx=b}}
Engine.prototype.init=function(a,b,f){this.GlInit(f);globalParamFuncSet=function(a){this.data=a.data;this.type=a.type;this.set=function(a){for(var b=this.data?this.data.length:0,f=0;f<b;++f)this.data[f]=a[f]};this.get=function(){return this.data.length==void 0?this.data:this.data.slice()}};this.lightManager=new LightManager(rdgeGlobalParameters.rdge_lights);for(var g in rdgeGlobalParameters)if(g!="rdge_lights")rdgeGlobalParameters[g]=new globalParamFuncSet(rdgeGlobalParameters[g]);else{var a=rdgeGlobalParameters[g],
h;for(h in a)rdgeGlobalParameters[h]=new globalParamFuncSet(a[h])}this.lastWindowWidth=window.innerWidth;this.lastWindowHeight=window.innerHeight;this.defaultContext=new RenderContext;this.defaultContext.uniforms=[{name:"u_matAmbient",value:[0.02,0.02,0.02,1]},{name:"u_matDiffuse",value:[1,1,1,1]},{name:"u_matSpecular",value:[1,1,1,1]},{name:"u_matShininess",value:[128]},{name:"u_matEmission",value:[0,0,0,1]}];contextManager.start();this.initializeComplete=!0};Engine.prototype.Shutdown=function(){this.PopAll()};
Engine.prototype.GlInit=function(){for(var a=document.getElementsByTagName("canvas"),b=a.length,f=0;f<b;++f){var g;a[f].getAttribute("rdge")=="true"&&(g=a[f],this.registerCanvas(g))}};Engine.prototype.loadScene=function(a){var b="assets_web/mesh/"+a+".json";contextManager.currentCtx.stateMan.currentState().name=="RunState"&&(contextManager.currentCtx.stateMan.PushState(contextManager.currentCtx.stateMan.RDGEInitState),contextManager.currentCtx.loadScene(b,a))};Engine.prototype.getScene=function(a){return contextManager.currentCtx.sceneGraphMap[a]};
Engine.prototype.AddScene=function(a,b){contextManager.currentCtx.sceneGraphMap[a]=b;contextManager.currentCtx.currentScene=a};Engine.prototype.createRDGEPanel=function(){var a=new utilDbgPanel("tools","WebGL Viewer Settings");a.appendLabel("","");return panelObjectManager.addObject(a)};Engine.prototype.getRDGEPanel=function(a){return panelObjectManager.handleToObject(a)};
Engine.prototype.registerCanvas=function(a,b){if(!a||!this.getContext(a.id)){a.renderer=new _renderer(a);this.canvasToRendererMap[a.id]=a;a.renderer.id=a.id;var f=new stateManager,g=new contextDef;g.id=a.id;g.renderer=a.renderer;g.ctxStateManager=f;g.fpsTracker=new fpsTracker(a.id);g.renderer.mvMatrix=mat4.identity();g.renderer.invMvMatrix=mat4.identity();g.renderer.projectionMatrix=mat4.identity();g.renderer.normalMatrix=mat4.identity();a.rdgeCtxHandle=contextManager.addObject(g);contextManager.currentCtx=
g;var h;if(b)h=b;else{var l=a.getAttribute("rdgerun");if(l){if(!isValidObj(l))return;try{h=new (eval(l))}catch(n){window.console.error('The provided RDGE state object "'+l+'" is not defined')}}else h={},validateUserState(h)}l=a.getAttribute("rdgescene");f.RDGEInitState=new LoadState(h,g);f.RDGERunState=new RunState(h,g);validateUserState(h);l?(f.RDGEInitState.sceneName=l,f.PushState(f.RDGERunState,"noInit"),g.startUpState=f.RDGEInitState):g.startUpState=f.RDGERunState;this.initializeComplete&&g.ctxStateManager.PushState(g.startUpState)}};
Engine.prototype.unregisterCanvas=function(a){stat.closePage(a.id+"_fps");contextManager.removeObject(a.rdgeCtxHandle)};Engine.prototype.getCanvas=function(a){return this.canvasToRendererMap[a]};nodeIdGen={counter:0};nodeIdGen.getId=function(){return"gen_"+nodeIdGen.counter++};function createTransformNode(a){node={name:a};node.transformNodeTemplate=new transformNodeTemplate(node);return node}function createMaterialNode(a){node={name:a};node.materialNodeTemplate=new materialNodeTemplate(node);return node}
function createMeshNode(a,b){meshNode={mesh:{},meshNodeTemplate:{}};var f=g_Engine.getContext().renderer;b.built||f.createPrimitive(b);var g=g_meshMan.getModelByName(a);if(g)f.buffers[g.primitive.buffersID]||f.createPrimitive(g.primitive);else return meshNode.mesh.meshNodeTemplate=new meshNodeTemplate(meshNode.mesh,b,a),g_meshMan.modelMap[a]=meshNode.mesh,meshNode;meshNode.mesh.meshNodeTemplate=new meshNodeTemplate(meshNode.mesh,g.primitive,a);return meshNode}
function createLightNode(a){node={name:a};node.lightNodeTemplate=new lightNodeTemplate(node);return node}function createScreenQuadNode(){var a=createTransformNode();a.attachMeshNode("screenQuad",createScreenAlignedQuad());return a}function verifyTransformNode(a){if(a.transformNodeTemplate==void 0)a.transformNodeTemplate=new transformNodeTemplate(a)}function verifyMaterialNode(a){if(a.materialNodeTemplate==void 0)a.materialNodeTemplate=new materialNodeTemplate(a)}
function verifyLightNode(a){if(a.lightNodeTemplate==void 0)a.lightNodeTemplate=new lightNodeTemplate(a)}
transformNodeTemplate=function(a){if(!a.children)a.children=[];if(!a.local)a.local=mat4.identity();if(!a.world)a.world=mat4.identity();if(!a.id)a.id=nodeIdGen.getId();if(!a.name)a.name="xfrmNode"+a.id;if(!a.parent)a.parent=null;if(!a.meshes)a.meshes=[];if(!a.nodeType)a.nodeType=rdgeConstants.nodeType.TRNODE;a.attachMaterial=function(a){verifyMaterialNode(a);this.materialNode=a};a.attachMeshNode=function(b,f){typeof b=="string"&&(b=createMeshNode(b,f));if(a.materialNode==void 0)a.materialNode=createMaterialNode(a.name+
"|defMaterial");a.meshes.push({mesh:{name:b.mesh.attribs.name,id:b.mesh.attribs.id}})};a.insertAsChild=function(a){if(this!=a)verifyTransformNode(a),a.parent=this,this.children.push({transformNode:a})};a.insertAsParent=function(a){if(this!=a){verifyTransformNode(a);if(this.parent){for(var f=this.parent.children.length,g=0;g<f;++g)if(this.parent.children[g].transformNode!=void 0&&(tr=this.parent.children[g].transformNode,tr.id==this.id)){this.parent.children.splice(g,1);break}a.parent=this.parent;
this.parent.children.push({transformNode:a});this.parent=a}a.children.push({transformNode:this})}}};
materialNodeTemplate=function(a){TEX_DIF=0;TEX_SPEC=1;TEX_NORM=2;TEX_GLOW=3;if(!a.nodeType)a.nodeType=rdgeConstants.nodeType.MATNODE;MATERIAL_MAX_LIGHTS=rdgeConstants.MAX_MATERIAL_LIGHTS;if(!a.lightChannel)a.lightChannel=[null,null,null,null];if(!a.sortCategory)a.sortCategory=rdgeConstants.categoryEnumeration.OPAQUE;if(!a.id)a.id=nodeIdGen.getId();if(!a.name)a.name="matNode"+a.id;if(!a.textureList){var b=g_Engine.getContext().renderer;a.textureList=[{name:"colMap",handle:b.getTextureByName("assets/images/white"),
unit:TEX_DIF,type:UNIFORMTYPE.TEXTURE2D},{name:"envMap",handle:b.getTextureByName("assets/images/material_paint"),unit:TEX_SPEC,type:UNIFORMTYPE.TEXTURE2D},{name:"normalMap",handle:b.getTextureByName("assets/images/blue"),unit:TEX_NORM,type:UNIFORMTYPE.TEXTURE2D},{name:"glowMap",handle:b.getTextureByName("assets/images/black"),unit:TEX_GLOW,type:UNIFORMTYPE.TEXTURE2D}]}if(!a.uniforms)a.uniforms=[];a.setTexture=function(a,b){var h=g_Engine.getContext().renderer;this.textureList[a].handle=h.getTextureByName("assets/images/"+
b);this.textureList[a].unit=a;this.textureList[a].type=UNIFORMTYPE.TEXTURE2D};a.setDiffuseTexture=function(a){this.setTexture(TEX_DIF,a)};a.setSpecTexture=function(a){this.setTexture(TEX_SPEC,a)};a.setNormalTexture=function(a){this.setTexture(TEX_NORM,a)};a.setGlowTexture=function(a){this.setTexture(TEX_GLOW,a)};a.setUniform=function(a,b){for(var h=this.uniforms.length,l=0;l<h;++l)if(this.uniforms[l].name==a){this.uniforms[l].value=b;return}window.console.log("Could not find uniform: "+a)};a.setShader=
function(a){this.shaderProgram=a};a.setSortCategory=function(b){a.sortCategory=b};a.enableLightChannel=function(b,g){verifyLightNode(g);if(typeof b=="object")for(var h=b.length,l=g.length!=void 0?g.length:0,n=0;n<h;++n)a.lightChannel[b]=l>0?g[Math.min(n,l-1)]:g;else b<MATERIAL_MAX_LIGHTS&&(a.lightChannel[b]=g)};a.disableLightChannel=function(b){if(typeof b!="object")for(var g=b.length,h=0;h<g;++h)MATERIAL_MAX_LIGHTS&&(a.lightChannel[b[h]]=null);else b<MATERIAL_MAX_LIGHTS&&(a.lightChannel[b]=null)};
a.disableAllLights=function(){for(var b=0;b<MATERIAL_MAX_LIGHTS;++b)a.lightChannel[b]=null};a.toJSON=function(){var a={jsonExportName:"materialNode"},b;for(b in this)if(a[b]=this[b],b==="textureList")for(var h=a[b],l=0,n=h.length;l<n;++l)h[l].handle.image=h[l].handle.lookUpName;else b==="shaderProgram"&&typeof a[b]!="string"&&(a[b]=a[b].exportShader());return a}};
meshNodeTemplate=function(a,b,f){b.built||renderer.createPrimitive(b);if(!a.nodeType)a.nodeType=rdgeConstants.nodeType.MESHNODE;if(!a.attribs){var g=nodeIdGen.getId();a.attribs={id:g,indexCount:b.indexCount,name:f,vertCount:b.posCount};a.name=f}if(!a.bbox)a.bbox=new box;a.data=null;a.primitive=b;f=b.posCount;if(f>0){b=b.positions;for(g=0;g<f-2;)a.bbox.addVec3([b[g+0],b[g+1],b[g+2]]),g+=3}else window.console.error("mesh "+a.attribs.name+": bounding volume not created")};
lightNodeTemplate=function(a){if(!a.nodeType)a.nodeType=rdgeConstants.nodeType.LIGHTNODE;if(!a.id)a.id=nodeIdGen.getId();if(!a.name)a.name="light_"+a.id;if(!a.typeName)a.typeName="dir_light";if(!a.castShadow)a.castShadow=!1;if(!a.depthMapBias)a.depthMapBias=0.0179;if(!a.depthMapSize)a.depthMapSize=1024;if(!a.coneAngle)a.coneAngle=0.707;if(!a.penumbraAngle)a.coneAngle=0;if(!a.dropOff)a.coneAngle=0.025;if(!a.color)a.color=[1,1,1,1];if(!a.dir)a.dir=[1,-1,1];if(!a.links)a.links=[];if(!a.position)a.position=
[0,0,0];if(!a.lightDiffuse)a.lightDiffuse=[1,1,1,1];if(!a.lightAmbient)a.lightAmbient=[0.5,0.5,0.5,1];if(!a.lightSpecular)a.lightSpecular=[1,1,1,1];a.setPosition=function(a){for(var f=0;f<3;f++)this.position[f]=a[f]};a.setDiffuseColor=function(a){for(var f=0;f<4;f++)this.lightDiffuse[f]=a[f]};a.setAmbientColor=function(a){for(var f=0;f<4;f++)this.lightAmbient[f]=a[f]};a.setSpecularColor=function(a){for(var f=0;f<4;f++)this.lightSpecular[f]=a[f]}};var g_drawCount=0;g_enableFlyCam=!1;g_sceneStats={};g_sceneStats.nodesVisible=new stat("scenegraph","nodesVisible",0,null,!1);g_sceneStats.nodesCulled=new stat("scenegraph","nodesCulled",0,null,!1);g_sceneStats.nodesVisited=new stat("scenegraph","nodesVisited",0,null,!1);g_sceneStats.reset=function(){g_sceneStats.nodesVisible.value=0;g_sceneStats.nodesVisited.value=0;g_sceneStats.nodesCulled.value=0};
function DefaultRender(){this.renderer=g_Engine.getContext().renderer;this.jshaderProgram=new jshader;this.jshaderProgram.def=this.renderer.defaultShaderDefintion;this.jshaderProgram.init()}DefaultRender.prototype.process=function(){};function renderObject(a,b,f){this.node=a?a:createTransformNode();this.context=b?b:new RenderContext;this.parent=f?f:null}
function SceneGraph(a){if(a==void 0||a==null)a={};this.scene=a;this.scene=this.scene.root!=void 0?this.scene.root:{children:[]};this.tick=0;this.lastTick=-1;this.frustumCulling=!0;this.mainLight=new shadowLight;this.bckTypes=rdgeConstants.categoryEnumeration;this.renderList=Array(this.bckTypes.MAX_CAT);this.renderList[this.bckTypes.BACKGROUND]=[];this.renderList[this.bckTypes.OPAQUE]=[];this.renderList[this.bckTypes.TRANSPARENT]=[];this.renderList[this.bckTypes.ADDITIVE]=[];this.renderList[this.bckTypes.TRANSLUCENT]=
[];this.renderList[this.bckTypes.FOREGROUND]=[];this.shadowRenderList=[];this.shadowCuller=null;this.defaultPassDef={name:"geoPass",geometrySet:"ALL"};this.renderGraph=new jpassGraph(this.defaultPassDef);this.animstack=[];this.pushAnim=function(a){this.animstack.push(a)};this.popAnim=function(){this.animstack.pop()};this.playAnim=function(a){this.popAnim();this.pushAnim(a)};this.stopAllAnims=function(){this.animstack=[]};this.jdefShaderProgram=new jshader;this.jdefShaderProgram.def=rdgeDefaultShaderDefintion;
this.jdefShaderProgram.init();this.drawTag=document.getElementById("draw_count");mapping=[];mapping.process=function(a){mapping[a.name]=a};this.Traverse(mapping);this.findNode=function(a){return mapping[a]};findNodeByName=function(a){this.result=null;this.process=function(f){if(f.name==a)this.result=f;return!0};this.init=function(){this.result=null}};buildNodeList=function(a){this.result=[];this.process=function(f){f.name==a&&this.result.push(f);return!0};this.init=function(){this.result=[]}};buildNodeListRegex=
function(a){this.result=[];this.process=function(f){a.test(f.name)&&this.result.push(f);return!0};this.init=function(){this.result=[]}};importScene=function(){this.renderer=g_Engine.getContext().renderer;this.process=function(a,f){a.parent=f;if(a.nodeType===rdgeConstants.nodeType.TRNODE){a.transformNodeTemplate=void 0;verifyTransformNode(a);if(a.materialNode){a.materialNode.materialNodeTemplate=void 0;verifyMaterialNode(a.materialNode);if(a.materialNode.shaderProgram){var g=new jshader;g.def=JSON.parse(a.materialNode.shaderProgram);
g.init();a.materialNode.shaderProgram=g}for(var h=a.materialNode.textureList,g=0,l=h.length;g<l;++g)h[g].handle=this.renderer.getTextureByName(h[g].handle.lookUpName,h[g].handle.texparams.wrap,h[g].handle.texparams.mips);h=a.materialNode.lightChannel;g=0;for(l=h.length;g<l;++g)if(h[g])h[g].lightNodeTemplate=void 0,verifyLightNode(h[g])}g=0;for(l=a.meshes.length;g<l;++g)this.renderer.createPrimitive(g_meshMan.getModelByName(a.meshes[g].mesh.name).primitive)}return!0};this.init=function(){this.result=
[]}};__compareLessThan=function(a,f){return a<f};__compareGreaterThan=function(a,f){return a>f};insertIntoSortedList=function(a,f,g){a.push(f);var h=a.length,l=g_Engine.getContext().renderer.cameraManager().getActiveCamera();f.depth=vec3.dot([l.world[8],l.world[9],l.world[10]],[l.world[12]-f.node.world[12],l.world[13]-f.node.world[13],l.world[14]-f.node.world[14]]);h-=1;for(l=null;h>0;--h)if(g(f.depth,a[h-1].depth))l=a[h-1],a[h-1]=a[h],a[h]=l;else break};shadowCullPass=function(a,f,g){this.result=
[];this.activeCam=a;this.bucketType=f;this.compare=g;this.process=function(a,b){if(a.bbox_world&&a.bbox_world.isValid()&&!a.bbox_world.isVisible(this.activeCam.frustum))return!1;a.materialNode&&a.materialNode.sortCategory==this.bucketType&&insertIntoSortedList(this.result,{context:new RenderContext,node:a,parent:b},this.compare);return!0};this.init=function(){this.result=[]}};insertFrontToBack=function(a,f){insertIntoSortedList(a,f,__compareLessThan)};insertBackToFront=function(a,f){insertIntoSortedList(a,
f,__compareGreaterThan)};this.sortFunc=[];this.sortFunc[this.bckTypes.BACKGROUND]=function(a,f){a.push(f)};this.sortFunc[this.bckTypes.OPAQUE]=insertFrontToBack;this.sortFunc[this.bckTypes.TRANSPARENT]=insertBackToFront;this.sortFunc[this.bckTypes.ADDITIVE]=insertBackToFront;this.sortFunc[this.bckTypes.TRANSLUCENT]=insertBackToFront;this.sortFunc[this.bckTypes.FOREGROUND]=function(a,f){a.push(f)}}
SceneGraph.prototype.Traverse=function(a,b){this.scene==null?window.console.log("traversing a NULL scene!"):(a.init&&a.init(),b?this._TraverseDFHelper(a,this.scene):this._TraverseBFHelper(a,this.scene))};SceneGraph.prototype.addNode=function(a){verifyTransformNode(a);this.scene.children.push({transformNode:a})};SceneGraph.prototype.insertUnder=function(a,b){verifyTransformNode(a);a.insertAsChild(b)};SceneGraph.prototype.insertAbove=function(a,b){verifyTransformNode(a);a.insertAsParent(b)};
SceneGraph.prototype.getNode=function(a){a=new findNodeByName(a);this.Traverse(a,!0);return a.result};SceneGraph.prototype.getNodes=function(a){a=new buildNodeList(a);this.Traverse(a,!0);return a.result};SceneGraph.prototype.getNodesRegex=function(a){typeof a=="string"&&(a=RegExp(a));a=new buildNodeListRegex(a);this.Traverse(a,!0);return a.result};
SceneGraph.prototype._TraverseDFHelper=function(a,b,f){if(b.children!="undefined"){var g=[];for(g.push({node:b,parent:null});g.length>0;){f=g.pop();b=f.node;f=f.parent;if(b.transformNode!==void 0&&(b=b.transformNode,a.process(b,f)===!1))continue;if(b.children!==void 0)for(f=0;f<b.children.length;++f)g.push({node:b.children[f],parent:b})}}};
SceneGraph.prototype._TraverseDFPostOrderHelper=function(a,b,f){if(b.children!="undefined"){var g=[];g.push({node:b,parent:null});for(b=g.length;b>0;){for(var b=g.length,f=l.children[b-1],f=f.children==void 0?0:f.children.length,h=0;h<f;++h)g.push({node:l.children[h],parent:l});if(!(f>0)){var f=g.pop(),l=f.node,f=f.parent;if(l.transformNode!==void 0)l=l.transformNode,a.process(l,f)}}}};
SceneGraph.prototype.BuildBVHHelper=function(a){if(a.children!="undefined"){a.bbox_world?a.bbox_world.reset():a.bbox_world=new box;if(a.local==void 0)a.local=mat4.identity();var b=[],f=0;a.id="root";b.push({node:a,xfrm:mat4.identity(),parent:null,visited:!1});for(var a=b.length,g=0;a>0;){var a=b.length,g=a-1,h=b[g].node.transformNode==void 0?b[g].node:b[g].node.transformNode,l=b[g].xfrm,n=b[g].parent,g=b[g].visited;if(h.id==void 0)h.id="id"+f;if(!g){if(h.local!==void 0){h.bbox_world?h.bbox_world.reset():
h.bbox_world=new box;g=this.GetBBoxForNode(h);h.world=mat4.mul(h.local,l);if(g)h.bbox_world=g.transform(h.world);if(!g||!g.isValid())l=new box,l.set(0,0),h.bbox_world=l}l=h.children==void 0?0:h.children.length;for(g=0;g<l;++g)b.push({node:h.children[g],xfrm:h.world,parent:h,visited:!1});f++;if(l>0)continue}n&&n.bbox_world&&n.bbox_world.isValid()&&h.bbox_world&&h.bbox_world.isValid()&&n.bbox_world.addBox(h.bbox_world);b.pop();a=b.length;if(a>0&&(b[a-1].node.transformNode==void 0?b[a-1].node:b[a-1].node.transformNode).id==
n.id)b[a-1].visited=!0}}};SceneGraph.prototype._TraverseBFHelper=function(a,b){if(b.children!="undefined"){var f=[];for(f.push({node:b,parent:null});f.length>0;){var g=f.shift(),h=g.node,g=g.parent;if(h.transformNode!==void 0)h=h.transformNode,a.process(h,g);if(h.children!==void 0)for(g=0;g<h.children.length;++g)f.push({node:h.children[g],parent:h})}}};
SceneGraph.prototype.update=function(a){var b=g_Engine.getContext().renderer;g_Engine.getContext().debug.mat4CallCount=0;for(var f=this.animstack.length-1;f>=0;)this.animstack[f].step(a),--f;this.BuildBVHHelper(this.scene);g_particleSystemManager.update(a);g_enableFlyCam||(a=b.cameraManager().getActiveCamera(),a.controller!=null&&a.controller.world!=void 0&&a.setWorld(a.controller.world),g_enableFlyCam||(b.cameraManager().getActiveCamera(),this.tick++));this.tick++};
SceneGraph.prototype.render=function(a,b){if(this.scene.children.length!=0){var f=g_Engine.getContext().renderer;g_drawCount=0;rdgeGlobalParameters.u_shadowLightFarZ.set([this.mainLight.zFar()]);this.renderList=this._RenderDFHelper(f,a,this.scene,b);if(this.shadowsEnabled)this.Traverse(this.shadowCuller,!0),this.shadowRenderList=this.shadowCuller.result;this.renderGraph.render(this);g_particleSystemManager.render();if(this.drawTag)this.drawTag.innerHTML="<b>Draws/frame: "+g_drawCount+"| mat4 bind: "+
g_Engine.getContext().debug.mat4CallCount+"</b>"}};SceneGraph.prototype.GetBBoxForNode=function(a){var b=null;if(a.materialNode&&a.materialNode.meshNode){var f=null,f=g_meshMan.getModelByName(a.materialNode.meshNode.mesh.name);if(f!=null)b=f.bbox}return b};
SceneGraph.prototype._RenderDFHelper=function(a,b,f){renderList=[];renderList[this.bckTypes.BACKGROUND]=[];renderList[this.bckTypes.OPAQUE]=[];renderList[this.bckTypes.TRANSPARENT]=[];renderList[this.bckTypes.ADDITIVE]=[];renderList[this.bckTypes.TRANSLUCENT]=[];renderList[this.bckTypes.FOREGROUND]=[];if(f.children!="undefined"){b=[];b.push({node:f,curCtx:g_Engine.defaultContext});for(a=a.cameraManager().getActiveCamera();b.length>0;){var g=b.pop(),f=g.node,h=new RenderContext;h.Load(g.curCtx);if(f.transformNode!==
void 0){f=f.transformNode;if(f.hide!==void 0&&f.hide==!0)continue;g_sceneStats.nodesVisited.value++;if(this.frustumCulling&&f.bbox_world&&f.bbox_world.isValid()&&!f.bbox_world.isVisible(a.frustum)){g_sceneStats.nodesCulled.value++;continue}g_sceneStats.nodesVisible.value++;h.shaderProg=this.jdefShaderProgram;g=rdgeConstants.categoryEnumeration.OPAQUE;if(f.materialNode){g=f.materialNode.sortCategory;if(f.materialNode.shaderProgram!==void 0)h.shaderProg=f.materialNode.shaderProgram;if(f.materialNode.textureList!==
void 0)h.textureList=f.materialNode.textureList.slice();if(f.materialNode.uniforms.length>0)h.uniforms=f.materialNode.uniforms.slice();for(var l=f.materialNode.lightChannel.length,n=0;n<l;++n)f.materialNode.lightChannel[n]&&(h.lights[n]=f.materialNode.lightChannel[n])}this.sortFunc[g](renderList[g],{context:h,node:f,parent:parent});g_drawCount++}if(f.children!==void 0){g=f.children.length;for(l=0;l<g;++l)b.push({node:f.children[l],curCtx:h})}}}return renderList};
SceneGraph.prototype.enableShadows=function(a){a?(a=g_Engine.getContext().renderer,this.shadowCuller=new shadowCullPass(this.mainLight,rdgeConstants.categoryEnumeration.OPAQUE,function(a,f){return a<f}),this.mainLight.init(),this.mainLight.setPerspective(45,a.vpWidth/a.vpHeight,1,200),this.mainLight.setLookAt([-60,17,-15],[-5,-5,15],vec3.up()),rdgeGlobalParameters.u_shadowLightWorld.set(this.mainLight.world),rdgeGlobalParameters.u_vShadowLight.set(this.mainLight.view),a=mat4.identity(),a=mat4.scale(a,
[0.5,0.5,0.5]),a=mat4.translate(a,[0.5,0.5,0.5]),rdgeGlobalParameters.u_shadowBiasMatrix.set(a),a=mat4.mul(this.mainLight.proj,a),a=mat4.mul(this.mainLight.view,a),rdgeGlobalParameters.u_shadowBPV.set(a),this.shadowsEnabled=!0):(this.mainLight=null,this.shadowsEnabled=!1)};
SceneGraph.prototype.exportJSON=function(){objMap=[];var a={scene:null,meshes:null};a.scene=JSON.stringify(this.scene,function(a,f){if(a=="bbox_world")return null;else if(a==="parent")return"parent";return f});a.meshes=g_meshMan.exportJSON();return a=JSON.stringify(a)};
SceneGraph.prototype.importJSON=function(a){try{if(a){var b=JSON.parse(a);if(b)this.scene=JSON.parse(b.scene),b.meshes&&g_meshMan.importJSON(b.meshes),this.scene&&(this.Traverse(new importScene,!0),window.console.log("scene imported"))}}catch(f){window.console.error("error importing JSON scene: "+f.description)}};function LightManager(a){this.lightUniforms=[[],[],[],[]];for(var b in a)b.indexOf("u_light0")==0?this.lightUniforms[0][b]=b:b.indexOf("u_light1")==0?this.lightUniforms[1][b]=b:b.indexOf("u_light2")==0?this.lightUniforms[2][b]=b:b.indexOf("u_light3")==0&&(this.lightUniforms[3][b]=b);this.lightToMesh=[];this.meshToLight=[];this.dirLights=[];this.pointLights=[];this.spotLights=[];this.ambLights=[];this.unknLights=[];this.typePointLight="point_light";this.typeSpotLight="spot_light";this.typeAmbLight=
"amb_light";this.typeDirLight="dir_light";this.defaultLights=[createLightNode("default0"),createLightNode("default1"),createLightNode("default2"),createLightNode("default3")]}
LightManager.prototype.setMapping=function(a,b){this.lightToMesh[a.name]=b;for(var f=0;f<b.length;f++){var g=this.meshToLight[b[f]];g!==void 0?g.push(a):(g=[],g.push(a),this.meshToLight[b[f]]=g)}a.typeName==this.typePointLight?this.pointLights.push(a):a.typeName==this.typeSpotLight?this.spotLights.push(a):a.typeName==this.typeAmbLight?this.ambLights.push(a):a.typeName==this.typeDirLight?this.dirLights.push(a):this.unknLights.push(a)};LightManager.prototype.getLightsForMesh=function(a){return this.meshToLight[a]};var g_whiteTex=null,g_blackTex=null,g_blueTex=null;function RDGEWebTexture(){this.type=UNIFORMTYPE.TEXTURE2D}function RDGEWebUniformPair(a,b,f){this.uniform=a;this.value=b;this.type=f}function defaultState(){return[function(){gl.disable(gl.CULL_FACE)},function(){gl.enable(gl.DEPTH_TEST)}]}
function CreateMasterList(){return _MasterUniformList=[{uniform:projMatrixUniform=0,name:"u_projMatrix",type:UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:mvMatrixUniform=0,name:"u_mvMatrix",type:UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:normalMatrixUniform=0,name:"u_normalMatrix",type:UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:worldMatrixUniform=0,name:"u_worldMatrix",type:UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:lightPos=0,name:"u_lightPos",
type:UNIFORMTYPE.FLOAT3,value:new Float32Array(3)},{uniform:lightDiff=0,name:"u_lightDiff",type:UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:lightAmb=0,name:"u_lightAmb",type:UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:colMap=0,name:"colMap",type:UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)},{uniform:envMap=0,name:"envMap",type:UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)},{uniform:normalMap=0,name:"normalMap",type:UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)},{uniform:glowMap=
0,name:"glowMap",type:UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)},{uniform:matAmbient=0,name:"u_matAmbient",type:UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:matDiffuse=0,name:"u_matDiffuse",type:UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:matSpecular=0,name:"u_matSpecular",type:UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:matShininess=0,name:"u_matShininess",type:UNIFORMTYPE.FLOAT,value:new Float32Array(1)},{uniform:matEmission=0,name:"u_matEmission",type:UNIFORMTYPE.FLOAT,
value:new Float32Array(4)},{uniform:frustumFarZ=0,name:"u_frustumFarZ",type:UNIFORMTYPE.FLOAT,value:new Float32Array(1)},{uniform:shadowLightWorld=0,name:"u_shadowLightWorld",type:UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:shadowBiasMatrix=0,name:"u_shadowBiasMatrix",type:UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:vShadowLight=0,name:"u_vShadowLight",type:UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:depthMap=0,name:"depthMap",type:UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)}]}
function RDGEUniformInit(){this.uniformList=CreateMasterList();this.uniformMap=[];for(var a=0;a<this.uniformList.length;++a)this.uniformMap[this.uniformList[a].name]=this.uniformList[a]}RDGEUniformInit.prototype.SetUni=function(a,b){this.uniformMap[a].value=b};RDGEUniform=new RDGEUniformInit;
function RenderContext(){this.shaderProg=null;this.uniforms=[];this.textureList=[];this.curRenderProc=null;this.light0Color=[1,1,1,0];this.parentID=0;this.world=mat4.identity();this.hide=!1;enableNormalMapping=!0;this.lights=[null,null,null,null];this.stateSettings=[]}
RenderContext.prototype.Load=function(a){this.shaderProg=a.shaderProg;this.uniforms=a.uniforms.slice();this.textureList=a.textureList.slice();this.stateSettings=a.stateSettings.slice();this.curRenderProc=a.curRenderProc;this.light0Color=a.light0Color.slice();this.parentID=a.parentID;this.world=mat4.copy(a.world);this.lights=a.lights.slice();this.cam=this.cam;this.stateSettings=this.stateSettings.slice()};__lastInited=[];
function _SetShader(a){gl.useProgram(a);if(__lastInited[a.shaderID]===void 0){__lastInited[a.shaderID]=!0;gl.enableVertexAttribArray(0);gl.enableVertexAttribArray(1);gl.enableVertexAttribArray(2);for(var b=0;b<a.RDGEUniform.uniformList.length;b++){var f=gl.getUniformLocation(a,a.RDGEUniform.uniformList[b].name);f?a.RDGEUniform.uniformList[b].uniform=f:(a.RDGEUniform.uniformList.splice(b,1),b=Math.max(b-1,0))}}}RenderContext.prototype.AddStateSetting=function(a){this.stateSettings.push(a)};
RenderContext.prototype.Apply=function(){shaderProg=null;this.shaderProg!=null?(_SetShader(this.shaderProg),shaderProg=this.shaderProg):(_SetShader(g_Engine.defaultContext.shaderProg),shaderProg=g_Engine.defaultContext.shaderProg);if(this.uniforms.length>0)for(var a=0;a<this.uniforms.length;++a)shaderProg.RDGEUniform.SetUni(this.uniforms[a].name,this.uniforms[a].value);shaderProg.RDGEUniform.SetUni("u_lightDiff",this.light0Color);for(a=0;a<this.stateSettings.length;++a)this.stateSettings[a]();this.bindTextures()};
RenderContext.prototype.bindTextures=function(){for(var a=g_Engine.getContext().renderer.ctx,b=0;b<this.textureList.length;b++){var f=this.textureList[b];switch(f.type){case UNIFORMTYPE.TEXTURE2D:a.activeTexture(a.TEXTURE0+f.unit);a.bindTexture(a.TEXTURE_2D,f.handle);break;case UNIFORMTYPE.TEXTURECUBE:a.activeTexture(a.TEXTURE0+f.unit),a.bindTexture(a.TEXTURE_CUBE_MAP,f.handle)}}enableNormalMapping||(a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_CUBE_MAP,g_blueTex),a.activeTexture(a.TEXTURE2),
a.bindTexture(a.TEXTURE_2D,g_blueTex))};var funcmap={};funcmap[UNIFORMTYPE.INT]=function(a,b){gl.uniform1iv(a,b)};funcmap[UNIFORMTYPE.FLOAT]=function(a,b){gl.uniform1fv(a,b)};funcmap[UNIFORMTYPE.FLOAT2]=function(a,b){gl.uniform2fv(a,b)};funcmap[UNIFORMTYPE.FLOAT3]=function(a,b){gl.uniform3fv(a,b)};funcmap[UNIFORMTYPE.FLOAT4]=function(a,b){gl.uniform4fv(a,b)};funcmap[UNIFORMTYPE.MATRIX3]=function(a,b){gl.uniformMatrix3fv(a,!1,b)};
funcmap[UNIFORMTYPE.MATRIX4]=function(a,b){gl.uniformMatrix4fv(a,!1,b)};funcmap[UNIFORMTYPE.TEXTURE2D]=function(a,b){gl.activeTexture(gl.TEXTURE0+b);gl.uniform1iv(a,b)};funcmap[UNIFORMTYPE.TEXTURECUBE]=function(a,b){gl.activeTexture(gl.TEXTURE0+b);gl.uniform1iv(a,b)};function _bindUniforms(a){for(var b=a.RDGEUniform.uniformList.length,a=a.RDGEUniform.uniformList,f=0;f<b;f++){var g=a[f];funcmap[g.type](g.uniform,g.value)}};var g_numChannels=new stat("animation","numChannels",0,null,!1),g_numTracks=new stat("animation","numTracks",0,null,!1);
channelController=function(a,b){this.interpolate=!1;this.animation=a;this.channel=b;this.localTime=0;this.startTime=this.animation.clipStart/this.animation.framesPerSec;this.endTime=this.animation.clipEnd/this.animation.framesPerSec;this.cachedFrame=-1;oneFrameInSecs=1/a.framesPerSec;this.channel.timeline=Array(this.channel.numKeys+1);for(i=0;i<=this.channel.numKeys;++i)this.channel.timeline[i]=i/this.animation.framesPerSec;this.computeFrame=function(){var a=this.localTime+this.startTime,b=this.animation.clipStart,
h=this.animation.clipEnd;if(this.cachedFrame!=-1&&Math.abs(a-this.channel.timeline[this.cachedFrame])<5*oneFrameInSecs){if(this.channel.timeline[this.cachedFrame]<a)for(;this.channel.timeline[this.cachedFrame+1]<=a;)if(this.cachedFrame++,this.animation.looping)this.cachedFrame>this.numFrames-1&&(this.cachedFrame-=this.numFrames-1);else{if(this.cachedFrame>this.numFrames-1)this.cachedFrame=this.numFrames-1}else for(;this.channel.timeline[this.cachedFrame]>a;)if(this.cachedFrame--,this.animation.looping)this.cachedFrame<
0&&(this.cachedFrame+=this.numFrames-1);else if(this.cachedFrame>this.numFrames-1)this.cachedFrame=this.numFrames-1;return this.cachedFrame}for(;b+1<h;){var l=Math.floor((b+h)/2);a>this.channel.timeline[l]?b=l+1:h=l-1}return this.cachedFrame=b};this.sampleBool=function(){return this.channel.keys[this.computeFrame()]};this.sampleQuat=function(){var a=this.computeFrame(),b=a+1,h=this.channel.timeline[a],l=this.channel.timeline[b];a*=4;b*=4;return this.interpolate?quat.slerp([this.channel.keys[a+0],
this.channel.keys[a+1],this.channel.keys[a+2],this.channel.keys[a+3]],[this.channel.keys[b+0],this.channel.keys[b+1],this.channel.keys[b+2],this.channel.keys[b+3]],(this.localTime+this.startTime-h)/(l-h)):[this.channel.keys[a+0],this.channel.keys[a+1],this.channel.keys[a+2],this.channel.keys[a+3]]};this.sampleVec3=function(){var a=this.computeFrame(),b=a+1,h=this.channel.timeline[a],l=this.channel.timeline[b];a*=3;b*=3;return this.interpolate?vec3.lerp([this.channel.keys[a+0],this.channel.keys[a+
1],this.channel.keys[a+2]],[this.channel.keys[b+0],this.channel.keys[b+1],this.channel.keys[b+2]],(this.localTime+this.startTime-h)/(l-h)):[this.channel.keys[a+0],this.channel.keys[a+1],this.channel.keys[a+2]]};this.setTime=function(a){this.localTime=a;if(this.localTime<0)this.localTime=0;if(this.localTime>this.animation.duration-oneFrameInSecs)this.localTime=this.animation.duration-oneFrameInSecs};this.setProgress=function(a){this.setTime(a*this.animation.duration)};this.setFrame=function(a){this.setTime(a/
this.animation.framesPerSec)};this.step=function(a){this.localTime+=a;if(this.animation.looping){for(;this.localTime<0;)this.localTime+=this.animation.duration-oneFrameInSecs;for(;this.localTime>=this.animation.duration-oneFrameInSecs;)this.localTime-=this.animation.duration-oneFrameInSecs}else{if(this.localTime<0)this.localTime=0;if(this.localTime>this.animation.duration)this.localTime=this.animation.duration}}};
track=function(a,b,f){this.track=b;this.node=f;this.channelControllers=[];for(ch in b)this.channelControllers[ch]=new channelController(a,b[ch]),g_numChannels.value++;this.step=function(a){for(cc in this.channelControllers)this.channelControllers[cc].step(a);var a=this.channelControllers.rotate.sampleQuat(),b=this.channelControllers.scale.sampleVec3(),f=this.channelControllers.translate.sampleVec3();if(this.channelControllers.vis!=null)this.node.hide=!this.channelControllers.vis.sampleBool();var n=
mat4.identity(),n=mat4.scale(n,b),n=mat4.mul(n,quat.toMatrix(a)),n=mat4.translate(n,f);this.node.local=n}};
animation=function(a,b,f,g){this.animation=a.scene.animation;this.clipStart=b;if(f==-1)for(tr in this.animation){for(ch in this.animation[tr]){f=this.animation[tr][ch].numKeys-1;break}break}this.clipEnd=f;this.numFrames=f-b;this.framesPerSec=30;this.duration=this.numFrames/this.framesPerSec;this.rate=1;this.looping=g;this.tracks=[];mapping=[];mapping.process=function(a){mapping[a.name]=a};g_Engine.getContext().getScene().Traverse(mapping);for(tr in this.animation)mapping[tr]!==void 0&&(this.tracks.push(new track(this,
this.animation[tr],mapping[tr])),g_numTracks.value++);this.step=function(a){for(tr in this.tracks)this.tracks[tr].step(g_animationRate*this.rate*a)}};particleStats=function(){this.numParticles=new stat("particles","numParticles",0);this.numDrawCalls=new stat("particles","numDrawCalls",0);this.numVerts=new stat("particles","numVerts",0);this.numTris=new stat("particles","numTris",0);this.report=function(a){for(em in a.emitters){var b=a.emitters[em].pbuffer,f=b.indexBuffer.front();b.posBuffer.front();this.numParticles.value+=f.numIndices/6;this.numTris.value+=f.numIndices/3;this.numVerts.value+=this.numParticles.value*4;this.numParticles.value>0&&
this.numDrawCalls.value++}}};g_particleStats=null;
particle=function(a,b){this.id=b;this.def=a;if(this.def.numFrames==void 0)this.def.numFrames=this.def.textureSize&&this.def.frameSize?this.def.textureSize[0]/this.def.frameSize[0]*(this.def.textureSize[1]/this.def.frameSize[1]):0;this.pos=vec3.zero();this.delta=vec3.zero();this.lifespan=this.age=this.rotate=0;this.velocity=vec3.zero();this.gravity=vec3.zero();this.frameCount=this.frame=0;this.lastPos=vec3.zero();this.state=0;this.hide=!1;this.color=vec4.zero();this.randomize=function(a,b){return a+
(b-a)*Math.random()};this.rate=this.randomize(-1,1);this.randomize3=function(a,b){return[this.randomize(a[0],b[0]),this.randomize(a[1],b[1]),this.randomize(a[2],b[2])]};this.spawn=function(a){this.frame=this.def.initialframe==void 0?this.id%this.def.numFrames:this.randomize(this.def.initialframe[0],this.def.initialframe[1]);this.pos=this.randomize3(this.def.initialpos[0],this.def.initialpos[1]);if(this.def.worldSpace)this.pos=mat4.transformPoint(a,this.pos);a=Math.PI/180;this.size=this.def.initialsize?
this.randomize(this.def.initialsize[0],this.def.initialsize[1]):1;this.velocity=this.randomize3(this.def.initialvel[0],this.def.initialvel[1]);this.gravity=[this.def.gravity[0],this.def.gravity[1],this.def.gravity[2]];this.rotate=this.randomize(this.def.initialrot[0]*a,this.def.initialrot[1]*a);this.lifespan=this.randomize(this.def.lifespan[0],this.def.lifespan[1]);this.age=0;this.delta=[0,0,0];this.lastPos=vec3.add(this.pos,vec3.scale(this.velocity,-1/30));this.color=[1,1,1,1]}};
DoubleBuffer=function(a,b){this.buffer={};this.buffer[0]=new a(b);this.buffer[1]=new a(b);this.bufferIndex=0;this.flip=function(){this.bufferIndex=1-this.bufferIndex};this.front=function(){return this.buffer[this.bufferIndex]};this.back=function(){return this.buffer[1-this.bufferIndex]}};
particleBuffer=function(a,b,f){var g=g_Engine.getContext().renderer,h=g.ctx;s_particleShader=new jshader;s_particleShader.def={shaders:{defaultVShader:"assets/shaders/particle_vshader.glsl",defaultFShader:"assets/shaders/particle_fshader.glsl"},techniques:{defaultTechnique:[{vshader:"defaultVShader",fshader:"defaultFShader",attributes:{a_pos:{type:"vec4"},a_posId:{type:"float"},a_rotation:{type:"float"},a_size:{type:"float"},a_color:{type:"vec4"}},params:{u_projMatrix:{type:"mat4"},u_viewMatrix:{type:"mat4"},
u_worldMatrix:{type:"mat4"},u_particleSizeX:{type:"vec4"},u_particleSizeY:{type:"vec4"},u_particleRot:{type:"vec4"},u_particleColors:{type:"mat4"},u_textureSize:{type:"vec2"},u_frameSize:{type:"vec2"},s_texture0:{type:"tex2d"}}}]}};s_particleShader.init();s_particleTextures={};this.shader=s_particleShader;this.owner=b;if(a.texture&&s_particleTextures[a.texture]==void 0){s_particleTextures[a.texture]=g.createTexture(a.texture);if(!a.textureSize||!a.frameSize)a.textureSize=[],a.textureSize[0]=s_particleTextures[a.texture].image.width,
a.textureSize[1]=s_particleTextures[a.texture].image.height;if(!a.frameSize)a.frameSize=[],a.frameSize[0]=s_particleTextures[a.texture].image.width,a.frameSize[1]=s_particleTextures[a.texture].image.height}a.texture2&&s_particleTextures[a.texture2]==void 0&&(s_particleTextures[a.texture2]=g.createTexture(a.texture2));this.texture=s_particleTextures[a.texture];this.texture2=s_particleTextures[a.texture2];this.bounds={};this.bounds.min=vec3.zero();this.bounds.max=vec3.zero();this.srcBlend=a.srcBlend;
this.dstBlend=a.dstBlend;this.particles=[];this.posBuffer=new DoubleBuffer(Float32Array,16*f);this.posIdBuffer=new Float32Array(4*f);this.sizeBuffer=new DoubleBuffer(Float32Array,4*f);this.rotBuffer=new DoubleBuffer(Float32Array,4*f);this.colorBuffer=new DoubleBuffer(Float32Array,16*f);this.indexBuffer=new DoubleBuffer(Uint16Array,6*f);this.indexBuffer.front().numIndices=0;for(i=this.indexBuffer.back().numIndices=0;i<f;++i){this.particles.push(new particle(a,i));for(j=0;j<2;++j){b=this.posBuffer.front();
g=i*16;for(j=0;j<4;++j){var l=g+j*4;b[l+0]=0;b[l+1]=0;b[l+2]=0;b[l+3]=1}b=i*4;g=this.rotBuffer.front();g[b+0]=0;g[b+1]=0;g[b+2]=0;g[b+3]=0;b=i*4;this.sizeBuffer.front();g[b+0]=1;g[b+1]=1;g[b+2]=1;g[b+3]=1;b=i*4;this.colorBuffer.front()[b]=16777215;g=this.indexBuffer.front();l=i*6;g[l+0]=b+1;g[l+1]=b+0;g[l+2]=b+3;g[l+3]=b+1;g[l+4]=b+3;g[l+5]=b+2;this.posBuffer.flip();this.rotBuffer.flip();this.indexBuffer.flip()}b=i*4;this.posIdBuffer[b+0]=0;this.posIdBuffer[b+1]=1;this.posIdBuffer[b+2]=2;this.posIdBuffer[b+
3]=3}this.posBufferObject=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.posBufferObject);h.bufferData(h.ARRAY_BUFFER,this.posBuffer.front(),h.DYNAMIC_DRAW);this.posIdBufferObject=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.posIdBufferObject);h.bufferData(h.ARRAY_BUFFER,this.posIdBuffer,h.DYNAMIC_DRAW);this.rotBufferObject=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.rotBufferObject);h.bufferData(h.ARRAY_BUFFER,this.rotBuffer.front(),h.DYNAMIC_DRAW);this.sizeBufferObject=h.createBuffer();
h.bindBuffer(h.ARRAY_BUFFER,this.sizeBufferObject);h.bufferData(h.ARRAY_BUFFER,this.sizeBuffer.front(),h.DYNAMIC_DRAW);this.colorBufferObject=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.colorBufferObject);h.bufferData(h.ARRAY_BUFFER,this.colorBuffer.front(),h.DYNAMIC_DRAW);this.indexBufferObject=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,this.indexBufferObject);h.bufferData(h.ELEMENT_ARRAY_BUFFER,this.indexBuffer.front(),h.DYNAMIC_DRAW);this.end=this.start=0;this.cap=f;this.kill=function(){this.start++;
if(this.start>this.cap-1)this.start=0};this.emit=function(){this.end++;if(this.end>=this.cap)this.end=0;this.end==this.start&&this.kill();this.particles[this.end].spawn(this.owner.world)};this.sync=function(){this.posBuffer.flip();this.rotBuffer.flip();this.sizeBuffer.flip();this.colorBuffer.flip();this.indexBuffer.flip();var b=this.posBuffer.back(),f=this.rotBuffer.back(),g=this.sizeBuffer.back(),h=this.colorBuffer.back(),l=this.indexBuffer.back(),s=this.bounds.min,u=this.bounds.max;s[0]=1E10;s[1]=
1E10;s[2]=1E10;u[0]=-1E10;u[1]=-1E10;u[2]=-1E10;for(var v=0,x=this.start;;){var w=this.particles[x],y=w.age/w.lifespan,z=Math.min(y,0.999)+Math.floor(w.frame);if(y<1){var A=w.pos[0],C=w.pos[1],D=w.pos[2];A>u[0]&&(u[0]=A);A>u[1]&&(u[1]=C);A>u[2]&&(u[2]=D);A<s[0]&&(s[0]=A);A<s[1]&&(s[1]=C);A<s[2]&&(s[2]=D);y=x*16;for(j=0;j<4;++j){var B=y+j*4;b[B+0]=A;b[B+1]=C;b[B+2]=D;b[B+3]=z}z=x*4;y=0;a.velocityAligned&&(y=Math.atan2(w.delta[0],w.delta[1]));f[z+0]=w.rotate+y;f[z+1]=w.rotate+y;f[z+2]=w.rotate+y;f[z+
3]=w.rotate+y;g[z+0]=w.size;g[z+1]=w.size;g[z+2]=w.size;g[z+3]=w.size;y=x*16;for(j=0;j<4;++j)B=y+j*4,h[B+0]=w.color[0],h[B+1]=w.color[1],h[B+2]=w.color[2],h[B+3]=w.color[3];l[v+0]=z+1;l[v+1]=z+0;l[v+2]=z+3;l[v+3]=z+1;l[v+4]=z+2;l[v+5]=z+3;v+=6}if(x==this.end)break;x++;x==this.cap&&this.end!=this.cap&&(x=0)}l.numIndices=v;a.worldSpace||(b=mat4.mul(s,this.owner.world),f=mat4.mul(u,this.owner.world),f[0]>u[0]&&(u[0]=f[0]),f[1]>u[1]&&(u[1]=f[1]),f[2]>u[2]&&(u[2]=f[2]),b[0]<s[0]&&(s[0]=b[0]),b[1]<s[1]&&
(s[1]=b[1]),b[2]<s[2]&&(s[2]=b[2]))};this.update=function(b,f){var g=this.start;if(a.persist!=void 0&&a.persist==!1)for(;;){var h=this.particles[g];if(h.age<h.lifespan)break;this.kill();if(g==this.end)break;g++;g==this.cap&&this.end!=this.cap&&(g=0)}for(g=this.start;;){for(var h=this.particles[g],l=f.length;l;)f[--l].move(h,b);if(g==this.end)break;g++;g==this.cap&&this.end!=this.cap&&(g=0)}this.sync()};this.render=function(){var b=g_Engine.getContext().renderer,f=g_Engine.getContext().renderer.ctx,
g=this.posBuffer.front(),h=this.rotBuffer.front(),l=this.sizeBuffer.front(),s=this.colorBuffer.front(),u=this.indexBuffer.front();if(u.numIndices>0){var v=this.shader.defaultTechnique,b=b.cameraManager().getActiveCamera();a.worldSpace?(v.u_viewMatrix.set(b.view),v.u_worldMatrix.set(mat4.identity())):(v.u_viewMatrix.set(b.view),v.u_worldMatrix.set(this.owner.world));v.u_projMatrix.set(b.proj);v.u_particleSizeX.set(a.sizeX);v.u_particleSizeY.set(a.sizeY);v.u_particleRot.set(vec4.scale(a.rotation,Math.PI/
180));v.u_particleColors.set(mat4.transpose(a.colors));v.u_textureSize.set(a.textureSize);v.u_frameSize.set(a.frameSize);v.s_texture0.set(this.texture);v=this.shader.begin();for(passIdx=0;passIdx<v;++passIdx)this.shader.beginPass(passIdx),a.depthTest||f.disable(f.DEPTH_TEST),f.enable(f.BLEND),f.blendFunc(f[a.srcBlend],f[a.dstBlend]),f.enableVertexAttribArray(0),f.enableVertexAttribArray(1),f.enableVertexAttribArray(2),f.enableVertexAttribArray(3),f.enableVertexAttribArray(4),f.bindBuffer(f.ARRAY_BUFFER,
this.posBufferObject),f.bufferSubData(f.ARRAY_BUFFER,0,g),f.bindBuffer(f.ARRAY_BUFFER,this.posBufferObject),f.vertexAttribPointer(0,4,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,this.posIdBufferObject),f.vertexAttribPointer(1,1,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,this.rotBufferObject),f.bufferSubData(f.ARRAY_BUFFER,0,h),f.bindBuffer(f.ARRAY_BUFFER,this.rotBufferObject),f.vertexAttribPointer(2,1,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,this.sizeBufferObject),f.bufferSubData(f.ARRAY_BUFFER,
0,l),f.bindBuffer(f.ARRAY_BUFFER,this.sizeBufferObject),f.vertexAttribPointer(3,1,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,this.colorBufferObject),f.bufferSubData(f.ARRAY_BUFFER,0,s),f.bindBuffer(f.ARRAY_BUFFER,this.colorBufferObject),f.vertexAttribPointer(4,4,f.FLOAT,!1,0,0),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,this.indexBufferObject),f.bufferSubData(f.ELEMENT_ARRAY_BUFFER,0,u),f.drawElements(f.TRIANGLES,u.numIndices,f.UNSIGNED_SHORT,0),f.disable(f.BLEND),a.depthTest||f.enable(f.DEPTH_TEST),f.blendFunc(f.ONE,
f.ZERO),this.shader.endPass();this.shader.end()}}};
particleMoverDefault=function(){this.move=function(a,b){a.age+=b;a.def.persist?a.def.cycle&&a.age>a.lifespan*0.99?a.age-=a.lifespan*0.99:a.age=Math.min(a.age,a.lifespan*0.99):a.age=Math.min(a.age,a.lifespan);if(a.def.frameRate>0)a.frame+=a.def.frameRate*b,a.def.frameLoop?a.frame%=a.def.numFrames:a.frame=Math.min(a.def.numFrames-1,a.frame);var f=a.pos,g=a.gravity,h=a.velocity,l=a.pos,n=a.delta;h[0]+=g[0]*b;h[1]+=g[1]*b;h[2]+=g[2]*b;l[0]+=h[0]*b;l[1]+=h[1]*b;l[2]+=h[2]*b;n[0]=l[0]-f[0];n[1]=l[1]-f[1];
n[2]=l[2]-f[2];if(a.def.turbulence){var n=a.def.turbulence[0],o=a.def.turbulence[1],f=Math.random()*(o[0]-n[0])+n[0],g=Math.random()*(o[1]-n[1])+n[1],n=Math.random()*(o[2]-n[2])+n[2];h[0]+=f;h[1]+=g;h[2]+=n}a.def.jitter&&(g=a.def.jitter[0],n=a.def.jitter[1],h=Math.random()*(n[0]-g[0])+g[0],f=Math.random()*(n[1]-g[1])+g[1],g=Math.random()*(n[2]-g[2])+g[2],l[0]+=h,l[1]+=f,l[2]+=g)}};
particleEmitter=function(a){this.def=a;this.world=mat4.identity();this.pbuffer=new particleBuffer(this.def.particle,this,this.def.maxParticles);this.movers=[];var b=particleMoverDefault;a.particle.moverFunc&&(b=eval(a.particle.moverFunc));this.movers.push(new b);this.emitCounter=this.lastEmitTime=this.localTime=0;this.firstUpdate=!0;this.attachToNode=function(a){this.controller=a};this.update=function(a){this.localTime+=a;if(this.firstUpdate)this.lastEmitTime=this.localTime,this.firstUpdate=!1;if(this.def.emit!=
void 0&&this.def.emit==!1)this.lastEmitTime=this.localTime-1/this.def.emitRate;for(var b=this.def.maxParticles,h=this.def.emitOnce,l=this.def.emit==void 0||this.def.emit==!0?Math.floor((this.localTime-this.lastEmitTime)*this.def.emitRate):0;l--;){if(h&&this.emitCounter++>=b)break;this.pbuffer.emit(this.world);this.lastEmitTime=this.localTime}this.pbuffer.update(a,this.movers)}};
particleSys=function(a){loaded=typeof loaded=="undefined"?{}:loaded;this.node=this.def=null;this.world=mat4.identity();this.emitters={};this.init=function(){if(this.def!=null){for(e in this.def.emitters)this.emitters[e]=new particleEmitter(this.def.emitters[e]);this.bounds={};this.bounds.min=vec3.zero();this.bounds.max=vec3.zero()}};if(loaded[a])this.def=loaded[a],this.init();else{var b=new XMLHttpRequest;b.sender=this;b.onreadystatechange=function(){if(b.readyState==4)b.status==200||window.location.href.indexOf("http")==
-1?(b.sender.def=eval("("+b.responseText+")"),loaded[a]=b.sender.def,b.sender.init()):alert("An error has occured loading particle system.")};b.open("GET",a,!0);b.send(null)}this.update=function(a){if(this.def!=null){var b=this.bounds.min,h=this.bounds.max;b[0]=1E10;b[1]=1E10;b[2]=1E10;h[0]=-1E10;h[1]=-1E10;h[2]=-1E10;var l=this.node?this.node.world:this.world;for(em in this.emitters){var n=this.emitters[em];n.world=l;n.update(a);var o=n.pbuffer.bounds.min,n=n.pbuffer.bounds.max;o[0]<b[0]&&(b[0]=
o[0]);o[1]<b[1]&&(b[1]=o[1]);o[2]<b[2]&&(b[2]=o[2]);n[0]>h[0]&&(h[0]=n[0]);n[1]>h[1]&&(h[1]=n[1]);n[2]>h[2]&&(h[2]=n[2])}}};this.render=function(){if(this.def!=null){for(em in this.emitters)this.emitters[em].pbuffer.render();g_particleStats&&g_particleStats.report(this)}};this.attachToNode=function(a){this.node=a}};g_particleSystemManager=new objectManager;g_particleSystemManager.update=function(a){for(var b=this.objects.length-1;b>=0;){var f=this.objects[b];f&&f.update(a);b--}};
g_particleSystemManager.render=function(){for(var a=0;a<this.objects.length;){var b=this.objects[a];b&&b.render();a++}};function RunState(a,b){this.name="RunState";this.userRunState=a!=void 0?a:new RDGEState;this.hasUserState=a!=void 0?!0:!1;this.renderer=b.renderer;this.initialized=!1}
RunState.prototype.Init=function(){this.initialized=!0;var a=this.renderer.vpWidth,b=this.renderer.vpHeight,f=new camera;f.setPerspective(45,a/b,1,100);f.setLookAt([0,0,20],[0,0,0],vec3.up());this.renderer.cameraManager().setActiveCamera(f);this.hasUserState&&this.userRunState.init!=void 0&&this.userRunState.init();if(this.hasUserState&&this.userRunState&&this.userRunState.onRunState)this.userRunState.onRunState()};
RunState.prototype.ReInit=function(){if(this.initialized){if(this.hasUserState&&this.userRunState&&this.userRunState.onRunState)this.userRunState.onRunState()}else this.Init()};RunState.prototype.Update=function(a){this.userRunState.update(a)};RunState.prototype.Resize=function(){if(g_Engine.lastWindowWidth==window.innerWidth&&g_Engine.lastWindowHeight==window.innerHeight)this.userRunState.resize(),g_Engine.lastWindowWidth=window.innerWidth,g_Engine.lastWindowHeight=window.innerHeight};
RunState.prototype.Draw=function(){this.userRunState.draw()};RunState.prototype.Shutdown=function(){this.userRunState.shutdown!=void 0&&this.userRunState.shutdown()};RunState.prototype.LeaveState=function(){if(this.userRunState.onComplete!=void 0)this.userRunState.onComplete()};
debugCamHandler=function(){this.pos=vec2.zero();this.lastPos=vec2.zero();this.vel=vec2.zero();this.mouseDown=!1;this.onMouseDown=function(a){if(!g_enableFlyCam)return!1;this.mouseDown=!0;this.lastPos=this.pos=[a.pageX,g_height-a.pageY];return!0};this.onMouseUp=function(){if(!g_enableFlyCam)return!1;this.mouseDown=!1;this.lastPos=this.pos;return!0};this.onMouseMove=function(a){if(!g_enableFlyCam)return!1;this.pos=[a.pageX,g_height-a.pageY];return!0};this.update=function(){if(this.mouseDown){var a=
this.renderer.cameraManager().getActiveCamera(),f=vec2.sub(this.pos,this.lastPos);f[0]/=g_width;f[1]/=g_height;mat4.rotateX(mat4.identity(),f[1]*5);f=mat4.rotateY(mat4.identity(),-f[0]*5);f=mat4.mul(f,a.world);a.setWorld(f)}};var a=this;setInterval(function(){a.update()},16)};function SceneRender(){this.shaderProgram=g_Engine.defaultContext.shaderProg}String.prototype.contains=function(a){return this.indexOf(a)!=-1};
SceneRender.prototype.process=function(a,b){var f=g_Engine.getContext().renderer;a.Apply(this.shaderProgram);this.shaderProgram.RDGEUniform.SetUni("u_shadowLightWorld",g_mainLight.world);this.shaderProgram.RDGEUniform.SetUni("u_shadowBiasMatrix",g_mainLight.shadowMatrix);this.shaderProgram.RDGEUniform.SetUni("u_vShadowLight",g_mainLight.view);if(((b.materialNode||{}).meshNode||{})!==void 0&&b.materialNode!==void 0){_bindUniforms(this.shaderProgram);var g;g=b.materialNode.meshNode.mesh.name!==void 0?
g_meshMan.getModelByName(b.materialNode.meshNode.mesh.name):g_meshMan.getModelByName(b.materialNode.meshNode.mesh.attrib.name);g!=null&&(f.ctx.uniform1f(uniformEnableGlow,0),f.disableCulling(),g_wireframe?f.drawIndexedPrimitiveWireFrame(g.primitive,this.shaderProgram,{vert:"vec3",normal:"vec3",texcoord:"vec2"}):f.drawIndexedPrimitive(g.primitive,this.shaderProgram,{vert:"vec3",normal:"vec3",texcoord:"vec2"}))}};function GenerateGlowMap(){this.shaderProgram=g_Engine.defaultContext.shaderProg}
GenerateGlowMap.prototype.process=function(a,b){var f=g_Engine.getContext().renderer;a.Apply(this.shaderProgram);if(((b.materialNode||{}).meshNode||{})!==void 0&&b.materialNode!==void 0){_bindUniforms(this.shaderProgram);var g;g=b.materialNode.meshNode.mesh.name!==void 0?g_meshMan.getModelByName(b.materialNode.meshNode.mesh.name):g_meshMan.getModelByName(b.materialNode.meshNode.mesh.attrib.name);g!=null&&(f.ctx.uniform1f(uniformEnableGlow,1),f.drawIndexedPrimitive(g.primitive,this.shaderProgram,{vert:"vec3",
normal:"vec3",texcoord:"vec2"}))}};function GenerateDepthMap(){this.shaderProgram=g_depthMapGenShader}
GenerateDepthMap.prototype.process=function(a,b){var f=g_Engine.getContext().renderer;a.Apply(!1);this.shaderProgram.RDGEUniform.SetUni("u_frustumFarZ",[f.cameraManager().getActiveCamera().zFar()]);var g=null;if(((b.materialNode||{}).meshNode||{})!==void 0&&b.materialNode!==void 0)_bindUniforms(this.shaderProgram),g=b.materialNode.meshNode.mesh.name!==void 0?g_meshMan.getModelByName(b.materialNode.meshNode.mesh.name):g_meshMan.getModelByName(b.materialNode.meshNode.mesh.attrib.name),g!=null&&(f.enablePolyOffsetFill(),
f.drawIndexedPrimitive(g.primitive,this.shaderProgram,{vert:"vec3",normal:"vec3",texcoord:"vec2"}),f.disablePolyOffsetFill())};function GenerateHighResDepthMap(){this.shaderProgram=g_hrDepthMapGenShader;this.cullFront=!0}
GenerateHighResDepthMap.prototype.process=function(a,b){var f=g_Engine.getContext().renderer;a.Apply(!1);this.shaderProgram.RDGEUniform.SetUni("u_frustumFarZ",[f.cameraManager().getActiveCamera().zFar()]);var g=null;if(((b.materialNode||{}).meshNode||{})!==void 0&&b.materialNode!==void 0)_bindUniforms(this.shaderProgram),g=b.materialNode.meshNode.mesh.name!==void 0?g_meshMan.getModelByName(b.materialNode.meshNode.mesh.name):g_meshMan.getModelByName(b.materialNode.meshNode.mesh.attrib.name),g!=null&&
(f.disableCulling(),f.enablePolyOffsetFill(),this.cullFront?f.cullFrontFace():f.cullBackFace(),f.drawIndexedPrimitive(g.primitive,this.shaderProgram,{vert:"vec3",normal:"vec3",texcoord:"vec2"}),f.disableCulling(),f.cullBackFace(),f.disablePolyOffsetFill())};function SceneCreateShadowMap(){}SceneCreateShadowMap.prototype.process=function(){};var loadTag=document.getElementById("loading");function LoadState(a,b){this.name="LoadState";this.userRunState=a!=void 0?a:new RDGEState;this.hasUserState=a!=void 0?!0:!1;this.renderer=b.renderer;this.loadingDone=!1;this.stateManager=b.ctxStateManager;this.sceneLoadQueue=[];this.textureLoadQueue=[]}LoadState.prototype.loadScene=function(a,b){var f=new sceneRequestDef(a,b);f.doSceneRequest=!0;this.sceneLoadQueue.push(f)};
LoadState.prototype.loadTexture=function(a){this.stateManager.currentState().name!="LoadState"&&this.stateManager.PushState(this.stateManager.RDGEInitState,"noInit");this.textureLoadQueue.push(a)};LoadState.prototype.Init=function(){this.sceneName&&this.loadScene("assets_web/mesh/"+this.sceneName+".json",this.sceneName);if(this.hasUserState&&this.userRunState&&this.userRunState.onLoadState)this.userRunState.onLoadState()};
LoadState.prototype.ReInit=function(){if(this.hasUserState&&this.userRunState&&this.userRunState.onLoadState)this.userRunState.onLoadState()};LoadState.prototype.Resize=function(){if(g_Engine.lastWindowWidth==window.innerWidth&&g_Engine.lastWindowHeight==window.innerHeight)this.userRunState.resize(),g_Engine.lastWindowWidth=window.innerWidth,g_Engine.lastWindowHeight=window.innerHeight};
LoadState.prototype.Update=function(a){var b=this.sceneLoadQueue.length-1;if(b>-1)if(b=this.sceneLoadQueue[b],g_meshMan.processMeshData(),b.doSceneRequest)b.requestScene();else if(b.requestComplete)b.sceneBeginProcessing?(b.scene=new SceneGraph(b.rawData),b.scene.enableShadows(!0),g_Engine.AddScene(b.name,b.scene),b.scene.Traverse(b.sceneProcessor,!1),b.sceneBeginProcessing=!1):b.processingComplete()&&(b=this.sceneLoadQueue.shift(),this.userRunState.onComplete(b.name,b.scene));for(;this.textureLoadQueue.length>
0;)this.renderer.commitTexture(this.textureLoadQueue.shift());if(0==this.sceneLoadQueue.length&&0==this.textureLoadQueue.length&&(g_Engine.getContext().ctxStateManager.PopState(),loadTag))loadTag.innerHTML="done";g_Engine.getContext().getScene()&&g_Engine.getContext().getScene()!="not-ready"&&this.stateManager.RDGERunState.initialized&&this.userRunState.update(a)};
LoadState.prototype.Draw=function(){this.renderer._clear();g_Engine.getContext().getScene()&&g_Engine.getContext().getScene()!="not-ready"&&this.stateManager.RDGERunState.initialized&&this.userRunState.draw()};LoadState.prototype.Shutdown=function(){};LoadState.prototype.LeaveState=function(){if(this.userRunState.onComplete!=void 0)this.userRunState.onComplete()};
LoadState.prototype.MakeSceneRequest=function(a,b){this.hasScene=!0;this.lastSceneName=b;var f=new XMLHttpRequest;f.initState=this;g_Engine.getContext().sceneGraphMap[b]="not-ready";f.onreadystatechange=function(){if(f.readyState==4)f.status==200||window.location.href.indexOf("http")==-1?(this.initState.scene=eval("("+f.responseText+")"),this.initState.loadingDone=!0):alert("An error has occured making the request")};f.open("GET",a,!0);f.send(null)};
function SetupScene(){this.renderer=g_Engine.getContext().renderer;this.meshLoadingMap=[];this.onMeshLoaded=function(a){if(this.meshLoadingMap[a])this.meshLoadingMap[a].stillLoading=!1};g_meshMan.addOnLoadedCallback(this)}
SetupScene.prototype.process=function(a,b){verifyTransformNode(a);a.parent=b;if(a.local!==void 0)a.local=mat4.transpose(a.local);if(((a.materialNode||{}).meshNode||{})!="undefined"&&a.materialNode!==void 0){var f=g_meshMan.loadMesh(a.materialNode.meshNode.mesh);a.meshes.push(a.materialNode.meshNode);f==null?this.meshLoadingMap[a.materialNode.meshNode.mesh.name]={stillLoading:!0,remotelyLoading:!1}:f.primitive?this.renderer.createPrimitive(f.primitive):this.meshLoadingMap[a.materialNode.meshNode.mesh.name]||
(this.meshLoadingMap[a.materialNode.meshNode.mesh.name]={stillLoading:!0,remotelyLoading:!0});verifyMaterialNode(a.materialNode);f=[];f.TEX_DIF={slot:0,uni:"colMap"};f.TEX_SPEC={slot:1,uni:"envMap"};f.TEX_NORM={slot:2,uni:"normalMap"};f.TEX_GLOW={slot:3,uni:"glowMap"};for(var g=a.materialNode.textureList,h=[],l=0;l<g.length;++l){var n=this.renderer.getTextureByName(g[l].name);h[l]={name:f[g[l].type].uni,handle:n,unit:f[g[l].type].slot,type:UNIFORMTYPE.TEXTURE2D}}a.materialNode.textureList=h}if((a.lightNode||
{})!="undefined"&&a.lightNode!==void 0)a.lightNode.parent=a,g_Engine.lightManager.setMapping(a.lightNode,a.lightNode.links)};
sceneRequestDef=function(a,b){this.name=b;this.addr=a;this.requestComplete=this.sceneBeginProcessing=!1;this.sceneProcessor=new SetupScene;this.doSceneRequest=!1;this.processingComplete=function(){for(var a in this.sceneProcessor.meshLoadingMap)if(this.sceneProcessor.meshLoadingMap[a].stillLoading==!1)this.sceneProcessor.meshLoadingMap[a].remotelyLoading==!0&&this.sceneProcessor.renderer.createPrimitive(g_meshMan.getModelByName(a).primitive);else return!1;return!0};this.requestScene=function(){this.doSceneRequest=
!1;var b=new XMLHttpRequest;b.handler=this;g_Engine.getContext().sceneGraphMap[name]="not-ready";b.onreadystatechange=function(){if(b.readyState==4)b.status==200||window.location.href.indexOf("http")==-1?(this.handler.rawData=eval("("+b.responseText+")"),this.handler.requestComplete=!0,this.handler.sceneBeginProcessing=!0):alert("An error has occured making the request")};b.open("GET",a,!0);b.send(null)}};g_Engine=new Engine;g_height=g_width=0;g_cam=null;g_camMoveSpeed=25;gl=null;g_worldObjects=[];g_alphaTex=g_defaultTex=g_shaderMan=null;g_hiQu=!0;g_meshMan=null;function RDGEState(){this.init=function(){};this.update=function(){};this.draw=function(){};this.resize=function(){};this.shutdown=function(){};this.onComplete=function(){}}
function validateUserState(a){if(!a.init)a.init=function(){};if(!a.update)a.update=function(a){var f=g_Engine.getContext().currentScene,f=g_Engine.getScene(f);f!=null&&f.update(a)};if(!a.draw)a.draw=function(){var a=g_Engine.getContext().currentScene,a=g_Engine.getScene(a);a!=null&&a.render()};if(!a.resize)a.resize=function(){};if(!a.shutdown)a.shutdown=function(){};if(!a.onComplete)a.onComplete=function(){}}
function RDGEStart(a){var b=a;typeof a==="string"&&(b=document.getElementById(a));if(b)g_Engine.registerCanvas(b),b.task=new RDGETask(b,!0),g_shaderMan||(g_shaderMan=new ShaderManager),g_meshMan||(g_meshMan=new MeshManager),g_Engine.initializeComplete||g_Engine.init()}function RDGEStop(){RDGEShutdown!=void 0&&RDGEShutdown()}function IRuntime(){this.Shutdown=this.Draw=this.Update=this.Resize=this.ReInit=this.init=null}g_poolList=[];
function ConnPoll(){for(var a=g_poolList.length,b=0;b<a;++b)g_poolList[b].Poll()}RDGERequestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();
RDGETask=function(){var a={};return function(b,f){this.id=b.id;this.lastTime=this.currTime=0;this.running=!1;this.context=null;if(b){this.context=g_Engine.ctxMan.handleToObject(b.rdgeCtxHandle);a[this.id]=function(){if(g.running)g.currTime=(new Date).getTime(),g.step((g.currTime-g.lastTime)/1E3),RDGERequestAnimationFrame(a[g.id],b),g.lastTime=g.currTime};this.start=function(){this.running=!0;this.lastTime=this.currTime=(new Date).getTime();a[this.id]()};this.stop=function(){this.running=!1};this.kill=
function(){this.running=!1;a[this.id]=null};this.step=function(a){contextManager.currentCtx=this.context;this.context.fpsTracker.sample();this.context.ctxStateManager.tick(a)};var g=this;f&&g.start()}}}();var g_dbgPanel=null;
function utilDbgPanel(a,b){this.id=a;this.root="#"+a;this.accordion=this.root+" .dbgpanel-accordion";this.categories={};this.counter=0;$(this.root).addClass("dbgpanel-outer ui-widget-content");$(this.root).draggable({handle:this.root,containment:"body"});$(this.root).resizable({minWidth:$(this.root).width(),minHeight:$(this.root).height()});$(this.root).append('<h3 class="dbgpanel-title">'+b+"</h3>");$(this.root).append('<div class="dbgpanel-accordion" />');$(this.accordion).accordion({clearStyle:!0})}
utilDbgPanel.prototype.appendLabel=function(a,b){var f=this.getCategorySelector(a);$(f).append('<p class="dbgpanel-label">'+b+"</p>")};
utilDbgPanel.prototype.appendBoolean=function(a,b,f,g){var a=this.getCategorySelector(a),h=this.getUniqueID();$(a).append('<div class="dbgpanel-button"><input type="checkbox" id="'+h+'"><label for="'+h+'" class="dbgpanel-button-label"/></div>');$("#"+h).prop("checked",b||b!=0);$("#"+h).button({label:f});$("#"+h).change(function(a){b=a.target.checked?typeof b=="number"?1:!0:typeof b=="number"?0:!1;g&&g(b)})};
utilDbgPanel.prototype.appendNumber=function(a,b,f,g,h,l){var a=this.getCategorySelector(a),n=this.getUniqueID();$(a).append('<div id="'+n+'" class="dbgpanel-slider"/>');$("#"+n).slider({min:f,max:g,value:b,step:h,slide:function(a,f){b=f.value;l&&l(b)},change:function(a,f){b=f.value;l&&l(b)}})};utilDbgPanel.prototype.getUniqueID=function(){return this.id+"_"+this.counter++};
utilDbgPanel.prototype.getCategorySelector=function(a){var b=this.categories[a];b==void 0&&(b=this.getUniqueID(),$(this.accordion).accordion("destroy"),$(this.accordion).append('<h3 class="dbgpanel-category-title">'+a+'</h3><div id="'+b+'" class="dbgpanel-category-content"></div>'),$(this.accordion).accordion({clearStyle:!0}),b="#"+b,this.categories[a]=b);return b};g_sg=null;g_initializedDbgPanel=g_wireframe=!1;enableNormalMapping=g_showBloom=g_showScene=!0;g_bloomIntensity1=0.7;
g_bloomIntensity2=0.5;g_bloomIntensity3=1;g_bloomIntensity4=0.2;g_mainLight=null;g_shadowLigthSize=7.93;g_shadowColor=[1-0.922,1-0.7373,1-0.4824,0.5];g_depthMapGenShader=null;g_enableShadowMapping=g_showSSAO=!0;g_sampleRadius=0.36;g_intensity=0.75;g_distScale=0.6;g_bias=0.05;g_animationRate=1;
utilDbgPanel.prototype.enableFXDebug=function(){this.appendBoolean("General",g_showScene,"Enable scene render",function(a){g_showScene=a});this.appendBoolean("General",g_wireframe,"Enable wireframe",function(a){g_wireframe=a});this.appendBoolean("General",!0,"Enable frustum culling",function(a){g_sg.frustumCulling=a});this.appendBoolean("General",enableNormalMapping,"Enable normal mapping",function(a){enableNormalMapping=a});this.appendBoolean("Shadows",g_enableShadowMapping,"Enable shadow mapping",
function(a){var b=g_Engine.getContext().getScene();b.renderGraph.shadowDepthMap.visibility=!a?0:1;b=g_Engine.getContext().getScene();b.renderGraph.finalPass.shader.screenQuad.u_shadowMap.set("assets/images/white");b.renderGraph.finalPass.textures[2].enabled=a});this.appendLabel("Shadows","Light Size");this.appendNumber("Shadows",g_shadowLigthSize,1,32,0.01,function(a){g_Engine.getContext().getScene().renderGraph.shadowMap.shader.shadowMap.u_lightSize.set([a])});this.appendLabel("Shadows","Color-R");
this.appendNumber("Shadows",g_shadowColor[0],0,1,0.0010,function(a){var b=g_Engine.getContext().getScene();g_shadowColor[0]=1-a;b.renderGraph.shadowMap.shader.shadowMap.u_shadowColor.set(g_shadowColor)});this.appendLabel("Shadows","Color-G");this.appendNumber("Shadows",g_shadowColor[1],0,1,0.0010,function(a){var b=g_Engine.getContext().getScene();g_shadowColor[1]=1-a;b.renderGraph.shadowMap.shader.shadowMap.u_shadowColor.set(g_shadowColor)});this.appendLabel("Shadows","Color-B");this.appendNumber("Shadows",
g_shadowColor[2],0,1,0.0010,function(a){var b=g_Engine.getContext().getScene();g_shadowColor[2]=1-a;b.renderGraph.shadowMap.shader.shadowMap.u_shadowColor.set(g_shadowColor)});this.appendLabel("Shadows","Color-A");this.appendNumber("Shadows",g_shadowColor[3],0,1,0.0010,function(a){var b=g_Engine.getContext().getScene();g_shadowColor[3]=a;b.renderGraph.shadowMap.shader.shadowMap.u_shadowColor.set(g_shadowColor)});this.appendLabel("Animation","Rate");this.appendNumber("Animation",g_animationRate,-4,
4,0.1,function(a){g_animationRate=a});this.appendBoolean("Bloom",g_showBloom,"Enable bloom",function(a){var b=g_Engine.getContext().getScene();b.renderGraph.glowMap.visibility=!a?0:1;b=g_Engine.getContext().getScene();b.renderGraph.finalPass.shader.screenQuad.u_glowFinal.set("assets/images/black");b.renderGraph.finalPass.textures[0].enabled=a});this.appendLabel("Bloom","1024x1024 mip weight");this.appendNumber("Bloom",g_bloomIntensity1,0,1.5,0.01,function(a){g_Engine.getContext().getScene().renderGraph.blurFull.shader.gaussianBlur.u_weight.set([a])});
this.appendLabel("Bloom","256x256 mip weight");this.appendNumber("Bloom",g_bloomIntensity2,0,1.5,0.01,function(a){g_Engine.getContext().getScene().renderGraph.blurQuater.shader.gaussianBlur.u_weight.set([a])});this.appendLabel("Bloom","128x128 mip weight");this.appendNumber("Bloom",g_bloomIntensity3,0,1.5,0.01,function(a){g_Engine.getContext().getScene().renderGraph.blurThreeQuater.shader.gaussianBlur.u_weight.set([a])});this.appendBoolean("Ambient Occlusion",g_showSSAO,"Enable SSAO",function(a){var b=
g_Engine.getContext().getScene();b.renderGraph.depth_map.visibility=!a?0:1;b=g_Engine.getContext().getScene();b.renderGraph.finalPass.shader.screenQuad.u_ssaoRT.set("assets/images/black");b.renderGraph.finalPass.textures[1].enabled=a});this.appendLabel("Ambient Occlusion","Sampling radius");this.appendNumber("Ambient Occlusion",g_sampleRadius,0,5,1.0E-4,function(a){g_Engine.getContext().getScene().renderGraph.SSAO.shader.ssao.u_artVals.data[0]=a});this.appendLabel("Ambient Occlusion","Intensity");
this.appendNumber("Ambient Occlusion",g_intensity,0,3,1.0E-4,function(a){g_Engine.getContext().getScene().renderGraph.SSAO.shader.ssao.u_artVals.data[1]=a});this.appendLabel("Ambient Occlusion","Distance scaling");this.appendNumber("Ambient Occlusion",g_distScale,0,2,1.0E-4,function(a){g_Engine.getContext().getScene().renderGraph.SSAO.shader.ssao.u_artVals.data[2]=a});this.appendLabel("Ambient Occlusion","Bias");this.appendNumber("Ambient Occlusion",g_bias,0,0.5,1.0E-4,function(a){g_Engine.getContext().getScene().renderGraph.SSAO.shader.ssao.u_artVals.data[3]=
a})};ubershader=function(a){var b=new XMLHttpRequest;b.open("GET","assets/shaders/ub_vshader.glsl",!1);b.send(null);if(b.status==200)vshader=b.responseText;b.open("GET","assets/shaders/ub_fshader.glsl",!1);b.send(null);if(b.status==200)fshader=b.responseText;var f="";typeof a.material!="undefined"&&(f+="#define MATERIAL\n");if(typeof a.lighting!="undefined"){f+="#define LIGHTING\n";f+="#define SPECULAR\n";for(i=0;i<4;++i){var b=a.lighting["light"+i],g;if(typeof b!="undefined"){switch(b.type){case "directional":g=
0;break;case "point":g=1;break;case "spot":g=2}f+="#define LIGHT_"+i+" "+g+"\n";f+="#define LIGHT_"+i+"_SPECULAR\n"}}}typeof a.diffuseMap!="undefined"&&(f+="#define DIFFUSE_MAP\n");typeof a.normalMap!="undefined"&&(f+="#define NORMAL_MAP\n");typeof a.specularMap!="undefined"&&(f+="#define SPECULAR_MAP\n");typeof a.environmentMap!="undefined"&&(f+="#define ENVIRONMENT_MAP\n");vshader=f+vshader;fshader=f+fshader;uberJShader=new jshader;uberJShader.def={shaders:{defaultVShader:vshader,defaultFShader:fshader},
techniques:{defaultTechnique:[{vshader:"defaultVShader",fshader:"defaultFShader",attributes:{a_pos:{type:"vec3"},a_normal:{type:"vec3"},a_texcoord:{type:"vec2"}},params:{specularColor:"u_specularColor"},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"FRONT"}}]}};uberJShader.init();g=uberJShader.defaultTechnique;typeof a.material!="undefined"&&(g.u_ambientColor.set(a.material.ambientColor),g.u_diffuseColor.set(a.material.diffuseColor),g.u_specularColor&&g.u_specularColor.set(a.material.specularColor),
g.u_specularPower&&g.u_specularPower.set([a.material.specularPower]));if(typeof a.lighting!="undefined")for(i=0;i<4;++i)b=a.lighting["light"+i],typeof b!="undefined"&&(b.type=="directional"?(paramBlock["u_light"+i+"Dir"]={type:"vec3"},g["u_light"+i+"Dir"].set(b.direction||[0,0,1])):(b.type=="spot"?(paramBlock["u_light"+i+"Spot"]={type:"vec2"},g["u_light"+i+"Position"].set(b.position||[0,0,0]),f=Math.PI/180,g["u_light"+i+"Spot"].set([Math.cos((b.spotInnerCutoff||45)*f),Math.cos((b.spotOuterCutoff||
90)*f)])):g["u_light"+i+"Position"].set(b.position||[0,0,0]),g["u_light"+i+"Atten"].set(b.attenuation||[1,0,0])),g["u_light"+i+"Color"].set(b.diffuseColor||[1,1,1,1]),g["u_light"+i+"Specular"].set(b.specularColor||[1,1,1,1]));g.u_uvMatrix&&g.u_uvMatrix.set(a.uvTransform||mat4.identity());renderer=g_Engine.getContext().renderer;g.s_diffuseMap&&typeof a.diffuseMap!="undefined"&&g.s_diffuseMap.set(renderer.getTextureByName(a.diffuseMap.texture,a.diffuseMap.wrap,a.diffuseMap.mips));g.s_normalMap&&typeof a.normalMap!=
"undefined"&&g.s_normalMap.set(renderer.getTextureByName(a.normalMap.texture,a.normalMap.wrap,a.normalMap.mips));g.s_specMap&&typeof a.specularMap!="undefined"&&g.s_specMap.set(renderer.getTextureByName(a.specularMap.texture,a.specularMap.wrap));g.s_envMap&&typeof a.environmentMap!="undefined"&&g.s_envMap.set(renderer.getTextureByName(a.environmentMap.texture,a.environmentMap.wrap));g.u_envReflection&&g.u_envReflection.set([a.environmentMap.envReflection||1]);return uberJShader};
/* //////////////////////////////////////////////////////////////////////////////
                  RDGE v1.5

                Copyright (c) 2008-2011 Human Engines Incorporated.
                             All Rights Reserved.
                           Human Engines Proprietary

////////////////////////////////////////////////////////////////////////////// */

/*
 *	A list of shared parameters that all shaders can support (the engine always try to bind these uniforms)
 *	These parameters are compiled into all jshaders and can be set from any jshader
 *	with a call to jshader.global.u_matDiffuse.set([1,0,0,1]) if the jshader depends on that parameter.
 *	To set directly call rdgeGlobalParameters.'param'.set(x), for example rdgeGlobalParameters.u_lightPos.set([1,1,1])
 *	The values can be added to a jshaders params list - this will creating local jshader memory that binds to the parameter
 *	this parameter can be used to set the value for that shader but will not override the global setting
 *	The values set here are the default global values.
 *	note: the rdge_lights substructure can be ignored, the final parameter list contains only the uniform objects
 */

rdgeGlobalParameters =
{
	"u_projMatrix":			{'type': 'mat4',  'data': mat4.identity()},	
	"u_mvMatrix":			{'type': 'mat4',  'data': mat4.identity()},	
	"u_invMvMatrix":		{'type': 'mat4',  'data': mat4.identity()},	
	"u_normalMatrix":		{'type': 'mat4',  'data': mat4.identity()},	
	"u_worldMatrix":		{'type': 'mat4',  'data': mat4.identity()},	
	"u_viewMatrix":			{'type': 'mat4',  'data': mat4.identity()},
	"u_invViewMatrix":		{'type': 'mat4',  'data': mat4.identity()},
	"u_invWorldMatrix":		{'type': 'mat4',  'data': mat4.identity()},	
	"u_inv_viewport_width": {'type': 'float', 'data': [1]},
	"u_inv_viewport_height":{'type': 'float', 'data': [1]},
	"u_lightPos":			{'type': 'vec3',  'data': [-20.0, 50.0, 20.0]},		
	"u_lightDiff":			{'type': 'vec4',  'data': [0.8, 0.8, 0.8, 1]},		
	"u_lightAmb":			{'type': 'vec4',  'data': [1.0000, 1.0000, 1.0000, 1.0]},	
	"rdge_lights": {
	"u_light0Pos":			{'type': 'vec3',  'data': [-20.0, 50.0, 20.0]},		
	"u_light0Diff":			{'type': 'vec4',  'data': [0.8, 0.8, 0.8, 1]},		
	"u_light0Amb":			{'type': 'vec4',  'data': [0.0008, 0.0008, 0.0008, 1.0]},		
	"u_light0Spec":			{'type': 'vec4',  'data': [1.0, 1.0, 1.0, 1.0]},		
	"u_light1Pos":			{'type': 'vec3',  'data': [0.0, 0.0, 0.0]},		
	"u_light1Diff":			{'type': 'vec4',  'data': [0.0, 0.0, 0.0, 0.0]},		
	"u_light1Amb":			{'type': 'vec4',  'data': [0.5, 0.5, 0.5, 1.0]},
	"u_light1Spec":			{'type': 'vec4',  'data': [1.0, 1.0, 1.0, 1.0]},		
	"u_light2Pos":			{'type': 'vec3',  'data': [0.0, 0.0, 0.0]},		
	"u_light2Diff":			{'type': 'vec4',  'data': [0.0, 0.0, 0.0, 1.0]},		
	"u_light2Amb":			{'type': 'vec4',  'data': [0.5, 0.5, 0.5, 1.0]},
	"u_light2Spec":			{'type': 'vec4',  'data': [1.0, 1.0, 1.0, 1.0]},		
	"u_light3Pos":			{'type': 'vec3',  'data': [0.0, 0.0, 0.0]},		
	"u_light3Diff":			{'type': 'vec4',  'data': [0.8, 0.8, 0.8, 1]},		
	"u_light3Amb":			{'type': 'vec4',  'data': [0.5, 0.5, 0.5, 1.0]},
	"u_light3Spec":			{'type': 'vec4',  'data': [1.0, 1.0, 1.0, 1.0]}},		
	"colMap":				{'type': 'tex2d', 'data': "assets/images/white.png"},	
	"envMap":				{'type': 'tex2d', 'data': null},	
	"normalMap":			{'type': 'tex2d', 'data': null},	
	"glowMap":				{'type': 'tex2d', 'data': "assets/images/black.png"},	
	"u_shadowDepthMap":		{'type': 'tex2d', 'data': null},	
	"u_depthMap":			{'type': 'tex2d', 'data': null},	
	"u_matAmbient":			{'type': 'vec4',  'data': [1.00,1.00,1.00, 1]},		
	"u_matDiffuse":			{'type': 'vec4',  'data': [1.0, 1.0, 1.0, 1.0]},		
	"u_matSpecular":		{'type': 'vec4',  'data': [1.0, 1.0, 1.0, 1.0]},		
	"u_matShininess":		{'type': 'float', 'data': [128.0]},		
	"u_matEmission":		{'type': 'float', 'data': [0.0, 0.0, 0.0, 1.0]},		
	"u_frustumFarZ":		{'type': 'float', 'data': [1000.0]},		
	"u_shadowLightWorld":	{'type': 'mat4',  'data': mat4.identity()},	
	"u_shadowBiasMatrix":	{'type': 'mat4',  'data': mat4.identity()},
	"u_vShadowLight":		{'type': 'mat4',  'data': mat4.identity()},	
	"u_shadowBPV":			{'type': 'mat4',  'data': mat4.identity()},	
	"u_farZ":				{'type': 'float', 'data': [1000]},
	"u_shadowLightFarZ":	{'type': 'float', 'data': [1000]},
	"u_cameraFTR":			{'type': 'vec3', 'data':[0.0, 0.0, 0.0]}
};
